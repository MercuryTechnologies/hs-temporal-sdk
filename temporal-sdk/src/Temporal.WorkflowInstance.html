<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html"><span class="hs-identifier">Temporal.WorkflowInstance</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-6"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier">WorkflowInstance</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Types.html#Info"><span class="hs-identifier">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>  </span><span class="annot"><a href="Temporal.WorkflowInstance.html#create"><span class="hs-identifier">create</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="annot"><a href="Temporal.WorkflowInstance.html#activate"><span class="hs-identifier">activate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#addCommand"><span class="hs-identifier">addCommand</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextActivitySequence"><span class="hs-identifier">nextActivitySequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextChildWorkflowSequence"><span class="hs-identifier">nextChildWorkflowSequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextExternalCancelSequence"><span class="hs-identifier">nextExternalCancelSequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextExternalSignalSequence"><span class="hs-identifier">nextExternalSignalSequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextTimerSequence"><span class="hs-identifier">nextTimerSequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#nextConditionSequence"><span class="hs-identifier">nextConditionSequence</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="Temporal.WorkflowInstance.html#addStackTraceHandler"><span class="hs-identifier">addStackTraceHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Logger</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ProtoLens</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Set</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock.System</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SystemTime</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Vector</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Stack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">emptyCallStack</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Family2</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Api.Failure.V1.Message_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Api.Failure.V1.Message_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Failure</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.ChildWorkflow.ChildWorkflow</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="hs-identifier">StartChildWorkflowExecutionFailedCause</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowActivation.WorkflowActivation</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><span class="hs-identifier">CancelWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="hs-identifier">FireTimer</span></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="hs-identifier">NotifyHasPatch</span></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="hs-identifier">QueryWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveActivity</span></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveChildWorkflowExecution</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveChildWorkflowExecutionStart</span></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveChildWorkflowExecutionStart'Status</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveRequestCancelExternalWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><span class="hs-identifier">ResolveSignalExternalWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="hs-identifier">SignalWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><span class="hs-identifier">StartWorkflow</span></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><span class="hs-identifier">UpdateRandomSeed</span></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><span class="hs-identifier">WorkflowActivation</span></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>  </span><span class="annot"><span class="hs-identifier">WorkflowActivationJob</span></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="hs-identifier">WorkflowActivationJob'Variant</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowActivation.WorkflowActivation_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Activation</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCommands.WorkflowCommands</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Command</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCommands.WorkflowCommands_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Command</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCompletion.WorkflowCompletion</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Completion</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCompletion.WorkflowCompletion_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Completion</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mkStdGen</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Common.html"><span class="hs-identifier">Temporal.Common</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Temporal.Core.Worker</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Coroutine.html"><span class="hs-identifier">Temporal.Coroutine</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Duration.html"><span class="hs-identifier">Temporal.Duration</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Exception.html"><span class="hs-identifier">Temporal.Exception</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Temporal.Exception.html"><span class="hs-identifier">Temporal.Exception</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Err</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Payload.html"><span class="hs-identifier">Temporal.Payload</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.SearchAttributes.Internal.html"><span class="hs-identifier">Temporal.SearchAttributes.Internal</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Eval.html"><span class="hs-identifier">Temporal.Workflow.Eval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier">SuspendableWorkflowExecution</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Eval.html#injectWorkflowSignal"><span class="hs-identifier">injectWorkflowSignal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Eval.html#runWorkflow"><span class="hs-identifier">runWorkflow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html"><span class="hs-identifier">Temporal.Workflow.Internal.Instance</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html"><span class="hs-identifier">Temporal.Workflow.Internal.Monad</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Types.html"><span class="hs-identifier">Temporal.Workflow.Types</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span id="local-6989586621680176220"><span class="annot"><a href="Temporal.WorkflowInstance.html#create"><span class="hs-identifier hs-type">create</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLoggerIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680176220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Core.WorkflowActivationCompletion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.WorkerError</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#Workflow"><span class="hs-identifier hs-type">Workflow</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ deadlock timeout in seconds</span></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Exception.html#ApplicationFailureHandler"><span class="hs-identifier hs-type">ApplicationFailureHandler</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInboundInterceptor"><span class="hs-identifier hs-type">WorkflowInboundInterceptor</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowOutboundInterceptor"><span class="hs-identifier hs-type">WorkflowOutboundInterceptor</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Payload.html#PayloadProcessor"><span class="hs-identifier hs-type">PayloadProcessor</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Types.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StartWorkflow</span></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680176220"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span></span><span>
</span><span id="line-95"></span><span id="create"><span class="annot"><span class="annottext">create :: forall (m :: * -&gt; *).
(?callStack::CallStack, MonadLoggerIO m) =&gt;
(WorkflowActivationCompletion -&gt; IO (Either WorkerError ()))
-&gt; (Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; Maybe Int
-&gt; [ApplicationFailureHandler]
-&gt; WorkflowInboundInterceptor
-&gt; WorkflowOutboundInterceptor
-&gt; PayloadProcessor
-&gt; Info
-&gt; StartWorkflow
-&gt; m WorkflowInstance
</span><a href="Temporal.WorkflowInstance.html#create"><span class="hs-identifier hs-var hs-var">create</span></a></span></span><span> </span><span id="local-6989586621680177167"><span class="annot"><span class="annottext">WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
</span><a href="#local-6989586621680177167"><span class="hs-identifier hs-var">workflowCompleteActivation</span></a></span></span><span> </span><span id="local-6989586621680177168"><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680177168"><span class="hs-identifier hs-var">workflowFn</span></a></span></span><span> </span><span id="local-6989586621680177169"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680177169"><span class="hs-identifier hs-var">workflowDeadlockTimeout</span></a></span></span><span> </span><span id="local-6989586621680177170"><span class="annot"><span class="annottext">[ApplicationFailureHandler]
</span><a href="#local-6989586621680177170"><span class="hs-identifier hs-var">errorConverters</span></a></span></span><span> </span><span id="local-6989586621680177171"><span class="annot"><span class="annottext">WorkflowInboundInterceptor
</span><a href="#local-6989586621680177171"><span class="hs-identifier hs-var">inboundInterceptor</span></a></span></span><span> </span><span id="local-6989586621680177172"><span class="annot"><span class="annottext">WorkflowOutboundInterceptor
</span><a href="#local-6989586621680177172"><span class="hs-identifier hs-var">outboundInterceptor</span></a></span></span><span> </span><span id="local-6989586621680177173"><span class="annot"><span class="annottext">PayloadProcessor
</span><a href="#local-6989586621680177173"><span class="hs-identifier hs-var">payloadProcessor</span></a></span></span><span> </span><span id="local-6989586621680177174"><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177174"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621680177175"><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680177175"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; m ()
(Text -&gt; m ()) -&gt; (Text -&gt; Text) -&gt; Text -&gt; m ()
forall a. a -&gt; a
forall msg. ToLogStr msg =&gt; Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logDebug</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Instantiating workflow instance&quot;</span></span><span>
</span><span id="line-97"></span><span>  </span><span id="local-6989586621680177183"><span class="annot"><a href="#local-6989586621680177183"><span class="hs-identifier hs-var">workflowInstanceLogger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Loc -&gt; Text -&gt; LogLevel -&gt; LogStr -&gt; IO ())
forall (m :: * -&gt; *).
MonadLoggerIO m =&gt;
m (Loc -&gt; Text -&gt; LogLevel -&gt; LogStr -&gt; IO ())
</span><span class="hs-identifier hs-var">askLoggerIO</span></span><span>
</span><span id="line-98"></span><span>  </span><span id="local-6989586621680177185"><span class="annot"><a href="#local-6989586621680177185"><span class="hs-identifier hs-var">workflowRandomnessSeed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowGenM"><span class="hs-identifier hs-type">WorkflowGenM</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">mkStdGen</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621680177189"><span class="annot"><a href="#local-6989586621680177189"><span class="hs-identifier hs-var">workflowNotifiedPatches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-100"></span><span>  </span><span id="local-6989586621680177190"><span class="annot"><a href="#local-6989586621680177190"><span class="hs-identifier hs-var">workflowMemoizedPatches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621680177191"><span class="annot"><a href="#local-6989586621680177191"><span class="hs-identifier hs-var">workflowSequences</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#Sequences"><span class="hs-identifier hs-type">Sequences</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#externalCancel"><span class="hs-identifier hs-var">externalCancel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-105"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#childWorkflow"><span class="hs-identifier hs-var">childWorkflow</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-106"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#externalSignal"><span class="hs-identifier hs-var">externalSignal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#timer"><span class="hs-identifier hs-var">timer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-108"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#activity"><span class="hs-identifier hs-var">activity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-109"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#condition"><span class="hs-identifier hs-var">condition</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#varId"><span class="hs-identifier hs-var">varId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">1</span></span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-112"></span><span>  </span><span id="local-6989586621680177200"><span class="annot"><a href="#local-6989586621680177200"><span class="hs-identifier hs-var">workflowTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MkSystemTime</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-113"></span><span>  </span><span id="local-6989586621680177202"><span class="annot"><a href="#local-6989586621680177202"><span class="hs-identifier hs-var">workflowIsReplaying</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-114"></span><span>  </span><span id="local-6989586621680177203"><span class="annot"><a href="#local-6989586621680177203"><span class="hs-identifier hs-var">workflowSequenceMaps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTVarIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#SequenceMaps"><span class="hs-identifier hs-type">SequenceMaps</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-115"></span><span>  </span><span id="local-6989586621680177206"><span class="annot"><a href="#local-6989586621680177206"><span class="hs-identifier hs-var">workflowCommands</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTVarIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#Reversed"><span class="hs-identifier hs-type">Reversed</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-116"></span><span>  </span><span id="local-6989586621680177208"><span class="annot"><a href="#local-6989586621680177208"><span class="hs-identifier hs-var">workflowSignalHandlers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621680177209"><span class="annot"><a href="#local-6989586621680177209"><span class="hs-identifier hs-var">workflowCallStack</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">emptyCallStack</span></span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621680177210"><span class="annot"><a href="#local-6989586621680177210"><span class="hs-identifier hs-var">workflowQueryHandlers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621680177211"><span class="annot"><a href="#local-6989586621680177211"><span class="hs-identifier hs-var">workflowInstanceInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680177174"><span class="hs-identifier hs-type">info</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621680177212"><span class="annot"><a href="#local-6989586621680177212"><span class="hs-identifier hs-var">workflowInstanceContinuationEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#ContinuationEnv"><span class="hs-identifier hs-type">ContinuationEnv</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#JobNil"><span class="hs-identifier hs-type">JobNil</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span id="local-6989586621680177215"><span class="annot"><a href="#local-6989586621680177215"><span class="hs-identifier hs-var">workflowCancellationVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#newIVar"><span class="hs-identifier hs-type">newIVar</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621680177217"><span class="annot"><a href="#local-6989586621680177217"><span class="hs-identifier hs-var">activationChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTQueueIO</span></span><span>
</span><span id="line-123"></span><span>  </span><span id="local-6989586621680177219"><span class="annot"><a href="#local-6989586621680177219"><span class="hs-identifier hs-var">executionThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">error</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Workflow thread not yet started&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-comment">-- The execution thread is funny because it needs access to the instance, but the instance</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-comment">-- needs access to the execution thread. It's a bit of a circular dependency, but</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-comment">-- pretty innocuous since writing to the executionThread var happens before anything else</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-comment">-- is allowed to interact with the instance.</span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177221"><span class="annot"><a href="#local-6989586621680177221"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">[ApplicationFailureHandler]
Maybe Int
TVar SequenceMaps
TVar (Reversed WorkflowCommand)
IORef Bool
IORef CallStack
IORef (HashMap (Maybe Text) (Vector Payload -&gt; Workflow ()))
IORef
  (HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload)))
IORef (HashMap PatchId Bool)
IORef (Set PatchId)
IORef (Async ())
IORef SystemTime
IORef Info
IORef Sequences
TQueue WorkflowActivation
PayloadProcessor
WorkflowOutboundInterceptor
WorkflowInboundInterceptor
IVar ()
WorkflowGenM
ContinuationEnv
Loc -&gt; Text -&gt; LogLevel -&gt; LogStr -&gt; IO ()
WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
workflowCompleteActivation :: WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
workflowDeadlockTimeout :: Maybe Int
errorConverters :: [ApplicationFailureHandler]
inboundInterceptor :: WorkflowInboundInterceptor
outboundInterceptor :: WorkflowOutboundInterceptor
payloadProcessor :: PayloadProcessor
workflowInstanceLogger :: Loc -&gt; Text -&gt; LogLevel -&gt; LogStr -&gt; IO ()
workflowRandomnessSeed :: WorkflowGenM
workflowNotifiedPatches :: IORef (Set PatchId)
workflowMemoizedPatches :: IORef (HashMap PatchId Bool)
workflowSequences :: IORef Sequences
workflowTime :: IORef SystemTime
workflowIsReplaying :: IORef Bool
workflowSequenceMaps :: TVar SequenceMaps
workflowCommands :: TVar (Reversed WorkflowCommand)
workflowSignalHandlers :: IORef (HashMap (Maybe Text) (Vector Payload -&gt; Workflow ()))
workflowCallStack :: IORef CallStack
workflowQueryHandlers :: IORef
  (HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload)))
workflowInstanceInfo :: IORef Info
workflowInstanceContinuationEnv :: ContinuationEnv
workflowCancellationVar :: IVar ()
activationChannel :: TQueue WorkflowActivation
executionThread :: IORef (Async ())
payloadProcessor :: PayloadProcessor
errorConverters :: [ApplicationFailureHandler]
outboundInterceptor :: WorkflowOutboundInterceptor
inboundInterceptor :: WorkflowInboundInterceptor
executionThread :: IORef (Async ())
activationChannel :: TQueue WorkflowActivation
workflowDeadlockTimeout :: Maybe Int
workflowCancellationVar :: IVar ()
workflowInstanceContinuationEnv :: ContinuationEnv
workflowCompleteActivation :: WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
workflowCallStack :: IORef CallStack
workflowQueryHandlers :: IORef
  (HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload)))
workflowSignalHandlers :: IORef (HashMap (Maybe Text) (Vector Payload -&gt; Workflow ()))
workflowSequenceMaps :: TVar SequenceMaps
workflowCommands :: TVar (Reversed WorkflowCommand)
workflowIsReplaying :: IORef Bool
workflowTime :: IORef SystemTime
workflowSequences :: IORef Sequences
workflowMemoizedPatches :: IORef (HashMap PatchId Bool)
workflowNotifiedPatches :: IORef (Set PatchId)
workflowRandomnessSeed :: WorkflowGenM
workflowInstanceLogger :: Loc -&gt; Text -&gt; LogLevel -&gt; LogStr -&gt; IO ()
workflowInstanceInfo :: IORef Info
</span><a href="#local-6989586621680177167"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621680177246"><span class="annot"><a href="#local-6989586621680177246"><span class="hs-identifier hs-var">workerThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">async</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#runInstanceM"><span class="hs-identifier hs-type">runInstanceM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177221"><span class="hs-identifier hs-type">inst</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">$</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Start workflow execution thread&quot;</span></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621680177250"><span class="annot"><a href="#local-6989586621680177250"><span class="hs-identifier hs-var">exec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#setUpWorkflowExecution"><span class="hs-identifier hs-type">setUpWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177175"><span class="hs-identifier hs-type">start</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621680177252"><span class="annot"><a href="#local-6989586621680177252"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier">inboundInterceptor</span></span><span class="hs-operator">.</span><span class="hs-identifier">executeWorkflow</span><span> </span><span class="annot"><a href="#local-6989586621680177250"><span class="hs-identifier hs-type">exec</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680177253"><span class="annot"><span class="annottext">ExecuteWorkflowInput
</span><a href="#local-6989586621680177253"><span class="hs-identifier hs-var">exec'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
-&gt; InstanceM (WorkflowExitVariant Payload)
-&gt; IO (WorkflowExitVariant Payload)
forall a. WorkflowInstance -&gt; InstanceM a -&gt; IO a
</span><a href="Temporal.Workflow.Internal.Instance.html#runInstanceM"><span class="hs-identifier hs-var">runInstanceM</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177221"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceM (WorkflowExitVariant Payload)
 -&gt; IO (WorkflowExitVariant Payload))
-&gt; InstanceM (WorkflowExitVariant Payload)
-&gt; IO (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InstanceM Payload -&gt; InstanceM (WorkflowExitVariant Payload)
</span><a href="Temporal.WorkflowInstance.html#runTopLevel"><span class="hs-identifier hs-var">runTopLevel</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceM Payload -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; InstanceM Payload -&gt; InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; InstanceM ()
(Text -&gt; InstanceM ()) -&gt; (Text -&gt; Text) -&gt; Text -&gt; InstanceM ()
forall a. a -&gt; a
forall msg.
ToLogStr msg =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; InstanceM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logDebug</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Executing workflow&quot;</span></span><span>
</span><span id="line-134"></span><span>      </span><span id="local-6989586621680177255"><span class="annot"><a href="#local-6989586621680177255"><span class="hs-identifier hs-var">wf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExecuteWorkflowInput
-&gt; (Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; InstanceM (SuspendableWorkflowExecution Payload)
</span><a href="Temporal.WorkflowInstance.html#applyStartWorkflow"><span class="hs-identifier hs-var">applyStartWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">ExecuteWorkflowInput
</span><a href="#local-6989586621680177253"><span class="hs-identifier hs-var">exec'</span></a></span><span> </span><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680177168"><span class="hs-identifier hs-var">workflowFn</span></a></span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><a href="Temporal.WorkflowInstance.html#runWorkflowToCompletion"><span class="hs-identifier hs-type">runWorkflowToCompletion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177255"><span class="hs-identifier hs-type">wf</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">$</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Workflow execution completed&quot;</span></span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#addCommand"><span class="hs-identifier hs-type">addCommand</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#convertExitVariantToCommand"><span class="hs-identifier hs-type">convertExitVariantToCommand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177252"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#flushCommands"><span class="hs-identifier hs-type">flushCommands</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">$</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Handling leftover queries&quot;</span></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><a href="Temporal.WorkflowInstance.html#handleQueriesAfterCompletion"><span class="hs-identifier hs-type">handleQueriesAfterCompletion</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-comment">-- If we have an exception crash the workflow thread, then we need to throw to the worker too,</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-comment">-- otherwise it will just hang forever.</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">link</span></span><span> </span><span class="annot"><a href="#local-6989586621680177246"><span class="hs-identifier hs-type">workerThread</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680177219"><span class="hs-identifier hs-type">executionThread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177246"><span class="hs-identifier hs-type">workerThread</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680177221"><span class="hs-identifier hs-type">inst</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#runWorkflowToCompletion"><span class="hs-identifier hs-type">runWorkflowToCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span>
</span><span id="line-150"></span><span id="runWorkflowToCompletion"><span class="annot"><span class="annottext">runWorkflowToCompletion :: (?callStack::CallStack) =&gt;
SuspendableWorkflowExecution Payload -&gt; InstanceM Payload
</span><a href="Temporal.WorkflowInstance.html#runWorkflowToCompletion"><span class="hs-identifier hs-var hs-var">runWorkflowToCompletion</span></a></span></span><span> </span><span id="local-6989586621680177288"><span class="annot"><span class="annottext">SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177288"><span class="hs-identifier hs-var">wf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621680177289"><span class="annot"><a href="#local-6989586621680177289"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680177291"><span class="hs-identifier hs-type">completeStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Coroutine.html#Await"><span class="hs-identifier hs-type">Await</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>      </span><span id="local-6989586621680177291"><span class="annot"><a href="#local-6989586621680177291"><span class="hs-identifier hs-var hs-var">completeStep</span></a></span></span><span> </span><span id="local-6989586621680177292"><span class="annot"><span class="annottext">Await [ActivationResult] (SuspendableWorkflowExecution Payload)
</span><a href="#local-6989586621680177292"><span class="hs-identifier hs-var">suspension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; InstanceM ()
(Text -&gt; InstanceM ()) -&gt; (Text -&gt; Text) -&gt; Text -&gt; InstanceM ()
forall a. a -&gt; a
forall msg.
ToLogStr msg =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; InstanceM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logDebug</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Awaiting activation results from workflow&quot;</span></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">-- If the workflow is blocked, then we necessarily have to signal the temporal-core</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-comment">-- that we are stuck. Once we get unstuck (e.g. something is in the activation channel)</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-comment">-- then we can resume the workflow.</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-comment">-- There are a few cases like singalWithStart where a workflow will reach a blocking</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-comment">-- state, but we aren't actually ready to flush the commands yet. So, we read</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">-- from the activation channel and resume the workflow until the channel is emptied.</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">-- Once we're blocked in that way, then we should flush the commands and wait for</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-comment">-- the next activation(s?).</span><span>
</span><span id="line-165"></span><span>        </span><span id="local-6989586621680177293"><span class="annot"><a href="#local-6989586621680177293"><span class="hs-identifier hs-var">activation</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM (InstanceM WorkflowActivation)
-&gt; InstanceM WorkflowActivation
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM (InstanceM WorkflowActivation)
 -&gt; InstanceM WorkflowActivation)
-&gt; InstanceM (InstanceM WorkflowActivation)
-&gt; InstanceM WorkflowActivation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM (InstanceM WorkflowActivation)
-&gt; InstanceM (InstanceM WorkflowActivation)
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (InstanceM WorkflowActivation)
 -&gt; InstanceM (InstanceM WorkflowActivation))
-&gt; STM (InstanceM WorkflowActivation)
-&gt; InstanceM (InstanceM WorkflowActivation)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>          </span><span id="local-6989586621680177295"><span class="annot"><a href="#local-6989586621680177295"><span class="hs-identifier hs-var">mActivition</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue WorkflowActivation -&gt; STM (Maybe WorkflowActivation)
forall a. TQueue a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryReadTQueue</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177289"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">activationChannel</span><span>
</span><span id="line-167"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177295"><span class="hs-identifier hs-type">mActivition</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-168"></span><span>            </span><span class="annot"><span class="annottext">Maybe WorkflowActivation
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>              </span><span class="annot"><span class="annottext">InstanceM WorkflowActivation -&gt; STM (InstanceM WorkflowActivation)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM WorkflowActivation
 -&gt; STM (InstanceM WorkflowActivation))
-&gt; InstanceM WorkflowActivation
-&gt; STM (InstanceM WorkflowActivation)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>                </span><span class="annot"><span class="annottext">InstanceM ()
(?callStack::CallStack) =&gt; InstanceM ()
</span><a href="Temporal.Workflow.Internal.Instance.html#flushCommands"><span class="hs-identifier hs-var">flushCommands</span></a></span><span>
</span><span id="line-171"></span><span>                </span><span class="annot"><span class="annottext">STM WorkflowActivation -&gt; InstanceM WorkflowActivation
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM WorkflowActivation -&gt; InstanceM WorkflowActivation)
-&gt; STM WorkflowActivation -&gt; InstanceM WorkflowActivation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue WorkflowActivation -&gt; STM WorkflowActivation
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177289"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">activationChannel</span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177298"><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177298"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowActivation -&gt; STM (InstanceM WorkflowActivation)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM WorkflowActivation
 -&gt; STM (InstanceM WorkflowActivation))
-&gt; InstanceM WorkflowActivation
-&gt; STM (InstanceM WorkflowActivation)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation -&gt; InstanceM WorkflowActivation
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177298"><span class="hs-identifier hs-var">act</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#activate"><span class="hs-identifier hs-type">activate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177293"><span class="hs-identifier hs-type">activation</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="annot"><a href="#local-6989586621680177292"><span class="hs-identifier hs-type">suspension</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><a href="Temporal.Coroutine.html#supplyM"><span class="hs-identifier hs-type">supplyM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177291"><span class="hs-identifier hs-type">completeStep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177288"><span class="hs-identifier hs-type">wf</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="annot"><span class="hs-comment">{- | This runs indefinitely, handling queries that come in after the workflow has completed.

Termination occurs when we receive an eviction signal from Temporal. At that point,
the thread has 'cancel' called on it, which breaks us out of the loop.

TODO perhaps we need to ensure that any any completed queries have added their commands
to the command queue before we exit this loop?
-}</span></span><span>
</span><span id="line-185"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#handleQueriesAfterCompletion"><span class="hs-identifier hs-type">handleQueriesAfterCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span id="handleQueriesAfterCompletion"><span class="annot"><span class="annottext">handleQueriesAfterCompletion :: InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#handleQueriesAfterCompletion"><span class="hs-identifier hs-var hs-var">handleQueriesAfterCompletion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstanceM () -&gt; InstanceM ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM () -&gt; InstanceM ()) -&gt; InstanceM () -&gt; InstanceM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>  </span><span id="local-6989586621680177304"><span class="annot"><a href="#local-6989586621680177304"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-188"></span><span>  </span><span id="local-6989586621680177305"><span class="annot"><a href="#local-6989586621680177305"><span class="hs-identifier hs-var">activation</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTQueue</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">asks</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#activationChannel"><span class="hs-identifier hs-var">activationChannel</span></a></span><span>
</span><span id="line-189"></span><span>  </span><span id="local-6989586621680177307"><span class="annot"><a href="#local-6989586621680177307"><span class="hs-identifier hs-var">completion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UnliftIO.try</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#activate"><span class="hs-identifier hs-type">activate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177305"><span class="hs-identifier hs-type">activation</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177307"><span class="hs-identifier hs-type">completion</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680177310"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177310"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Workflow failure: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177310"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177312"><span class="annot"><span class="annottext">appFailure :: ApplicationFailure
</span><a href="#local-6989586621680177312"><span class="hs-identifier hs-var hs-var hs-var">appFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; [ApplicationFailureHandler] -&gt; ApplicationFailure
</span><a href="Temporal.Exception.html#mkApplicationFailure"><span class="hs-identifier hs-var">mkApplicationFailure</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177310"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177304"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">errorConverters</span><span>
</span><span id="line-195"></span><span>          </span><span id="local-6989586621680177314"><span class="annot"><span class="annottext">enrichedApplicationFailure :: Failure
</span><a href="#local-6989586621680177314"><span class="hs-identifier hs-var hs-var hs-var">enrichedApplicationFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Failure
</span><a href="Temporal.Exception.html#applicationFailureToFailureProto"><span class="hs-identifier hs-var">applicationFailureToFailureProto</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680177312"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>          </span><span class="annot"><a href="#local-6989586621680177316"><span class="hs-identifier hs-type">failureProto</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Completion.Failure</span></span><span>
</span><span id="line-198"></span><span>          </span><span id="local-6989586621680177316"><span class="annot"><span class="annottext">failureProto :: Failure
</span><a href="#local-6989586621680177316"><span class="hs-identifier hs-var hs-var hs-var">failureProto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Failure
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failure&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failure</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure)
-&gt; Failure -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680177314"><span class="hs-identifier hs-var">enrichedApplicationFailure</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>          </span><span id="local-6989586621680177329"><span class="annot"><span class="annottext">completionMessage :: WorkflowActivationCompletion
</span><a href="#local-6989586621680177329"><span class="hs-identifier hs-var hs-var hs-var">completionMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>            </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-202"></span><span>              </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.runId</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Text)
-&gt; Text
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177305"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>              </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failed&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failed</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Failure)
-&gt; Failure
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680177316"><span class="hs-identifier hs-var">failureProto</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span id="local-6989586621680177346"><span class="annot"><a href="#local-6989586621680177346"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowCompleteActivation</span><span> </span><span class="annot"><a href="#local-6989586621680177329"><span class="hs-identifier hs-type">completionMessage</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">throwIO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">Proxy (SuspendableWorkflowExecution Payload)
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-comment">-- At this point, the workflow isn't running, so we can always flush the commands.</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><a href="Temporal.Workflow.Internal.Instance.html#flushCommands"><span class="hs-identifier hs-type">flushCommands</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><span class="hs-comment">{- | This is a special query handler that is added to every workflow instance.

It allows the Temporal UI to query the current call stack to see what is currently happening
in the workflow.
-}</span></span><span>
</span><span id="line-216"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#addStackTraceHandler"><span class="hs-identifier hs-type">addStackTraceHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span id="addStackTraceHandler"><span class="annot"><span class="annottext">addStackTraceHandler :: WorkflowInstance -&gt; IO ()
</span><a href="Temporal.WorkflowInstance.html#addStackTraceHandler"><span class="hs-identifier hs-var hs-var">addStackTraceHandler</span></a></span></span><span> </span><span id="local-6989586621680177349"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177349"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177350"><span class="annot"><span class="annottext">specialHandler :: QueryId
-&gt; Vector Payload
-&gt; Map Text Payload
-&gt; IO (Either SomeException Payload)
</span><a href="#local-6989586621680177350"><span class="hs-identifier hs-var hs-var">specialHandler</span></a></span></span><span> </span><span class="annot"><span class="annottext">QueryId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Vector Payload
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Map Text Payload
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>        </span><span id="local-6989586621680177351"><span class="annot"><a href="#local-6989586621680177351"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef CallStack -&gt; IO CallStack
forall (m :: * -&gt; *) a. MonadIO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177349"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowCallStack</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#encode"><span class="hs-identifier hs-type">Temporal.Payload.encode</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#JSON"><span class="hs-identifier hs-type">JSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text.pack</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.Exception.html#prettyCallStack"><span class="hs-identifier hs-type">Temporal.Exception.prettyCallStack</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177351"><span class="hs-identifier hs-type">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><span class="annottext">IORef
  (HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload)))
-&gt; (HashMap
      (Maybe Text)
      (QueryId
       -&gt; Vector Payload
       -&gt; Map Text Payload
       -&gt; IO (Either SomeException Payload))
    -&gt; HashMap
         (Maybe Text)
         (QueryId
          -&gt; Vector Payload
          -&gt; Map Text Payload
          -&gt; IO (Either SomeException Payload)))
-&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IORef a -&gt; (a -&gt; a) -&gt; m ()
</span><span class="hs-identifier hs-var">modifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177349"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowQueryHandlers</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text
-&gt; (QueryId
    -&gt; Vector Payload
    -&gt; Map Text Payload
    -&gt; IO (Either SomeException Payload))
-&gt; HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
-&gt; HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;__stack_trace&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">QueryId
-&gt; Vector Payload
-&gt; Map Text Payload
-&gt; IO (Either SomeException Payload)
</span><a href="#local-6989586621680177350"><span class="hs-identifier hs-var">specialHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- This should never raise an exception, but instead catch all exceptions</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- and set as completion failure.</span><span>
</span><span id="line-226"></span><span id="local-6989586621680176300"><span class="annot"><a href="Temporal.WorkflowInstance.html#activate"><span class="hs-identifier hs-type">activate</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621680176300"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivation</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680176300"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Coroutine.html#Await"><span class="hs-identifier hs-type">Await</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680176300"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-231"></span><span id="activate"><span class="annot"><span class="annottext">activate :: forall (f :: * -&gt; *).
Functor f =&gt;
WorkflowActivation
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM (f (SuspendableWorkflowExecution Payload))
</span><a href="Temporal.WorkflowInstance.html#activate"><span class="hs-identifier hs-var hs-var">activate</span></a></span></span><span> </span><span id="local-6989586621680177415"><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177415"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span id="local-6989586621680177416"><span class="annot"><span class="annottext">f (Await [ActivationResult] (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177416"><span class="hs-identifier hs-var">suspension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>  </span><span id="local-6989586621680177417"><span class="annot"><a href="#local-6989586621680177417"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621680177418"><span class="annot"><a href="#local-6989586621680177418"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowInstanceInfo</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680177420"><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177420"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177421"><span class="annot"><span class="annottext">info' :: Info
</span><a href="#local-6989586621680177421"><span class="hs-identifier hs-var hs-var">info'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-235"></span><span>          </span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177420"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-236"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Types.html#historyLength"><span class="hs-identifier hs-var">historyLength</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680177415"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.historyLength</span></span><span>
</span><span id="line-237"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Types.html#continueAsNewSuggested"><span class="hs-identifier hs-var">continueAsNewSuggested</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680177415"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.continueAsNewSuggested</span></span><span>
</span><span id="line-238"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177421"><span class="hs-identifier hs-var">info'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177421"><span class="hs-identifier hs-var">info'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177426"><span class="annot"><a href="#local-6989586621680177426"><span class="hs-identifier hs-var hs-var">completionBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.runId</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Text)
-&gt; Text
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">RunId -&gt; Text
</span><a href="Temporal.Common.html#rawRunId"><span class="hs-identifier hs-var">rawRunId</span></a></span><span> </span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680177418"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">runId</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowTime</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177415"><span class="hs-identifier hs-type">act</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.timestamp</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#timespecFromTimestamp"><span class="hs-identifier hs-type">timespecFromTimestamp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621680177436"><span class="annot"><a href="#local-6989586621680177436"><span class="hs-identifier hs-var">eResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowDeadlockTimeout</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall (f :: * -&gt; *).
Functor f =&gt;
Vector WorkflowActivationJob
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
</span><a href="Temporal.WorkflowInstance.html#applyJobs"><span class="hs-identifier hs-var">applyJobs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177415"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     (Vector WorkflowActivationJob)
     WorkflowActivation
     WorkflowActivation
     (Vector WorkflowActivationJob)
     (Vector WorkflowActivationJob)
-&gt; Vector WorkflowActivationJob
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector WorkflowActivationJob)
  WorkflowActivation
  WorkflowActivation
  (Vector WorkflowActivationJob)
  (Vector WorkflowActivationJob)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.vec'jobs</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (Await [ActivationResult] (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177416"><span class="hs-identifier hs-var">suspension</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177439"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680177439"><span class="hs-identifier hs-var">timeoutDuration</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621680177440"><span class="annot"><a href="#local-6989586621680177440"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
-&gt; InstanceM
     (Maybe
        (Either SomeException (f (SuspendableWorkflowExecution Payload))))
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
Int -&gt; m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">UnliftIO.timeout</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680177439"><span class="hs-identifier hs-var">timeoutDuration</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceM
   (Either SomeException (f (SuspendableWorkflowExecution Payload)))
 -&gt; InstanceM
      (Maybe
         (Either SomeException (f (SuspendableWorkflowExecution Payload)))))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
-&gt; InstanceM
     (Maybe
        (Either SomeException (f (SuspendableWorkflowExecution Payload))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall (f :: * -&gt; *).
Functor f =&gt;
Vector WorkflowActivationJob
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
</span><a href="Temporal.WorkflowInstance.html#applyJobs"><span class="hs-identifier hs-var">applyJobs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680177415"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     (Vector WorkflowActivationJob)
     WorkflowActivation
     WorkflowActivation
     (Vector WorkflowActivationJob)
     (Vector WorkflowActivationJob)
-&gt; Vector WorkflowActivationJob
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector WorkflowActivationJob)
  WorkflowActivation
  WorkflowActivation
  (Vector WorkflowActivationJob)
  (Vector WorkflowActivationJob)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.vec'jobs</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (Await [ActivationResult] (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177416"><span class="hs-identifier hs-var">suspension</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177440"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="annottext">Maybe
  (Either SomeException (f (SuspendableWorkflowExecution Payload)))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>          </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Deadlock detected&quot;</span></span><span>
</span><span id="line-249"></span><span>          </span><span class="annot"><span class="annottext">Either SomeException (f (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (f (SuspendableWorkflowExecution Payload))
 -&gt; InstanceM
      (Either SomeException (f (SuspendableWorkflowExecution Payload))))
-&gt; Either SomeException (f (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException
-&gt; Either SomeException (f (SuspendableWorkflowExecution Payload))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(SomeException
 -&gt; Either SomeException (f (SuspendableWorkflowExecution Payload)))
-&gt; SomeException
-&gt; Either SomeException (f (SuspendableWorkflowExecution Payload))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogicBug -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">(LogicBug -&gt; SomeException) -&gt; LogicBug -&gt; SomeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogicBugType -&gt; LogicBug
</span><a href="Temporal.Exception.html#LogicBug"><span class="hs-identifier hs-var">LogicBug</span></a></span><span> </span><span class="annot"><span class="annottext">LogicBugType
</span><a href="Temporal.Exception.html#WorkflowActivationDeadlock"><span class="hs-identifier hs-var">WorkflowActivationDeadlock</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177447"><span class="annot"><span class="annottext">Either SomeException (f (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177447"><span class="hs-identifier hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (f (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Either SomeException (f (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177447"><span class="hs-identifier hs-var">res'</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-comment">-- TODO: Can the completion send both successful commands and a failure</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-comment">-- message at the same time? In theory we can make partial progress on</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-comment">-- a workflow, but still fail at some point?</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177436"><span class="hs-identifier hs-type">eResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680177448"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177448"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logWarn</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Failed activation on workflow&quot;</span></span><span> </span><span class="hs-comment">-- &lt;&gt; toLogStr (show $ workflowType info) &lt;&gt; &quot; with ID &quot; &lt;&gt; toLogStr (workflowId info) &lt;&gt; &quot; and run ID &quot; &lt;&gt; toLogStr (runId info))</span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-comment">-- TODO, failures should have source / stack trace info</span><span>
</span><span id="line-258"></span><span>      </span><span class="hs-comment">-- TODO, convert failure type using a supplied payload converter</span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177451"><span class="annot"><span class="annottext">failure :: Failure
</span><a href="#local-6989586621680177451"><span class="hs-identifier hs-var hs-var hs-var">failure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>            </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-261"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Failure
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failure&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failure</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure)
-&gt; Failure -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Failure.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177448"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>          </span><span id="local-6989586621680177464"><span class="annot"><span class="annottext">completion :: WorkflowActivationCompletion
</span><a href="#local-6989586621680177464"><span class="hs-identifier hs-var hs-var hs-var">completion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680177426"><span class="hs-identifier hs-var">completionBase</span></a></span><span>
</span><span id="line-264"></span><span>              </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failed&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failed</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Failure)
-&gt; Failure
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680177451"><span class="hs-identifier hs-var">failure</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; InstanceM ()
forall a. IO a -&gt; InstanceM a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177417"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowCompleteActivation</span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680177464"><span class="hs-identifier hs-var">completion</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either WorkerError ())
-&gt; (Either WorkerError () -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(WorkerError -&gt; IO ())
-&gt; (() -&gt; IO ()) -&gt; Either WorkerError () -&gt; IO ()
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">WorkerError -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-comment">-- I think it's morally okay to crash the worker thread here.</span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="annottext">SomeException
-&gt; InstanceM (f (SuspendableWorkflowExecution Payload))
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177448"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680177470"><span class="annot"><span class="annottext">f (SuspendableWorkflowExecution Payload)
</span><a href="#local-6989586621680177470"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">f (SuspendableWorkflowExecution Payload)
-&gt; InstanceM (f (SuspendableWorkflowExecution Payload))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">f (SuspendableWorkflowExecution Payload)
</span><a href="#local-6989586621680177470"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="annot"><span class="hs-comment">-- | This gives us the basic state for a workflow instance prior to initial evaluation.</span></span><span>
</span><span id="line-272"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#setUpWorkflowExecution"><span class="hs-identifier hs-type">setUpWorkflowExecution</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StartWorkflow</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#ExecuteWorkflowInput"><span class="hs-identifier hs-type">ExecuteWorkflowInput</span></a></span><span>
</span><span id="line-273"></span><span id="setUpWorkflowExecution"><span class="annot"><span class="annottext">setUpWorkflowExecution :: StartWorkflow -&gt; InstanceM ExecuteWorkflowInput
</span><a href="Temporal.WorkflowInstance.html#setUpWorkflowExecution"><span class="hs-identifier hs-var hs-var">setUpWorkflowExecution</span></a></span></span><span> </span><span id="local-6989586621680177471"><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680177471"><span class="hs-identifier hs-var">startWorkflow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>  </span><span id="local-6989586621680177472"><span class="annot"><a href="#local-6989586621680177472"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowGenM"><span class="hs-identifier hs-type">WorkflowGenM</span></a></span><span> </span><span id="local-6989586621680177473"><span class="annot"><a href="#local-6989586621680177473"><span class="hs-identifier hs-var">genRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowRandomnessSeed</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680177473"><span class="hs-identifier hs-type">genRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">mkStdGen</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fromIntegral</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680177471"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.randomnessSeed</span></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowTime</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177471"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.startTime</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#timespecFromTimestamp"><span class="hs-identifier hs-type">timespecFromTimestamp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621680177476"><span class="annot"><a href="#local-6989586621680177476"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowInstanceInfo</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#ExecuteWorkflowInput"><span class="hs-identifier hs-type">ExecuteWorkflowInput</span></a></span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#executeWorkflowInputType"><span class="hs-identifier hs-var">executeWorkflowInputType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680177471"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.workflowType</span></span><span>
</span><span id="line-283"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#executeWorkflowInputArgs"><span class="hs-identifier hs-var">executeWorkflowInputArgs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177471"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.vec'arguments</span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#executeWorkflowInputHeaders"><span class="hs-identifier hs-var">executeWorkflowInputHeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177471"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.headers</span></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#executeWorkflowInputInfo"><span class="hs-identifier hs-var">executeWorkflowInputInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680177476"><span class="hs-identifier hs-type">info</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyStartWorkflow"><span class="hs-identifier hs-type">applyStartWorkflow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#ExecuteWorkflowInput"><span class="hs-identifier hs-type">ExecuteWorkflowInput</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#Workflow"><span class="hs-identifier hs-type">Workflow</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span id="applyStartWorkflow"><span class="annot"><span class="annottext">applyStartWorkflow :: ExecuteWorkflowInput
-&gt; (Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; InstanceM (SuspendableWorkflowExecution Payload)
</span><a href="Temporal.WorkflowInstance.html#applyStartWorkflow"><span class="hs-identifier hs-var hs-var">applyStartWorkflow</span></a></span></span><span> </span><span id="local-6989586621680177486"><span class="annot"><span class="annottext">ExecuteWorkflowInput
</span><a href="#local-6989586621680177486"><span class="hs-identifier hs-var">execInput</span></a></span></span><span> </span><span id="local-6989586621680177487"><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680177487"><span class="hs-identifier hs-var">workflowFn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621680177488"><span class="annot"><a href="#local-6989586621680177488"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177489"><span class="annot"><a href="#local-6989586621680177489"><span class="hs-identifier hs-var hs-var">executeWorkflowBase</span></a></span></span><span> </span><span id="local-6989586621680177490"><span class="annot"><span class="annottext">ExecuteWorkflowInput
</span><a href="#local-6989586621680177490"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
-&gt; InstanceM (SuspendableWorkflowExecution Payload)
-&gt; IO (SuspendableWorkflowExecution Payload)
forall a. WorkflowInstance -&gt; InstanceM a -&gt; IO a
</span><a href="Temporal.Workflow.Internal.Instance.html#runInstanceM"><span class="hs-identifier hs-var">runInstanceM</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177488"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceM (SuspendableWorkflowExecution Payload)
 -&gt; IO (SuspendableWorkflowExecution Payload))
-&gt; InstanceM (SuspendableWorkflowExecution Payload)
-&gt; IO (SuspendableWorkflowExecution Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621680177491"><span class="annot"><a href="#local-6989586621680177491"><span class="hs-identifier hs-var">eAct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either String (Workflow Payload))
-&gt; InstanceM (Either String (Workflow Payload))
forall a. IO a -&gt; InstanceM a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680177487"><span class="hs-identifier hs-var">workflowFn</span></a></span><span> </span><span class="annot"><span class="annottext">(Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; IO (Vector Payload) -&gt; IO (Either String (Workflow Payload))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor -&gt; Vector Payload -&gt; IO (Vector Payload)
forall (m :: * -&gt; *) (f :: * -&gt; *).
(MonadIO m, Traversable f) =&gt;
PayloadProcessor -&gt; f Payload -&gt; m (f Payload)
</span><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-var">processorDecodePayloads</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177488"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">payloadProcessor</span><span> </span><span class="annot"><span class="annottext">ExecuteWorkflowInput
</span><a href="#local-6989586621680177490"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">executeWorkflowInputArgs</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177491"><span class="hs-identifier hs-type">eAct</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-295"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680177493"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680177493"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>            </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; InstanceM ()) -&gt; Text -&gt; InstanceM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Failed to decode workflow arguments: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680177493"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>            </span><span class="annot"><span class="annottext">ValueError -&gt; InstanceM (SuspendableWorkflowExecution Payload)
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ValueError
</span><a href="Temporal.Payload.html#ValueError"><span class="hs-identifier hs-var">ValueError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680177493"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680177495"><span class="annot"><span class="annottext">Workflow Payload
</span><a href="#local-6989586621680177495"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>            </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Calling runWorkflow&quot;</span></span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">SuspendableWorkflowExecution Payload
-&gt; InstanceM (SuspendableWorkflowExecution Payload)
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RequireCallStackImpl =&gt; Workflow Payload)
-&gt; SuspendableWorkflowExecution Payload
forall a.
(?callStack::CallStack) =&gt;
(RequireCallStackImpl =&gt; Workflow a)
-&gt; SuspendableWorkflowExecution a
</span><a href="Temporal.Workflow.Eval.html#runWorkflow"><span class="hs-identifier hs-var">runWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">Workflow Payload
RequireCallStackImpl =&gt; Workflow Payload
</span><a href="#local-6989586621680177495"><span class="hs-identifier hs-var">act</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680177489"><span class="hs-identifier hs-type">executeWorkflowBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177486"><span class="hs-identifier hs-type">execInput</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyUpdateRandomSeed"><span class="hs-identifier hs-type">applyUpdateRandomSeed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UpdateRandomSeed</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span id="applyUpdateRandomSeed"><span class="annot"><span class="annottext">applyUpdateRandomSeed :: UpdateRandomSeed -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyUpdateRandomSeed"><span class="hs-identifier hs-var hs-var">applyUpdateRandomSeed</span></a></span></span><span> </span><span id="local-6989586621680177498"><span class="annot"><span class="annottext">UpdateRandomSeed
</span><a href="#local-6989586621680177498"><span class="hs-identifier hs-var">updateRandomSeed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>  </span><span id="local-6989586621680177499"><span class="annot"><a href="#local-6989586621680177499"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-308"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowGenM"><span class="hs-identifier hs-type">WorkflowGenM</span></a></span><span> </span><span id="local-6989586621680177500"><span class="annot"><a href="#local-6989586621680177500"><span class="hs-identifier hs-var">genRef</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowRandomnessSeed</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">writeIORef</span></span><span> </span><span class="annot"><a href="#local-6989586621680177500"><span class="hs-identifier hs-type">genRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">mkStdGen</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fromIntegral</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680177498"><span class="hs-identifier hs-type">updateRandomSeed</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.randomnessSeed</span></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyQueryWorkflow"><span class="hs-identifier hs-type">applyQueryWorkflow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">QueryWorkflow</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span id="applyQueryWorkflow"><span class="annot"><span class="annottext">applyQueryWorkflow :: (?callStack::CallStack) =&gt; QueryWorkflow -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyQueryWorkflow"><span class="hs-identifier hs-var hs-var">applyQueryWorkflow</span></a></span></span><span> </span><span id="local-6989586621680177569"><span class="annot"><span class="annottext">QueryWorkflow
</span><a href="#local-6989586621680177569"><span class="hs-identifier hs-var">queryWorkflow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-314"></span><span>  </span><span id="local-6989586621680177570"><span class="annot"><a href="#local-6989586621680177570"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-315"></span><span>  </span><span id="local-6989586621680177571"><span class="annot"><a href="#local-6989586621680177571"><span class="hs-identifier hs-var">handles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowQueryHandlers</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-special">$</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;Applying query: &quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177569"><span class="hs-identifier hs-type">queryWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.queryType</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177573"><span class="annot"><a href="#local-6989586621680177573"><span class="hs-identifier hs-var hs-var">processor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177570"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">payloadProcessor</span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621680177574"><span class="annot"><a href="#local-6989586621680177574"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-type">processorDecodePayloads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177573"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177569"><span class="hs-identifier hs-type">queryWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.vec'arguments</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621680177575"><span class="annot"><a href="#local-6989586621680177575"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-type">processorDecodePayloads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177573"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177569"><span class="hs-identifier hs-type">queryWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.headers</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177576"><span class="annot"><a href="#local-6989586621680177576"><span class="hs-identifier hs-var hs-var">baseInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#HandleQueryInput"><span class="hs-identifier hs-type">HandleQueryInput</span></a></span><span>
</span><span id="line-322"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">handleQueryId :: Text
</span><a href="#local-6989586621680177578"><span class="hs-identifier hs-var">handleQueryId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryWorkflow
</span><a href="#local-6989586621680177569"><span class="hs-identifier hs-var">queryWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">QueryWorkflow
-&gt; FoldLike Text QueryWorkflow QueryWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text QueryWorkflow QueryWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;queryId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.queryId</span></span><span>
</span><span id="line-323"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">handleQueryInputType :: Text
</span><a href="#local-6989586621680177580"><span class="hs-identifier hs-var">handleQueryInputType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryWorkflow
</span><a href="#local-6989586621680177569"><span class="hs-identifier hs-var">queryWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">QueryWorkflow
-&gt; FoldLike Text QueryWorkflow QueryWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text QueryWorkflow QueryWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;queryType&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.queryType</span></span><span>
</span><span id="line-324"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">handleQueryInputArgs :: Vector Payload
</span><a href="#local-6989586621680177581"><span class="hs-identifier hs-var">handleQueryInputArgs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector Payload
</span><a href="#local-6989586621680177574"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-325"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">handleQueryInputHeaders :: Map Text Payload
</span><a href="#local-6989586621680177582"><span class="hs-identifier hs-var">handleQueryInputHeaders</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Text Payload
</span><a href="#local-6989586621680177575"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-326"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-327"></span><span>  </span><span id="local-6989586621680177583"><span class="annot"><a href="#local-6989586621680177583"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">inboundInterceptor</span><span class="hs-operator">.</span><span class="hs-identifier">handleQuery</span><span> </span><span class="annot"><a href="#local-6989586621680177576"><span class="hs-identifier hs-type">baseInput</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680177584"><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177585"><span class="annot"><span class="annottext">handlerOrDefault :: Maybe
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
</span><a href="#local-6989586621680177585"><span class="hs-identifier hs-var hs-var">handlerOrDefault</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-329"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
-&gt; HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
-&gt; Maybe
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryInputType</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap
  (Maybe Text)
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
</span><a href="#local-6989586621680177571"><span class="hs-identifier hs-var">handles</span></a></span><span>
</span><span id="line-330"></span><span>            </span><span class="annot"><span class="annottext">Maybe
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
-&gt; Maybe
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
-&gt; Maybe
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
-&gt; HashMap
     (Maybe Text)
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
-&gt; Maybe
     (QueryId
      -&gt; Vector Payload
      -&gt; Map Text Payload
      -&gt; IO (Either SomeException Payload))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">HashMap
  (Maybe Text)
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
</span><a href="#local-6989586621680177571"><span class="hs-identifier hs-var">handles</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
</span><a href="#local-6989586621680177585"><span class="hs-identifier hs-var">handlerOrDefault</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">Maybe
  (QueryId
   -&gt; Vector Payload
   -&gt; Map Text Payload
   -&gt; IO (Either SomeException Payload))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">Either SomeException Payload -&gt; IO (Either SomeException Payload)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException Payload -&gt; IO (Either SomeException Payload))
-&gt; Either SomeException Payload
-&gt; IO (Either SomeException Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException Payload
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException Payload)
-&gt; SomeException -&gt; Either SomeException Payload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QueryNotFound -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">(QueryNotFound -&gt; SomeException) -&gt; QueryNotFound -&gt; SomeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; QueryNotFound
</span><a href="Temporal.Exception.html#QueryNotFound"><span class="hs-identifier hs-var">QueryNotFound</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; QueryNotFound) -&gt; String -&gt; QueryNotFound
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">Text.unpack</span></span><span> </span><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryInputType</span><span>
</span><span id="line-334"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177590"><span class="annot"><span class="annottext">QueryId
-&gt; Vector Payload
-&gt; Map Text Payload
-&gt; IO (Either SomeException Payload)
</span><a href="#local-6989586621680177590"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">IO (Either SomeException Payload)
-&gt; IO (Either SomeException Payload)
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SomeException Payload)
 -&gt; IO (Either SomeException Payload))
-&gt; IO (Either SomeException Payload)
-&gt; IO (Either SomeException Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-336"></span><span>          </span><span class="annot"><span class="annottext">QueryId
-&gt; Vector Payload
-&gt; Map Text Payload
-&gt; IO (Either SomeException Payload)
</span><a href="#local-6989586621680177590"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-337"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; QueryId
</span><a href="Temporal.Common.html#QueryId"><span class="hs-identifier hs-var">QueryId</span></a></span><span> </span><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryId</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>            </span><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryInputArgs</span><span>
</span><span id="line-339"></span><span>            </span><span class="annot"><span class="annottext">HandleQueryInput
</span><a href="#local-6989586621680177584"><span class="hs-identifier hs-var">input</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryInputHeaders</span><span>
</span><span id="line-340"></span><span>  </span><span id="local-6989586621680177592"><span class="annot"><a href="#local-6989586621680177592"><span class="hs-identifier hs-var">cmd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177583"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680177593"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177593"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-comment">-- TODO, more useful error message</span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">QueryResult -&gt; InstanceM QueryResult
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(QueryResult -&gt; InstanceM QueryResult)
-&gt; QueryResult -&gt; InstanceM QueryResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">QueryResult
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-345"></span><span>          </span><span class="annot"><span class="annottext">QueryResult -&gt; (QueryResult -&gt; QueryResult) -&gt; QueryResult
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f QueryResult Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f QueryResult Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failed&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Command.failed</span></span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f QueryResult Failure)
-&gt; Failure -&gt; QueryResult -&gt; QueryResult
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-347"></span><span>                  </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177593"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680177606"><span class="annot"><span class="annottext">Payload
</span><a href="#local-6989586621680177606"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>      </span><span id="local-6989586621680177607"><span class="annot"><a href="#local-6989586621680177607"><span class="hs-identifier hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Payload -&gt; InstanceM Payload
forall a. IO a -&gt; InstanceM a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Payload -&gt; InstanceM Payload)
-&gt; IO Payload -&gt; InstanceM Payload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor -&gt; Payload -&gt; IO Payload
</span><a href="Temporal.Payload.html#payloadProcessorEncode"><span class="hs-identifier hs-var">payloadProcessorEncode</span></a></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor
</span><a href="#local-6989586621680177573"><span class="hs-identifier hs-var">processor</span></a></span><span> </span><span class="annot"><span class="annottext">Payload
</span><a href="#local-6989586621680177606"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.queryId</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><span class="hs-identifier">baseInput</span></span><span class="hs-operator">.</span><span class="hs-identifier">handleQueryId</span><span>
</span><span id="line-354"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.succeeded</span></span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-356"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.response</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertToProtoPayload"><span class="hs-identifier hs-type">convertToProtoPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177607"><span class="hs-identifier hs-type">res'</span></a></span><span>
</span><span id="line-357"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#addCommand"><span class="hs-identifier hs-type">addCommand</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.respondToQuery</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="#local-6989586621680177592"><span class="hs-identifier hs-type">cmd</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applySignalWorkflow"><span class="hs-identifier hs-type">applySignalWorkflow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SignalWorkflow</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#Workflow"><span class="hs-identifier hs-type">Workflow</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span id="applySignalWorkflow"><span class="annot"><span class="annottext">applySignalWorkflow :: SignalWorkflow -&gt; Workflow ()
</span><a href="Temporal.WorkflowInstance.html#applySignalWorkflow"><span class="hs-identifier hs-var hs-var">applySignalWorkflow</span></a></span></span><span> </span><span id="local-6989586621680177639"><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177639"><span class="hs-identifier hs-var">signalWorkflow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Workflow (Workflow ()) -&gt; Workflow ()
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(Workflow (Workflow ()) -&gt; Workflow ())
-&gt; Workflow (Workflow ()) -&gt; Workflow ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>  </span><span class="annot"><span class="annottext">(ContinuationEnv -&gt; InstanceM (Result (Workflow ())))
-&gt; Workflow (Workflow ())
forall a. (ContinuationEnv -&gt; InstanceM (Result a)) -&gt; Workflow a
</span><a href="Temporal.Workflow.Internal.Monad.html#Workflow"><span class="hs-identifier hs-var">Workflow</span></a></span><span> </span><span class="annot"><span class="annottext">((ContinuationEnv -&gt; InstanceM (Result (Workflow ())))
 -&gt; Workflow (Workflow ()))
-&gt; (ContinuationEnv -&gt; InstanceM (Result (Workflow ())))
-&gt; Workflow (Workflow ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ContinuationEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621680177641"><span class="annot"><a href="#local-6989586621680177641"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621680177642"><span class="annot"><a href="#local-6989586621680177642"><span class="hs-identifier hs-var">handlers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowSignalHandlers</span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177643"><span class="annot"><a href="#local-6989586621680177643"><span class="hs-identifier hs-var hs-var">handlerOrDefault</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
-&gt; HashMap (Maybe Text) (Vector Payload -&gt; Workflow ())
-&gt; Maybe (Vector Payload -&gt; Workflow ())
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177639"><span class="hs-identifier hs-var">signalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">SignalWorkflow
-&gt; FoldLike Text SignalWorkflow SignalWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text SignalWorkflow SignalWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;signalName&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.signalName</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap (Maybe Text) (Vector Payload -&gt; Workflow ())
</span><a href="#local-6989586621680177642"><span class="hs-identifier hs-var">handlers</span></a></span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Vector Payload -&gt; Workflow ())
-&gt; Maybe (Vector Payload -&gt; Workflow ())
-&gt; Maybe (Vector Payload -&gt; Workflow ())
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
-&gt; HashMap (Maybe Text) (Vector Payload -&gt; Workflow ())
-&gt; Maybe (Vector Payload -&gt; Workflow ())
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">HashMap (Maybe Text) (Vector Payload -&gt; Workflow ())
</span><a href="#local-6989586621680177642"><span class="hs-identifier hs-var">handlers</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177643"><span class="hs-identifier hs-type">handlerOrDefault</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Vector Payload -&gt; Workflow ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result (Workflow ()) -&gt; InstanceM (Result (Workflow ())))
-&gt; Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Workflow () -&gt; Result (Workflow ())
forall a. a -&gt; Result a
</span><a href="Temporal.Workflow.Internal.Monad.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">(Workflow () -&gt; Result (Workflow ()))
-&gt; Workflow () -&gt; Result (Workflow ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-371"></span><span>        </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logWarn</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Workflow ()) -&gt; Text -&gt; Workflow ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;No signal handler found for signal: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177639"><span class="hs-identifier hs-var">signalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">SignalWorkflow
-&gt; FoldLike Text SignalWorkflow SignalWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text SignalWorkflow SignalWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;signalName&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.signalName</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; Workflow ()
forall a. a -&gt; Workflow a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177646"><span class="annot"><span class="annottext">Vector Payload -&gt; Workflow ()
</span><a href="#local-6989586621680177646"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>        </span><span id="local-6989586621680177647"><span class="annot"><a href="#local-6989586621680177647"><span class="hs-identifier hs-var">eInputs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM (Vector Payload)
-&gt; InstanceM (Either SomeException (Vector Payload))
forall (m :: * -&gt; *) e a.
(MonadUnliftIO m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">UnliftIO.try</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM (Vector Payload)
 -&gt; InstanceM (Either SomeException (Vector Payload)))
-&gt; InstanceM (Vector Payload)
-&gt; InstanceM (Either SomeException (Vector Payload))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor -&gt; Vector Payload -&gt; InstanceM (Vector Payload)
forall (m :: * -&gt; *) (f :: * -&gt; *).
(MonadIO m, Traversable f) =&gt;
PayloadProcessor -&gt; f Payload -&gt; m (f Payload)
</span><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-var">processorDecodePayloads</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177641"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">payloadProcessor</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Payload -&gt; Payload) -&gt; Vector Payload -&gt; Vector Payload
forall a b. (a -&gt; b) -&gt; Vector a -&gt; Vector b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Payload -&gt; Payload
</span><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-var">convertFromProtoPayload</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177639"><span class="hs-identifier hs-var">signalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">SignalWorkflow
-&gt; FoldLike
     (Vector Payload)
     SignalWorkflow
     SignalWorkflow
     (Vector Payload)
     (Vector Payload)
-&gt; Vector Payload
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector Payload)
  SignalWorkflow
  SignalWorkflow
  (Vector Payload)
  (Vector Payload)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'input&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Command.vec'input</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177647"><span class="hs-identifier hs-type">eInputs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-376"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680177649"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177649"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result (Workflow ()) -&gt; InstanceM (Result (Workflow ())))
-&gt; Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Result (Workflow ())
forall a. SomeException -&gt; Result a
</span><a href="Temporal.Workflow.Internal.Monad.html#Throw"><span class="hs-identifier hs-var">Throw</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680177649"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-377"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680177651"><span class="annot"><span class="annottext">Vector Payload
</span><a href="#local-6989586621680177651"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result (Workflow ()) -&gt; InstanceM (Result (Workflow ())))
-&gt; Result (Workflow ()) -&gt; InstanceM (Result (Workflow ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Workflow () -&gt; Result (Workflow ())
forall a. a -&gt; Result a
</span><a href="Temporal.Workflow.Internal.Monad.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">(Workflow () -&gt; Result (Workflow ()))
-&gt; Workflow () -&gt; Result (Workflow ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>            </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Workflow ()) -&gt; Text -&gt; Workflow ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Applying signal handler for signal: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177639"><span class="hs-identifier hs-var">signalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">SignalWorkflow
-&gt; FoldLike Text SignalWorkflow SignalWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text SignalWorkflow SignalWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;signalName&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.signalName</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">Vector Payload -&gt; Workflow ()
</span><a href="#local-6989586621680177646"><span class="hs-identifier hs-var">handler</span></a></span><span> </span><span class="annot"><span class="annottext">Vector Payload
</span><a href="#local-6989586621680177651"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyNotifyHasPatch"><span class="hs-identifier hs-type">applyNotifyHasPatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NotifyHasPatch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span id="applyNotifyHasPatch"><span class="annot"><span class="annottext">applyNotifyHasPatch :: NotifyHasPatch -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyNotifyHasPatch"><span class="hs-identifier hs-var hs-var">applyNotifyHasPatch</span></a></span></span><span> </span><span id="local-6989586621680177653"><span class="annot"><span class="annottext">NotifyHasPatch
</span><a href="#local-6989586621680177653"><span class="hs-identifier hs-var">notifyHasPatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>  </span><span id="local-6989586621680177654"><span class="annot"><a href="#local-6989586621680177654"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680177655"><span class="hs-identifier hs-type">patches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#PatchId"><span class="hs-identifier hs-type">PatchId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>      </span><span id="local-6989586621680177655"><span class="annot"><a href="#local-6989586621680177655"><span class="hs-identifier hs-var hs-var">patches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177654"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowNotifiedPatches</span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">atomicModifyIORef'</span></span><span> </span><span class="annot"><a href="#local-6989586621680177655"><span class="hs-identifier hs-type">patches</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680177656"><span class="annot"><span class="annottext">Set PatchId
</span><a href="#local-6989586621680177656"><span class="hs-identifier hs-var">patchSet</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchId -&gt; Set PatchId -&gt; Set PatchId
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NotifyHasPatch
</span><a href="#local-6989586621680177653"><span class="hs-identifier hs-var">notifyHasPatch</span></a></span><span> </span><span class="annot"><span class="annottext">NotifyHasPatch
-&gt; FoldLike PatchId NotifyHasPatch NotifyHasPatch PatchId Any
-&gt; PatchId
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant PatchId) NotifyHasPatch Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;patchId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.patchId</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant PatchId) NotifyHasPatch Text
-&gt; ((PatchId -&gt; Constant PatchId Any)
    -&gt; Text -&gt; Constant PatchId Text)
-&gt; FoldLike PatchId NotifyHasPatch NotifyHasPatch PatchId Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PatchId) -&gt; Getter Text Text PatchId Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PatchId
</span><a href="Temporal.Common.html#PatchId"><span class="hs-identifier hs-var">PatchId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set PatchId
</span><a href="#local-6989586621680177656"><span class="hs-identifier hs-var">patchSet</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-keyword">data</span><span> </span><span id="PendingJob"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJob"><span class="hs-identifier hs-var">PendingJob</span></a></span></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="PendingJobResolveActivity"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveActivity"><span class="hs-identifier hs-var">PendingJobResolveActivity</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResolveActivity</span></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingJobResolveChildWorkflowExecutionStart"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecutionStart"><span class="hs-identifier hs-var">PendingJobResolveChildWorkflowExecutionStart</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResolveChildWorkflowExecutionStart</span></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingJobResolveChildWorkflowExecution"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecution"><span class="hs-identifier hs-var">PendingJobResolveChildWorkflowExecution</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResolveChildWorkflowExecution</span></span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingJobResolveSignalExternalWorkflow"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveSignalExternalWorkflow"><span class="hs-identifier hs-var">PendingJobResolveSignalExternalWorkflow</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResolveSignalExternalWorkflow</span></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingJobResolveRequestCancelExternalWorkflow"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveRequestCancelExternalWorkflow"><span class="hs-identifier hs-var">PendingJobResolveRequestCancelExternalWorkflow</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResolveRequestCancelExternalWorkflow</span></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingJobFireTimer"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobFireTimer"><span class="hs-identifier hs-var">PendingJobFireTimer</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FireTimer</span></span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PendingWorkflowCancellation"><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingWorkflowCancellation"><span class="hs-identifier hs-var">PendingWorkflowCancellation</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CancelWorkflow</span></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span id="local-6989586621680176388"><span class="annot"><a href="Temporal.WorkflowInstance.html#applyJobs"><span class="hs-identifier hs-type">applyJobs</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621680176388"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Vector</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob</span></span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-comment">-- We use the functor here because we need to call applyJobs both before and after a workflow has completed.</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-comment">-- During workflow execution, identity is the functor, but after a workflow has completed, Proxy is the functor</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-comment">-- since we don't actually have any continuation to run.</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680176388"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Coroutine.html#Await"><span class="hs-identifier hs-type">Await</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680176388"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Eval.html#SuspendableWorkflowExecution"><span class="hs-identifier hs-type">SuspendableWorkflowExecution</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-408"></span><span id="applyJobs"><span class="annot"><span class="annottext">applyJobs :: forall (f :: * -&gt; *).
Functor f =&gt;
Vector WorkflowActivationJob
-&gt; f (Await
        [ActivationResult] (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
</span><a href="Temporal.WorkflowInstance.html#applyJobs"><span class="hs-identifier hs-var hs-var">applyJobs</span></a></span></span><span> </span><span id="local-6989586621680177723"><span class="annot"><span class="annottext">Vector WorkflowActivationJob
</span><a href="#local-6989586621680177723"><span class="hs-identifier hs-var">jobs</span></a></span></span><span> </span><span id="local-6989586621680177724"><span class="annot"><span class="annottext">f (Await [ActivationResult] (SuspendableWorkflowExecution Payload))
</span><a href="#local-6989586621680177724"><span class="hs-identifier hs-var">fAwait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstanceM (f (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall (m :: * -&gt; *) e a.
(MonadUnliftIO m, Exception e) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">UnliftIO.try</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM (f (SuspendableWorkflowExecution Payload))
 -&gt; InstanceM
      (Either SomeException (f (SuspendableWorkflowExecution Payload))))
-&gt; InstanceM (f (SuspendableWorkflowExecution Payload))
-&gt; InstanceM
     (Either SomeException (f (SuspendableWorkflowExecution Payload)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; InstanceM ()
(Text -&gt; InstanceM ()) -&gt; (Text -&gt; Text) -&gt; Text -&gt; InstanceM ()
forall a. a -&gt; a
forall msg.
ToLogStr msg =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; InstanceM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logDebug</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; InstanceM ()) -&gt; Text -&gt; InstanceM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Applying jobs: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
</span><a href="#local-6989586621680177723"><span class="hs-identifier hs-var">jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680177725"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177725"><span class="hs-identifier hs-var hs-var">patchNotifications</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680177726"><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177726"><span class="hs-identifier hs-var hs-var">signalWorkflows</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680177727"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177727"><span class="hs-identifier hs-var hs-var">queryWorkflows</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680177728"><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177728"><span class="hs-identifier hs-var hs-var">resolutions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680177729"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177729"><span class="hs-identifier hs-var hs-var">otherJobs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
 InstanceM ())
</span><a href="#local-6989586621680177730"><span class="hs-identifier hs-var">jobGroups</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177725"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177727"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177729"><span class="hs-identifier hs-var">otherJobs</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span id="local-6989586621680177731"><span class="annot"><a href="#local-6989586621680177731"><span class="hs-identifier hs-var">activationResults</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PendingJob] -&gt; InstanceM [ActivationResult]
</span><a href="Temporal.WorkflowInstance.html#applyResolutions"><span class="hs-identifier hs-var">applyResolutions</span></a></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177728"><span class="hs-identifier hs-var">resolutions</span></a></span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177733"><span class="annot"><a href="#local-6989586621680177733"><span class="hs-identifier hs-var hs-var">activations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177731"><span class="hs-identifier hs-var">activationResults</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Coroutine.html#Await"><span class="hs-identifier hs-type">Await</span></a></span><span> </span><span id="local-6989586621680177735"><span class="annot"><span class="annottext">[ActivationResult] -&gt; SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177735"><span class="hs-identifier hs-var">wf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-comment">-- If we don't have any activations or signals, then no useful state could have changed.</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-comment">-- This happens when we receive non-resolving jobs like queries. If we reactivate</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-comment">-- the workflow, it will just block again, which we don't want, because it confuses</span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-comment">-- the SDK core's state machine.</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177733"><span class="hs-identifier hs-var">activations</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-424"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177726"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-425"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Await [ActivationResult] (SuspendableWorkflowExecution Payload)
-&gt; SuspendableWorkflowExecution Payload
forall (m :: * -&gt; *) (s :: * -&gt; *) x.
Monad m =&gt;
s (Coroutine s m x) -&gt; Coroutine s m x
</span><a href="Temporal.Coroutine.html#suspend"><span class="hs-identifier hs-var">suspend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([ActivationResult] -&gt; SuspendableWorkflowExecution Payload)
-&gt; Await [ActivationResult] (SuspendableWorkflowExecution Payload)
forall x y. (x -&gt; y) -&gt; Await x y
</span><a href="Temporal.Coroutine.html#Await"><span class="hs-identifier hs-var">Await</span></a></span><span> </span><span class="annot"><span class="annottext">[ActivationResult] -&gt; SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177735"><span class="hs-identifier hs-var">wf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>            </span><span id="local-6989586621680177737"><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177737"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>              </span><span class="annot"><span class="annottext">InstanceM () -&gt; Coroutine (Await [ActivationResult]) InstanceM ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; Coroutine (Await [ActivationResult]) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(InstanceM () -&gt; Coroutine (Await [ActivationResult]) InstanceM ())
-&gt; InstanceM ()
-&gt; Coroutine (Await [ActivationResult]) InstanceM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; InstanceM ()
(Text -&gt; InstanceM ()) -&gt; (Text -&gt; Text) -&gt; Text -&gt; InstanceM ()
forall a. a -&gt; a
forall msg.
ToLogStr msg =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; InstanceM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logDebug</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;We get signal&quot;</span></span><span>
</span><span id="line-428"></span><span>              </span><span class="annot"><span class="annottext">InstanceM () -&gt; Coroutine (Await [ActivationResult]) InstanceM ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; Coroutine (Await [ActivationResult]) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Workflow () -&gt; InstanceM ()) -&gt; [Workflow ()] -&gt; InstanceM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Workflow () -&gt; InstanceM ()
</span><a href="Temporal.Workflow.Eval.html#injectWorkflowSignal"><span class="hs-identifier hs-var">injectWorkflowSignal</span></a></span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177737"><span class="hs-identifier hs-var">sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coroutine (Await [ActivationResult]) InstanceM ()
-&gt; SuspendableWorkflowExecution Payload
-&gt; SuspendableWorkflowExecution Payload
forall a b.
Coroutine (Await [ActivationResult]) InstanceM a
-&gt; Coroutine (Await [ActivationResult]) InstanceM b
-&gt; Coroutine (Await [ActivationResult]) InstanceM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult] -&gt; SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177735"><span class="hs-identifier hs-var">wf</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>          </span><span class="annot"><span class="annottext">[ActivationResult]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177726"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-430"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ActivationResult] -&gt; SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177735"><span class="hs-identifier hs-var">wf</span></a></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177733"><span class="hs-identifier hs-var">activations</span></a></span><span>
</span><span id="line-431"></span><span>            </span><span id="local-6989586621680177740"><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177740"><span class="hs-identifier hs-var">sigs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InstanceM () -&gt; Coroutine (Await [ActivationResult]) InstanceM ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; Coroutine (Await [ActivationResult]) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Workflow () -&gt; InstanceM ()) -&gt; [Workflow ()] -&gt; InstanceM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Workflow () -&gt; InstanceM ()
</span><a href="Temporal.Workflow.Eval.html#injectWorkflowSignal"><span class="hs-identifier hs-var">injectWorkflowSignal</span></a></span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177740"><span class="hs-identifier hs-var">sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Coroutine (Await [ActivationResult]) InstanceM ()
-&gt; SuspendableWorkflowExecution Payload
-&gt; SuspendableWorkflowExecution Payload
forall a b.
Coroutine (Await [ActivationResult]) InstanceM a
-&gt; Coroutine (Await [ActivationResult]) InstanceM b
-&gt; Coroutine (Await [ActivationResult]) InstanceM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult] -&gt; SuspendableWorkflowExecution Payload
</span><a href="#local-6989586621680177735"><span class="hs-identifier hs-var">wf</span></a></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177733"><span class="hs-identifier hs-var">activations</span></a></span><span>
</span><span id="line-432"></span><span>            </span><span class="hs-comment">{- TODO: we need to run the signal workflows without messing up ContinuationEnv: runWorkflow signalWorkflows -}</span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>      </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621680177724"><span class="hs-identifier hs-type">fAwait</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-436"></span><span>    </span><span id="local-6989586621680177730"><span class="annot"><span class="annottext">jobGroups :: (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
 InstanceM ())
</span><a href="#local-6989586621680177730"><span class="hs-identifier hs-var hs-var">jobGroups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>      </span><span class="annot"><span class="annottext">(WorkflowActivationJob
 -&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
     InstanceM ())
 -&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
     InstanceM ()))
-&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
    InstanceM ())
-&gt; Vector WorkflowActivationJob
-&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
    InstanceM ())
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; Vector a -&gt; b
</span><span class="hs-identifier hs-var">V.foldr</span></span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680177742"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680177742"><span class="hs-identifier hs-var">job</span></a></span></span><span> </span><span id="local-6989586621680177743"><span class="annot"><span class="annottext">tup :: (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
 InstanceM ())
</span><a href="#local-6989586621680177743"><span class="hs-identifier hs-var">tup</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621680177744"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680177745"><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680177746"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680177747"><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680177748"><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680177742"><span class="hs-identifier hs-var">job</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
-&gt; FoldLike
     (Maybe WorkflowActivationJob'Variant)
     WorkflowActivationJob
     WorkflowActivationJob
     (Maybe WorkflowActivationJob'Variant)
     (Maybe WorkflowActivationJob'Variant)
-&gt; Maybe WorkflowActivationJob'Variant
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe WorkflowActivationJob'Variant)
  WorkflowActivationJob
  WorkflowActivationJob
  (Maybe WorkflowActivationJob'Variant)
  (Maybe WorkflowActivationJob'Variant)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'variant&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'variant</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'NotifyHasPatch</span></span><span> </span><span id="local-6989586621680177751"><span class="annot"><span class="annottext">NotifyHasPatch
</span><a href="#local-6989586621680177751"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NotifyHasPatch -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyNotifyHasPatch"><span class="hs-identifier hs-var">applyNotifyHasPatch</span></a></span><span> </span><span class="annot"><span class="annottext">NotifyHasPatch
</span><a href="#local-6989586621680177751"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceM () -&gt; InstanceM () -&gt; InstanceM ()
forall a b. InstanceM a -&gt; InstanceM b -&gt; InstanceM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'SignalWorkflow</span></span><span> </span><span id="local-6989586621680177753"><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177753"><span class="hs-identifier hs-var">sig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SignalWorkflow -&gt; Workflow ()
</span><a href="Temporal.WorkflowInstance.html#applySignalWorkflow"><span class="hs-identifier hs-var">applySignalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">SignalWorkflow
</span><a href="#local-6989586621680177753"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">Workflow () -&gt; [Workflow ()] -&gt; [Workflow ()]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'QueryWorkflow</span></span><span> </span><span id="local-6989586621680177755"><span class="annot"><span class="annottext">QueryWorkflow
</span><a href="#local-6989586621680177755"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(?callStack::CallStack) =&gt; QueryWorkflow -&gt; InstanceM ()
QueryWorkflow -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyQueryWorkflow"><span class="hs-identifier hs-var">applyQueryWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">QueryWorkflow
</span><a href="#local-6989586621680177755"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceM () -&gt; InstanceM () -&gt; InstanceM ()
forall a b. InstanceM a -&gt; InstanceM b -&gt; InstanceM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>            </span><span class="hs-comment">-- We collect these in bulk and resolve them in one go by pushing them into the completed queue. This reactivates the suspended workflow</span><span>
</span><span id="line-443"></span><span>            </span><span class="hs-comment">-- and it tries to execute further.</span><span>
</span><span id="line-444"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'FireTimer</span></span><span> </span><span id="local-6989586621680177757"><span class="annot"><span class="annottext">FireTimer
</span><a href="#local-6989586621680177757"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FireTimer -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobFireTimer"><span class="hs-identifier hs-var">PendingJobFireTimer</span></a></span><span> </span><span class="annot"><span class="annottext">FireTimer
</span><a href="#local-6989586621680177757"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'ResolveActivity</span></span><span> </span><span id="local-6989586621680177759"><span class="annot"><span class="annottext">ResolveActivity
</span><a href="#local-6989586621680177759"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResolveActivity -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobResolveActivity"><span class="hs-identifier hs-var">PendingJobResolveActivity</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveActivity
</span><a href="#local-6989586621680177759"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'ResolveChildWorkflowExecutionStart</span></span><span> </span><span id="local-6989586621680177761"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
</span><a href="#local-6989586621680177761"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecutionStart"><span class="hs-identifier hs-var">PendingJobResolveChildWorkflowExecutionStart</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
</span><a href="#local-6989586621680177761"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'ResolveChildWorkflowExecution</span></span><span> </span><span id="local-6989586621680177763"><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
</span><a href="#local-6989586621680177763"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecution"><span class="hs-identifier hs-var">PendingJobResolveChildWorkflowExecution</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
</span><a href="#local-6989586621680177763"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'ResolveSignalExternalWorkflow</span></span><span> </span><span id="local-6989586621680177765"><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177765"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobResolveSignalExternalWorkflow"><span class="hs-identifier hs-var">PendingJobResolveSignalExternalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177765"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'ResolveRequestCancelExternalWorkflow</span></span><span> </span><span id="local-6989586621680177767"><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177767"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingJobResolveRequestCancelExternalWorkflow"><span class="hs-identifier hs-var">PendingJobResolveRequestCancelExternalWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177767"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'UpdateRandomSeed</span></span><span> </span><span id="local-6989586621680177769"><span class="annot"><span class="annottext">UpdateRandomSeed
</span><a href="#local-6989586621680177769"><span class="hs-identifier hs-var">updateRandomSeed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceM () -&gt; InstanceM () -&gt; InstanceM ()
forall a b. InstanceM a -&gt; InstanceM b -&gt; InstanceM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">UpdateRandomSeed -&gt; InstanceM ()
</span><a href="Temporal.WorkflowInstance.html#applyUpdateRandomSeed"><span class="hs-identifier hs-var">applyUpdateRandomSeed</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateRandomSeed
</span><a href="#local-6989586621680177769"><span class="hs-identifier hs-var">updateRandomSeed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'CancelWorkflow</span></span><span> </span><span id="local-6989586621680177771"><span class="annot"><span class="annottext">CancelWorkflow
</span><a href="#local-6989586621680177771"><span class="hs-identifier hs-var">cancelWorkflow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177744"><span class="hs-identifier hs-var">patchNotifications</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Workflow ()]
</span><a href="#local-6989586621680177745"><span class="hs-identifier hs-var">signalWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177746"><span class="hs-identifier hs-var">queryWorkflows</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CancelWorkflow -&gt; PendingJob
</span><a href="Temporal.WorkflowInstance.html#PendingWorkflowCancellation"><span class="hs-identifier hs-var">PendingWorkflowCancellation</span></a></span><span> </span><span class="annot"><span class="annottext">CancelWorkflow
</span><a href="#local-6989586621680177771"><span class="hs-identifier hs-var">cancelWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">PendingJob -&gt; [PendingJob] -&gt; [PendingJob]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177747"><span class="hs-identifier hs-var">resolutions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceM ()
</span><a href="#local-6989586621680177748"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>            </span><span class="hs-comment">-- By the time we get here, the workflow should already be running.</span><span>
</span><span id="line-453"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'StartWorkflow</span></span><span> </span><span id="local-6989586621680177773"><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680177773"><span class="hs-identifier hs-var">_startWorkflow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
 InstanceM ())
</span><a href="#local-6989586621680177743"><span class="hs-identifier hs-var">tup</span></a></span><span>
</span><span id="line-454"></span><span>            </span><span class="hs-comment">-- Handled in the worker.</span><span>
</span><span id="line-455"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'RemoveFromCache</span></span><span> </span><span id="local-6989586621680177775"><span class="annot"><span class="annottext">RemoveFromCache
</span><a href="#local-6989586621680177775"><span class="hs-identifier hs-var">_removeFromCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
 InstanceM ())
</span><a href="#local-6989586621680177743"><span class="hs-identifier hs-var">tup</span></a></span><span>
</span><span id="line-456"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'DoUpdate</span></span><span> </span><span class="annot"><span class="annottext">DoUpdate
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
    InstanceM ())
forall a. (?callStack::CallStack) =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;DoUpdate not yet implemented&quot;</span></span><span>
</span><span id="line-457"></span><span>            </span><span class="annot"><span class="annottext">Maybe WorkflowActivationJob'Variant
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError
-&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
    InstanceM ())
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError
 -&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
     InstanceM ()))
-&gt; RuntimeError
-&gt; (InstanceM (), [Workflow ()], InstanceM (), [PendingJob],
    InstanceM ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Uncrecognized workflow activation job variant&quot;</span></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; InstanceM ()
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; InstanceM ()
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; InstanceM ()
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>        </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
</span><a href="#local-6989586621680177723"><span class="hs-identifier hs-var">jobs</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyResolutions"><span class="hs-identifier hs-type">applyResolutions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJob"><span class="hs-identifier hs-type">PendingJob</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-464"></span><span id="applyResolutions"><span class="annot"><span class="annottext">applyResolutions :: [PendingJob] -&gt; InstanceM [ActivationResult]
</span><a href="Temporal.WorkflowInstance.html#applyResolutions"><span class="hs-identifier hs-var hs-var">applyResolutions</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ActivationResult] -&gt; InstanceM [ActivationResult]
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-465"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#applyResolutions"><span class="hs-identifier hs-var">applyResolutions</span></a></span><span> </span><span id="local-6989586621680177779"><span class="annot"><span class="annottext">[PendingJob]
</span><a href="#local-6989586621680177779"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>  </span><span id="local-6989586621680177780"><span class="annot"><a href="#local-6989586621680177780"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-467"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>    </span><span id="local-6989586621680177781"><span class="annot"><a href="#local-6989586621680177781"><span class="hs-identifier hs-var">sequenceMaps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowSequenceMaps</span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680177783"><span class="hs-identifier hs-type">makeCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#SequenceMaps"><span class="hs-identifier hs-type">SequenceMaps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJob"><span class="hs-identifier hs-type">PendingJob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-type">ActivationResult</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#SequenceMaps"><span class="hs-identifier hs-type">SequenceMaps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>        </span><span id="local-6989586621680177783"><span class="annot"><a href="#local-6989586621680177783"><span class="hs-identifier hs-var hs-var">makeCompletion</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621680177784"><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680177785"><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680177786"><span class="annot"><span class="annottext">PendingJob
</span><a href="#local-6989586621680177786"><span class="hs-identifier hs-var">pj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PendingJob
</span><a href="#local-6989586621680177786"><span class="hs-identifier hs-var">pj</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-471"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveActivity"><span class="hs-identifier hs-type">PendingJobResolveActivity</span></a></span><span> </span><span id="local-6989586621680177787"><span class="annot"><span class="annottext">ResolveActivity
</span><a href="#local-6989586621680177787"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-472"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177788"><span class="annot"><span class="annottext">existingIVar :: Maybe (IVar ResolveActivity)
</span><a href="#local-6989586621680177788"><span class="hs-identifier hs-var hs-var">existingIVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence
-&gt; HashMap Sequence (IVar ResolveActivity)
-&gt; Maybe (IVar ResolveActivity)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveActivity
</span><a href="#local-6989586621680177787"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveActivity
-&gt; FoldLike Sequence ResolveActivity ResolveActivity Sequence Any
-&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveActivity Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveActivity Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike Sequence ResolveActivity ResolveActivity Sequence Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">activities</span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IVar ResolveActivity)
</span><a href="#local-6989586621680177788"><span class="hs-identifier hs-var">existingIVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-474"></span><span>              </span><span class="annot"><span class="annottext">Maybe (IVar ResolveActivity)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-475"></span><span>                </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Activity handle not found&quot;</span></span><span>
</span><span id="line-476"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177791"><span class="annot"><span class="annottext">IVar ResolveActivity
</span><a href="#local-6989586621680177791"><span class="hs-identifier hs-var">existing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-477"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal ResolveActivity
-&gt; IVar ResolveActivity -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveActivity -&gt; ResultVal ResolveActivity
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveActivity
</span><a href="#local-6989586621680177787"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IVar ResolveActivity
</span><a href="#local-6989586621680177791"><span class="hs-identifier hs-var">existing</span></a></span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-478"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-479"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#activities"><span class="hs-identifier hs-var">activities</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177787"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">activities</span><span>
</span><span id="line-480"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-481"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecutionStart"><span class="hs-identifier hs-type">PendingJobResolveChildWorkflowExecutionStart</span></a></span><span> </span><span id="local-6989586621680177796"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
</span><a href="#local-6989586621680177796"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177797"><span class="annot"><span class="annottext">existingHandle :: Maybe SomeChildWorkflowHandle
</span><a href="#local-6989586621680177797"><span class="hs-identifier hs-var hs-var">existingHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence
-&gt; HashMap Sequence SomeChildWorkflowHandle
-&gt; Maybe SomeChildWorkflowHandle
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
</span><a href="#local-6989586621680177796"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
-&gt; FoldLike
     Sequence
     ResolveChildWorkflowExecutionStart
     ResolveChildWorkflowExecutionStart
     Sequence
     Any
-&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant Sequence) ResolveChildWorkflowExecutionStart Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant Sequence) ResolveChildWorkflowExecutionStart Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike
     Sequence
     ResolveChildWorkflowExecutionStart
     ResolveChildWorkflowExecutionStart
     Sequence
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">childWorkflows</span><span>
</span><span id="line-484"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SomeChildWorkflowHandle
</span><a href="#local-6989586621680177797"><span class="hs-identifier hs-var">existingHandle</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>              </span><span class="annot"><span class="annottext">Maybe SomeChildWorkflowHandle
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-486"></span><span>                </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Child workflow not found&quot;</span></span><span>
</span><span id="line-487"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#SomeChildWorkflowHandle"><span class="hs-identifier hs-type">SomeChildWorkflowHandle</span></a></span><span> </span><span id="local-6989586621680177842"><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
</span><a href="#local-6989586621680177796"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart
-&gt; FoldLike
     (Maybe ResolveChildWorkflowExecutionStart'Status)
     ResolveChildWorkflowExecutionStart
     ResolveChildWorkflowExecutionStart
     (Maybe ResolveChildWorkflowExecutionStart'Status)
     (Maybe ResolveChildWorkflowExecutionStart'Status)
-&gt; Maybe ResolveChildWorkflowExecutionStart'Status
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe ResolveChildWorkflowExecutionStart'Status)
  ResolveChildWorkflowExecutionStart
  ResolveChildWorkflowExecutionStart
  (Maybe ResolveChildWorkflowExecutionStart'Status)
  (Maybe ResolveChildWorkflowExecutionStart'Status)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'status&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'status</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-488"></span><span>                </span><span class="annot"><span class="annottext">Maybe ResolveChildWorkflowExecutionStart'Status
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-489"></span><span>                  </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Child workflow start did not have a known status&quot;</span></span><span>
</span><span id="line-490"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177844"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart'Status
</span><a href="#local-6989586621680177844"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStart'Status
</span><a href="#local-6989586621680177844"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-491"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">ResolveChildWorkflowExecutionStart'Succeeded</span></span><span> </span><span id="local-6989586621680177846"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartSuccess
</span><a href="#local-6989586621680177846"><span class="hs-identifier hs-var">succeeded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-492"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ResultVal ()
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">startHandle</span><span>
</span><span id="line-493"></span><span>                        </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ResultVal RunId -&gt; IVar RunId -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunId -&gt; ResultVal RunId
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartSuccess
</span><a href="#local-6989586621680177846"><span class="hs-identifier hs-var">succeeded</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartSuccess
-&gt; FoldLike
     RunId
     ResolveChildWorkflowExecutionStartSuccess
     ResolveChildWorkflowExecutionStartSuccess
     RunId
     Any
-&gt; RunId
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant RunId) ResolveChildWorkflowExecutionStartSuccess Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant RunId) ResolveChildWorkflowExecutionStartSuccess Text
-&gt; ((RunId -&gt; Constant RunId Any) -&gt; Text -&gt; Constant RunId Text)
-&gt; FoldLike
     RunId
     ResolveChildWorkflowExecutionStartSuccess
     ResolveChildWorkflowExecutionStartSuccess
     RunId
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Getter Text Text RunId Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">firstExecutionRunId</span><span>
</span><span id="line-494"></span><span>                        </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-495"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-496"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">ResolveChildWorkflowExecutionStart'Failed</span></span><span> </span><span id="local-6989586621680177849"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
</span><a href="#local-6989586621680177849"><span class="hs-identifier hs-var">failed</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-498"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177850"><span class="annot"><span class="annottext">updatedMaps :: SequenceMaps
</span><a href="#local-6989586621680177850"><span class="hs-identifier hs-var hs-var">updatedMaps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-499"></span><span>                          </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-500"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#childWorkflows"><span class="hs-identifier hs-var">childWorkflows</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177796"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">childWorkflows</span><span>
</span><span id="line-501"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-502"></span><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
</span><a href="#local-6989586621680177849"><span class="hs-identifier hs-var">failed</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
-&gt; FoldLike
     StartChildWorkflowExecutionFailedCause
     ResolveChildWorkflowExecutionStartFailure
     ResolveChildWorkflowExecutionStartFailure
     StartChildWorkflowExecutionFailedCause
     StartChildWorkflowExecutionFailedCause
-&gt; StartChildWorkflowExecutionFailedCause
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  StartChildWorkflowExecutionFailedCause
  ResolveChildWorkflowExecutionStartFailure
  ResolveChildWorkflowExecutionStartFailure
  StartChildWorkflowExecutionFailedCause
  StartChildWorkflowExecutionFailedCause
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;cause&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.cause</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-503"></span><span>                        </span><span class="annot"><span class="annottext">StartChildWorkflowExecutionFailedCause
</span><span class="hs-identifier hs-var">START_CHILD_WORKFLOW_EXECUTION_FAILED_CAUSE_WORKFLOW_ALREADY_EXISTS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680177854"><span class="hs-identifier hs-type">failure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680176524"><span class="annot"><a href="#local-6989586621680176524"><span class="hs-identifier hs-type">v</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#ResultVal"><span class="hs-identifier hs-type">ResultVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680176524"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-505"></span><span>                              </span><span id="local-6989586621680177854"><span class="annot"><span class="annottext">failure :: forall v. ResultVal v
</span><a href="#local-6989586621680177854"><span class="hs-identifier hs-var hs-var">failure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-506"></span><span>                                </span><span class="annot"><span class="annottext">SomeException -&gt; ResultVal v
forall a. SomeException -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#ThrowWorkflow"><span class="hs-identifier hs-var">ThrowWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; ResultVal v) -&gt; SomeException -&gt; ResultVal v
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-507"></span><span>                                  </span><span class="annot"><span class="annottext">WorkflowAlreadyStarted -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowAlreadyStarted -&gt; SomeException)
-&gt; WorkflowAlreadyStarted -&gt; SomeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-508"></span><span>                                    </span><span class="annot"><a href="Temporal.Exception.html#WorkflowAlreadyStarted"><span class="hs-identifier hs-type">WorkflowAlreadyStarted</span></a></span><span>
</span><span id="line-509"></span><span>                                      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">workflowAlreadyStartedWorkflowId :: WorkflowId
</span><a href="#local-6989586621680177865"><span class="hs-identifier hs-var">workflowAlreadyStartedWorkflowId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; WorkflowId
</span><a href="Temporal.Common.html#WorkflowId"><span class="hs-identifier hs-var">WorkflowId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
</span><a href="#local-6989586621680177849"><span class="hs-identifier hs-var">failed</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
-&gt; FoldLike
     Text
     ResolveChildWorkflowExecutionStartFailure
     ResolveChildWorkflowExecutionStartFailure
     Text
     Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Text
  ResolveChildWorkflowExecutionStartFailure
  ResolveChildWorkflowExecutionStartFailure
  Text
  Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowId</span></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>                                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">workflowAlreadyStartedWorkflowType :: WorkflowType
</span><a href="#local-6989586621680177868"><span class="hs-identifier hs-var">workflowAlreadyStartedWorkflowType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; WorkflowType
</span><a href="Temporal.Common.html#WorkflowType"><span class="hs-identifier hs-var">WorkflowType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
</span><a href="#local-6989586621680177849"><span class="hs-identifier hs-var">failed</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
-&gt; FoldLike
     Text
     ResolveChildWorkflowExecutionStartFailure
     ResolveChildWorkflowExecutionStartFailure
     Text
     Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Text
  ResolveChildWorkflowExecutionStartFailure
  ResolveChildWorkflowExecutionStartFailure
  Text
  Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowType&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowType</span></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>                                      </span><span class="hs-special">}</span><span>
</span><span id="line-512"></span><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="annot"><span class="annottext">ResultVal ()
forall v. ResultVal v
</span><a href="#local-6989586621680177854"><span class="hs-identifier hs-var">failure</span></a></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">startHandle</span><span>
</span><span id="line-513"></span><span>                                </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ResultVal RunId -&gt; IVar RunId -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="annot"><span class="annottext">ResultVal RunId
forall v. ResultVal v
</span><a href="#local-6989586621680177854"><span class="hs-identifier hs-var">failure</span></a></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">firstExecutionRunId</span><span>
</span><span id="line-514"></span><span>                                </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-515"></span><span>                             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177850"><span class="hs-identifier hs-var">updatedMaps</span></a></span><span>
</span><span id="line-516"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>                        </span><span class="annot"><span class="annottext">StartChildWorkflowExecutionFailedCause
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-518"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span>
</span><span id="line-519"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ResultVal ()
forall a. SomeException -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#ThrowInternal"><span class="hs-identifier hs-var">ThrowInternal</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; ResultVal ()) -&gt; SomeException -&gt; ResultVal ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; SomeException) -&gt; RuntimeError -&gt; SomeException
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unknown child workflow start failure: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StartChildWorkflowExecutionFailedCause -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
</span><a href="#local-6989586621680177849"><span class="hs-identifier hs-var">failed</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartFailure
-&gt; FoldLike
     StartChildWorkflowExecutionFailedCause
     ResolveChildWorkflowExecutionStartFailure
     ResolveChildWorkflowExecutionStartFailure
     StartChildWorkflowExecutionFailedCause
     StartChildWorkflowExecutionFailedCause
-&gt; StartChildWorkflowExecutionFailedCause
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  StartChildWorkflowExecutionFailedCause
  ResolveChildWorkflowExecutionStartFailure
  ResolveChildWorkflowExecutionStartFailure
  StartChildWorkflowExecutionFailedCause
  StartChildWorkflowExecutionFailedCause
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;cause&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.cause</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>                              </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">startHandle</span><span>
</span><span id="line-521"></span><span>                              </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-522"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177850"><span class="hs-identifier hs-var">updatedMaps</span></a></span><span>
</span><span id="line-523"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">ResolveChildWorkflowExecutionStart'Cancelled</span></span><span> </span><span id="local-6989586621680177872"><span class="annot"><span class="annottext">ResolveChildWorkflowExecutionStartCancelled
</span><a href="#local-6989586621680177872"><span class="hs-identifier hs-var">_cancelled</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ResultVal ()
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">startHandle</span><span>
</span><span id="line-526"></span><span>                        </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ResultVal RunId -&gt; IVar RunId -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ResultVal RunId
forall a. SomeException -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#ThrowWorkflow"><span class="hs-identifier hs-var">ThrowWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; ResultVal RunId)
-&gt; SomeException -&gt; ResultVal RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowCancelled -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowCancelled
</span><a href="Temporal.Exception.html#ChildWorkflowCancelled"><span class="hs-identifier hs-var">ChildWorkflowCancelled</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">firstExecutionRunId</span><span>
</span><span id="line-527"></span><span>                        </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ResultVal ResolveChildWorkflowExecution
-&gt; IVar ResolveChildWorkflowExecution -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; ResultVal ResolveChildWorkflowExecution
forall a. SomeException -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#ThrowWorkflow"><span class="hs-identifier hs-var">ThrowWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; ResultVal ResolveChildWorkflowExecution)
-&gt; SomeException -&gt; ResultVal ResolveChildWorkflowExecution
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowCancelled -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">ChildWorkflowCancelled
</span><a href="Temporal.Exception.html#ChildWorkflowCancelled"><span class="hs-identifier hs-var">ChildWorkflowCancelled</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177842"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">resultHandle</span><span>
</span><span id="line-528"></span><span>                        </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-529"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-530"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#childWorkflows"><span class="hs-identifier hs-var">childWorkflows</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177796"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">childWorkflows</span><span>
</span><span id="line-531"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-532"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingWorkflowCancellation"><span class="hs-identifier hs-type">PendingWorkflowCancellation</span></a></span><span> </span><span class="annot"><span class="annottext">CancelWorkflow
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ResultVal ()
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177780"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowCancellationVar</span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveChildWorkflowExecution"><span class="hs-identifier hs-type">PendingJobResolveChildWorkflowExecution</span></a></span><span> </span><span id="local-6989586621680177874"><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
</span><a href="#local-6989586621680177874"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177875"><span class="annot"><span class="annottext">existingHandle :: Maybe SomeChildWorkflowHandle
</span><a href="#local-6989586621680177875"><span class="hs-identifier hs-var hs-var">existingHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence
-&gt; HashMap Sequence SomeChildWorkflowHandle
-&gt; Maybe SomeChildWorkflowHandle
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
</span><a href="#local-6989586621680177874"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
-&gt; FoldLike
     Sequence
     ResolveChildWorkflowExecution
     ResolveChildWorkflowExecution
     Sequence
     Any
-&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveChildWorkflowExecution Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveChildWorkflowExecution Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike
     Sequence
     ResolveChildWorkflowExecution
     ResolveChildWorkflowExecution
     Sequence
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">childWorkflows</span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SomeChildWorkflowHandle
</span><a href="#local-6989586621680177875"><span class="hs-identifier hs-var">existingHandle</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-537"></span><span>              </span><span class="annot"><span class="annottext">Maybe SomeChildWorkflowHandle
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Child Workflow Execution not found&quot;</span></span><span>
</span><span id="line-538"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#SomeChildWorkflowHandle"><span class="hs-identifier hs-type">SomeChildWorkflowHandle</span></a></span><span> </span><span id="local-6989586621680177883"><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177883"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-539"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal ResolveChildWorkflowExecution
-&gt; IVar ResolveChildWorkflowExecution -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
-&gt; ResultVal ResolveChildWorkflowExecution
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveChildWorkflowExecution
</span><a href="#local-6989586621680177874"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChildWorkflowHandle result
</span><a href="#local-6989586621680177883"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">resultHandle</span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-540"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-541"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#childWorkflows"><span class="hs-identifier hs-var">childWorkflows</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177874"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">childWorkflows</span><span>
</span><span id="line-542"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-543"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveSignalExternalWorkflow"><span class="hs-identifier hs-type">PendingJobResolveSignalExternalWorkflow</span></a></span><span> </span><span id="local-6989586621680177884"><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177884"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-545"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177885"><span class="annot"><span class="annottext">mresVar :: Maybe (IVar ResolveSignalExternalWorkflow)
</span><a href="#local-6989586621680177885"><span class="hs-identifier hs-var hs-var">mresVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence
-&gt; HashMap Sequence (IVar ResolveSignalExternalWorkflow)
-&gt; Maybe (IVar ResolveSignalExternalWorkflow)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177884"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
-&gt; FoldLike
     Sequence
     ResolveSignalExternalWorkflow
     ResolveSignalExternalWorkflow
     Sequence
     Any
-&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveSignalExternalWorkflow Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) ResolveSignalExternalWorkflow Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike
     Sequence
     ResolveSignalExternalWorkflow
     ResolveSignalExternalWorkflow
     Sequence
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">externalSignals</span><span>
</span><span id="line-546"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IVar ResolveSignalExternalWorkflow)
</span><a href="#local-6989586621680177885"><span class="hs-identifier hs-var">mresVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-547"></span><span>              </span><span class="annot"><span class="annottext">Maybe (IVar ResolveSignalExternalWorkflow)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;External Signal IVar for sequence not found&quot;</span></span><span>
</span><span id="line-548"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177886"><span class="annot"><span class="annottext">IVar ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177886"><span class="hs-identifier hs-var">resVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-549"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal ResolveSignalExternalWorkflow
-&gt; IVar ResolveSignalExternalWorkflow -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
-&gt; ResultVal ResolveSignalExternalWorkflow
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177884"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IVar ResolveSignalExternalWorkflow
</span><a href="#local-6989586621680177886"><span class="hs-identifier hs-var">resVar</span></a></span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-550"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-551"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#externalSignals"><span class="hs-identifier hs-var">externalSignals</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177884"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">externalSignals</span><span>
</span><span id="line-552"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobResolveRequestCancelExternalWorkflow"><span class="hs-identifier hs-type">PendingJobResolveRequestCancelExternalWorkflow</span></a></span><span> </span><span id="local-6989586621680177888"><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177888"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177889"><span class="annot"><span class="annottext">mresVar :: Maybe (IVar ResolveRequestCancelExternalWorkflow)
</span><a href="#local-6989586621680177889"><span class="hs-identifier hs-var hs-var">mresVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence
-&gt; HashMap Sequence (IVar ResolveRequestCancelExternalWorkflow)
-&gt; Maybe (IVar ResolveRequestCancelExternalWorkflow)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177888"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
-&gt; FoldLike
     Sequence
     ResolveRequestCancelExternalWorkflow
     ResolveRequestCancelExternalWorkflow
     Sequence
     Any
-&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant Sequence) ResolveRequestCancelExternalWorkflow Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant Sequence) ResolveRequestCancelExternalWorkflow Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike
     Sequence
     ResolveRequestCancelExternalWorkflow
     ResolveRequestCancelExternalWorkflow
     Sequence
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">externalCancels</span><span>
</span><span id="line-556"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IVar ResolveRequestCancelExternalWorkflow)
</span><a href="#local-6989586621680177889"><span class="hs-identifier hs-var">mresVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-557"></span><span>              </span><span class="annot"><span class="annottext">Maybe (IVar ResolveRequestCancelExternalWorkflow)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;External Cancel IVar for sequence not found&quot;</span></span><span>
</span><span id="line-558"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177890"><span class="annot"><span class="annottext">IVar ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177890"><span class="hs-identifier hs-var">resVar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal ResolveRequestCancelExternalWorkflow
-&gt; IVar ResolveRequestCancelExternalWorkflow -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
-&gt; ResultVal ResolveRequestCancelExternalWorkflow
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="annot"><span class="annottext">ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177888"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IVar ResolveRequestCancelExternalWorkflow
</span><a href="#local-6989586621680177890"><span class="hs-identifier hs-var">resVar</span></a></span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-560"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-561"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#externalCancels"><span class="hs-identifier hs-var">externalCancels</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177888"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">externalCancels</span><span>
</span><span id="line-562"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-563"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>          </span><span class="annot"><a href="Temporal.WorkflowInstance.html#PendingJobFireTimer"><span class="hs-identifier hs-type">PendingJobFireTimer</span></a></span><span> </span><span id="local-6989586621680177892"><span class="annot"><span class="annottext">FireTimer
</span><a href="#local-6989586621680177892"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-565"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177893"><span class="annot"><span class="annottext">existingIVar :: Maybe (IVar ())
</span><a href="#local-6989586621680177893"><span class="hs-identifier hs-var hs-var">existingIVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Sequence -&gt; HashMap Sequence (IVar ()) -&gt; Maybe (IVar ())
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FireTimer
</span><a href="#local-6989586621680177892"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">FireTimer
-&gt; FoldLike Sequence FireTimer FireTimer Sequence Any -&gt; Sequence
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) FireTimer Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;seq&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.seq</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Sequence) FireTimer Word32
-&gt; ((Sequence -&gt; Constant Sequence Any)
    -&gt; Word32 -&gt; Constant Sequence Word32)
-&gt; FoldLike Sequence FireTimer FireTimer Sequence Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Sequence) -&gt; Getter Word32 Word32 Sequence Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Sequence
</span><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-var">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">timers</span><span>
</span><span id="line-566"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IVar ())
</span><a href="#local-6989586621680177893"><span class="hs-identifier hs-var">existingIVar</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-567"></span><span>              </span><span class="annot"><span class="annottext">Maybe (IVar ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a e. (?callStack::CallStack, Exception e) =&gt; e -&gt; a
</span><span class="hs-identifier hs-var">E.throw</span></span><span> </span><span class="annot"><span class="annottext">(RuntimeError -&gt; ([ActivationResult], SequenceMaps))
-&gt; RuntimeError -&gt; ([ActivationResult], SequenceMaps)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; RuntimeError
</span><a href="Temporal.Exception.html#RuntimeError"><span class="hs-identifier hs-var">RuntimeError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Timer not found&quot;</span></span><span>
</span><span id="line-568"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680177894"><span class="annot"><span class="annottext">IVar ()
</span><a href="#local-6989586621680177894"><span class="hs-identifier hs-var">existing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-569"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ResultVal () -&gt; IVar () -&gt; ActivationResult
forall a. ResultVal a -&gt; IVar a -&gt; ActivationResult
</span><a href="Temporal.Workflow.Eval.html#ActivationResult"><span class="hs-identifier hs-var">ActivationResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ResultVal ()
forall a. a -&gt; ResultVal a
</span><a href="Temporal.Workflow.Internal.Monad.html#Ok"><span class="hs-identifier hs-var">Ok</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IVar ()
</span><a href="#local-6989586621680177894"><span class="hs-identifier hs-var">existing</span></a></span><span> </span><span class="annot"><span class="annottext">ActivationResult -&gt; [ActivationResult] -&gt; [ActivationResult]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ActivationResult]
</span><a href="#local-6989586621680177784"><span class="hs-identifier hs-var">completions</span></a></span><span>
</span><span id="line-570"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SequenceMaps
</span><a href="#local-6989586621680177785"><span class="hs-identifier hs-var">sequenceMaps'</span></a></span><span>
</span><span id="line-571"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#timers"><span class="hs-identifier hs-var">timers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680177892"><span class="hs-identifier hs-type">msg</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.seq</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#Sequence"><span class="hs-identifier hs-type">Sequence</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier">sequenceMaps'</span></span><span class="hs-operator">.</span><span class="hs-identifier">timers</span><span>
</span><span id="line-572"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-573"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680177896"><span class="annot"><a href="#local-6989586621680177896"><span class="hs-identifier hs-var">newCompletions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680177897"><span class="annot"><a href="#local-6989586621680177897"><span class="hs-identifier hs-var">updatedSequenceMaps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">foldl'</span></span><span> </span><span class="annot"><a href="#local-6989586621680177783"><span class="hs-identifier hs-type">makeCompletion</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680177781"><span class="hs-identifier hs-type">sequenceMaps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680177779"><span class="hs-identifier hs-type">rs</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">writeTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">inst</span></span><span class="hs-operator">.</span><span class="hs-identifier">workflowSequenceMaps</span><span> </span><span class="annot"><a href="#local-6989586621680177897"><span class="hs-identifier hs-type">updatedSequenceMaps</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680177896"><span class="hs-identifier hs-type">newCompletions</span></a></span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#convertExitVariantToCommand"><span class="hs-identifier hs-type">convertExitVariantToCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitVariant"><span class="hs-identifier hs-type">WorkflowExitVariant</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.WorkflowCommand</span></span><span>
</span><span id="line-581"></span><span id="convertExitVariantToCommand"><span class="annot"><span class="annottext">convertExitVariantToCommand :: WorkflowExitVariant Payload -&gt; InstanceM WorkflowCommand
</span><a href="Temporal.WorkflowInstance.html#convertExitVariantToCommand"><span class="hs-identifier hs-var hs-var">convertExitVariantToCommand</span></a></span></span><span> </span><span id="local-6989586621680177900"><span class="annot"><span class="annottext">WorkflowExitVariant Payload
</span><a href="#local-6989586621680177900"><span class="hs-identifier hs-var">variant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621680177901"><span class="annot"><a href="#local-6989586621680177901"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680177902"><span class="annot"><a href="#local-6989586621680177902"><span class="hs-identifier hs-var hs-var">processor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177901"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">payloadProcessor</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680177900"><span class="hs-identifier hs-type">variant</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitSuccess"><span class="hs-identifier hs-type">WorkflowExitSuccess</span></a></span><span> </span><span id="local-6989586621680177904"><span class="annot"><span class="annottext">Payload
</span><a href="#local-6989586621680177904"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-586"></span><span>      </span><span id="local-6989586621680177905"><span class="annot"><a href="#local-6989586621680177905"><span class="hs-identifier hs-var">result'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Payload -&gt; InstanceM Payload
forall a. IO a -&gt; InstanceM a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Payload -&gt; InstanceM Payload)
-&gt; IO Payload -&gt; InstanceM Payload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor -&gt; Payload -&gt; IO Payload
</span><a href="Temporal.Payload.html#payloadProcessorEncode"><span class="hs-identifier hs-var">payloadProcessorEncode</span></a></span><span> </span><span class="annot"><span class="annottext">PayloadProcessor
</span><a href="#local-6989586621680177902"><span class="hs-identifier hs-var">processor</span></a></span><span> </span><span class="annot"><span class="annottext">Payload
</span><a href="#local-6989586621680177904"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-587"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-589"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.completeWorkflowExecution</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.result</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertToProtoPayload"><span class="hs-identifier hs-type">convertToProtoPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177905"><span class="hs-identifier hs-type">result'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitContinuedAsNew"><span class="hs-identifier hs-type">WorkflowExitContinuedAsNew</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Exception.html#ContinueAsNewException"><span class="hs-identifier hs-type">ContinueAsNewException</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680177922"><span id="local-6989586621680177923"><span id="local-6989586621680177924"><span class="annot"><span class="annottext">Vector Payload
WorkflowType
ContinueAsNewOptions
continueAsNewWorkflowType :: WorkflowType
continueAsNewArguments :: Vector Payload
continueAsNewOptions :: ContinueAsNewOptions
continueAsNewOptions :: ContinueAsNewException -&gt; ContinueAsNewOptions
continueAsNewArguments :: ContinueAsNewException -&gt; Vector Payload
continueAsNewWorkflowType :: ContinueAsNewException -&gt; WorkflowType
</span><a href="#local-6989586621680177922"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>      </span><span id="local-6989586621680177928"><span class="annot"><a href="#local-6989586621680177928"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Info -&gt; InstanceM Info
forall (m :: * -&gt; *) a. MonadIO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680177901"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workflowInstanceInfo</span><span>
</span><span id="line-592"></span><span>      </span><span id="local-6989586621680177929"><span class="annot"><a href="#local-6989586621680177929"><span class="hs-identifier hs-var">searchAttrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-593"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-594"></span><span>          </span><span class="annot"><a href="Temporal.SearchAttributes.Internal.html#searchAttributesToProto"><span class="hs-identifier hs-type">searchAttributesToProto</span></a></span><span>
</span><span id="line-595"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">searchAttributes</span><span> </span><span class="annot"><span class="hs-operator hs-type">==</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">mempty</span></span><span>
</span><span id="line-596"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="hs-identifier">i</span></span><span class="hs-operator">.</span><span class="hs-identifier">searchAttributes</span><span>
</span><span id="line-597"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">searchAttributes</span><span>
</span><span id="line-598"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>      </span><span id="local-6989586621680177931"><span class="annot"><a href="#local-6989586621680177931"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorEncodePayloads"><span class="hs-identifier hs-type">processorEncodePayloads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177902"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177923"><span class="hs-identifier hs-type">continueAsNewArguments</span></a></span><span>
</span><span id="line-600"></span><span>      </span><span id="local-6989586621680177933"><span class="annot"><a href="#local-6989586621680177933"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorEncodePayloads"><span class="hs-identifier hs-type">processorEncodePayloads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177902"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">headers</span><span>
</span><span id="line-601"></span><span>      </span><span id="local-6989586621680177934"><span class="annot"><a href="#local-6989586621680177934"><span class="hs-identifier hs-var">memo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorEncodePayloads"><span class="hs-identifier hs-type">processorEncodePayloads</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177902"><span class="hs-identifier hs-type">processor</span></a></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">memo</span><span>
</span><span id="line-602"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-603"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-604"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.continueAsNewWorkflowExecution</span></span><span>
</span><span id="line-605"></span><span>            </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-606"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.workflowType</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#rawWorkflowType"><span class="hs-identifier hs-var">rawWorkflowType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177922"><span class="hs-identifier hs-type">continueAsNewWorkflowType</span></a></span><span>
</span><span id="line-607"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.taskQueue</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">maybe</span></span><span> </span><span class="annot"><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#rawTaskQueue"><span class="hs-identifier hs-var">rawTaskQueue</span></a></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">taskQueue</span><span>
</span><span id="line-608"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.vec'arguments</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertToProtoPayload"><span class="hs-identifier hs-type">convertToProtoPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177931"><span class="hs-identifier hs-type">args</span></a></span><span>
</span><span id="line-609"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.maybe'retryPolicy</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Common.html#retryPolicyToProto"><span class="hs-identifier hs-type">retryPolicyToProto</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">retryPolicy</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.searchAttributes</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="#local-6989586621680177929"><span class="hs-identifier hs-type">searchAttrs</span></a></span><span>
</span><span id="line-611"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.headers</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertToProtoPayload"><span class="hs-identifier hs-type">convertToProtoPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177933"><span class="hs-identifier hs-type">hdrs</span></a></span><span>
</span><span id="line-612"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.memo</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertToProtoPayload"><span class="hs-identifier hs-type">convertToProtoPayload</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680177934"><span class="hs-identifier hs-type">memo</span></a></span><span>
</span><span id="line-613"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.maybe'workflowTaskTimeout</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Duration.html#durationToProto"><span class="hs-identifier hs-type">durationToProto</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">taskTimeout</span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.maybe'workflowRunTimeout</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Duration.html#durationToProto"><span class="hs-identifier hs-type">durationToProto</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier">continueAsNewOptions</span></span><span class="hs-operator">.</span><span class="hs-identifier">runTimeout</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitCancelled"><span class="hs-identifier hs-type">WorkflowExitCancelled</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowCancelRequested
</span><a href="Temporal.Exception.html#WorkflowCancelRequested"><span class="hs-identifier hs-var">WorkflowCancelRequested</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>      </span><span class="annot"><span class="annottext">WorkflowCommand -&gt; InstanceM WorkflowCommand
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowCommand -&gt; InstanceM WorkflowCommand)
-&gt; WorkflowCommand -&gt; InstanceM WorkflowCommand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowCommand
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">WorkflowCommand
-&gt; (WorkflowCommand -&gt; WorkflowCommand) -&gt; WorkflowCommand
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowCommand CancelWorkflowExecution
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowCommand CancelWorkflowExecution
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;cancelWorkflowExecution&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Command.cancelWorkflowExecution</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowCommand CancelWorkflowExecution)
-&gt; CancelWorkflowExecution -&gt; WorkflowCommand -&gt; WorkflowCommand
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">CancelWorkflowExecution
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-618"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitFailed"><span class="hs-identifier hs-type">WorkflowExitFailed</span></a></span><span> </span><span id="local-6989586621680178019"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178019"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680178020"><span class="annot"><span class="annottext">ActivityFailure
</span><a href="#local-6989586621680178020"><span class="hs-identifier hs-var">actFailure</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Exception.html#ActivityFailure"><span class="hs-identifier hs-type">ActivityFailure</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe ActivityFailure
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178019"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-619"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680178022"><span class="annot"><span class="annottext">appFailure :: ApplicationFailure
</span><a href="#local-6989586621680178022"><span class="hs-identifier hs-var hs-var">appFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ActivityFailure
</span><a href="#local-6989586621680178020"><span class="hs-identifier hs-var">actFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">cause</span><span>
</span><span id="line-620"></span><span>          </span><span id="local-6989586621680178023"><span class="annot"><span class="annottext">enrichedApplicationFailure :: Failure
</span><a href="#local-6989586621680178023"><span class="hs-identifier hs-var hs-var">enrichedApplicationFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-621"></span><span>            </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-622"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ActivityFailure
</span><a href="#local-6989586621680178020"><span class="hs-identifier hs-var">actFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">message</span><span>
</span><span id="line-623"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;source&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.source</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;hs-temporal-sdk&quot;</span></span><span>
</span><span id="line-624"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure ActivityFailureInfo
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f Failure ActivityFailureInfo
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;activityFailureInfo&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.activityFailureInfo</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f Failure ActivityFailureInfo)
-&gt; ActivityFailureInfo -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ActivityFailure
</span><a href="#local-6989586621680178020"><span class="hs-identifier hs-var">actFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">original</span><span>
</span><span id="line-625"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;stackTrace&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.stackTrace</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ActivityFailure
</span><a href="#local-6989586621680178020"><span class="hs-identifier hs-var">actFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">stack</span><span>
</span><span id="line-626"></span><span>              </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Failure
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;cause&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.cause</span></span><span>
</span><span id="line-627"></span><span>                </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure)
-&gt; Failure -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-628"></span><span>                      </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680178022"><span class="hs-identifier hs-var">appFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">message</span><span>
</span><span id="line-629"></span><span>                      </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;source&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.source</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;hs-temporal-sdk&quot;</span></span><span>
</span><span id="line-630"></span><span>                      </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;stackTrace&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.stackTrace</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680178022"><span class="hs-identifier hs-var">appFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">stack</span><span>
</span><span id="line-631"></span><span>                      </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure ApplicationFailureInfo
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f Failure ApplicationFailureInfo
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;applicationFailureInfo&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.applicationFailureInfo</span></span><span>
</span><span id="line-632"></span><span>                        </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f Failure ApplicationFailureInfo)
-&gt; ApplicationFailureInfo -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ApplicationFailureInfo
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-633"></span><span>                              </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;type'&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.type'</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Text)
-&gt; Text -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Text
</span><a href="Temporal.Exception.html#type%27"><span class="hs-identifier hs-var">Err.type'</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680178022"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-634"></span><span>                              </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Bool
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Bool
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;nonRetryable&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.nonRetryable</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Bool)
-&gt; Bool -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Bool
</span><a href="Temporal.Exception.html#nonRetryable"><span class="hs-identifier hs-var">Err.nonRetryable</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680178022"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-635"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>      </span><span class="annot"><span class="annottext">WorkflowCommand -&gt; InstanceM WorkflowCommand
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowCommand -&gt; InstanceM WorkflowCommand)
-&gt; WorkflowCommand -&gt; InstanceM WorkflowCommand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-638"></span><span>        </span><span class="annot"><span class="annottext">WorkflowCommand
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">WorkflowCommand
-&gt; (WorkflowCommand -&gt; WorkflowCommand) -&gt; WorkflowCommand
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowCommand FailWorkflowExecution
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowCommand FailWorkflowExecution
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failWorkflowExecution&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Command.failWorkflowExecution</span></span><span>
</span><span id="line-640"></span><span>            </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowCommand FailWorkflowExecution)
-&gt; FailWorkflowExecution -&gt; WorkflowCommand -&gt; WorkflowCommand
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">FailWorkflowExecution
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-641"></span><span>                  </span><span class="annot"><span class="annottext">FailWorkflowExecution
-&gt; (FailWorkflowExecution -&gt; FailWorkflowExecution)
-&gt; FailWorkflowExecution
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f FailWorkflowExecution Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f FailWorkflowExecution Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failure&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Command.failure</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f FailWorkflowExecution Failure)
-&gt; Failure -&gt; FailWorkflowExecution -&gt; FailWorkflowExecution
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680178023"><span class="hs-identifier hs-var">enrichedApplicationFailure</span></a></span><span>
</span><span id="line-642"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>    </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitFailed"><span class="hs-identifier hs-type">WorkflowExitFailed</span></a></span><span> </span><span id="local-6989586621680178109"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178109"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-644"></span><span>      </span><span id="local-6989586621680178110"><span class="annot"><a href="#local-6989586621680178110"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceM WorkflowInstance
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680178111"><span class="annot"><a href="#local-6989586621680178111"><span class="hs-identifier hs-var hs-var">appFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; [ApplicationFailureHandler] -&gt; ApplicationFailure
</span><a href="Temporal.Exception.html#mkApplicationFailure"><span class="hs-identifier hs-var">mkApplicationFailure</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178109"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178110"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">errorConverters</span><span>
</span><span id="line-646"></span><span>          </span><span id="local-6989586621680178112"><span class="annot"><a href="#local-6989586621680178112"><span class="hs-identifier hs-var hs-var">enrichedApplicationFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Failure
</span><a href="Temporal.Exception.html#applicationFailureToFailureProto"><span class="hs-identifier hs-var">applicationFailureToFailureProto</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680178111"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-647"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span>
</span><span id="line-648"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-649"></span><span>          </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.failWorkflowExecution</span></span><span>
</span><span id="line-650"></span><span>            </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">defMessage</span></span><span>
</span><span id="line-651"></span><span>                  </span><span class="annot"><span class="hs-operator hs-type">&amp;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Command.failure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.~</span></span><span> </span><span class="annot"><a href="#local-6989586621680178112"><span class="hs-identifier hs-type">enrichedApplicationFailure</span></a></span><span>
</span><span id="line-652"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span class="hs-comment">-- Note: this is intended to exclusively handle top-level workflow execution.</span><span>
</span><span id="line-656"></span><span class="hs-comment">--</span><span>
</span><span id="line-657"></span><span class="hs-comment">-- Don't use elsewhere.</span><span>
</span><span id="line-658"></span><span class="annot"><a href="Temporal.WorkflowInstance.html#runTopLevel"><span class="hs-identifier hs-type">runTopLevel</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#InstanceM"><span class="hs-identifier hs-type">InstanceM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitVariant"><span class="hs-identifier hs-type">WorkflowExitVariant</span></a></span><span> </span><span class="annot"><a href="Temporal.Payload.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span id="runTopLevel"><span class="annot"><span class="annottext">runTopLevel :: InstanceM Payload -&gt; InstanceM (WorkflowExitVariant Payload)
</span><a href="Temporal.WorkflowInstance.html#runTopLevel"><span class="hs-identifier hs-var hs-var">runTopLevel</span></a></span></span><span> </span><span id="local-6989586621680178123"><span class="annot"><span class="annottext">InstanceM Payload
</span><a href="#local-6989586621680178123"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-660"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Payload -&gt; WorkflowExitVariant Payload
forall a. a -&gt; WorkflowExitVariant a
</span><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitSuccess"><span class="hs-identifier hs-var">WorkflowExitSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">(Payload -&gt; WorkflowExitVariant Payload)
-&gt; InstanceM Payload -&gt; InstanceM (WorkflowExitVariant Payload)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">InstanceM Payload
</span><a href="#local-6989586621680178123"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><span class="annottext">InstanceM (WorkflowExitVariant Payload)
-&gt; [Handler InstanceM (WorkflowExitVariant Payload)]
-&gt; InstanceM (WorkflowExitVariant Payload)
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
m a -&gt; [Handler m a] -&gt; m a
</span><span class="hs-operator hs-var">`catches`</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(ContinueAsNewException -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall (m :: * -&gt; *) a e. Exception e =&gt; (e -&gt; m a) -&gt; Handler m a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="annot"><span class="annottext">((ContinueAsNewException
  -&gt; InstanceM (WorkflowExitVariant Payload))
 -&gt; Handler InstanceM (WorkflowExitVariant Payload))
-&gt; (ContinueAsNewException
    -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680178126"><span class="annot"><span class="annottext">e :: ContinueAsNewException
</span><a href="#local-6989586621680178126"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Exception.html#ContinueAsNewException"><span class="hs-identifier hs-type">ContinueAsNewException</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowExitVariant Payload
 -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ContinueAsNewException -&gt; WorkflowExitVariant Payload
forall a. ContinueAsNewException -&gt; WorkflowExitVariant a
</span><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitContinuedAsNew"><span class="hs-identifier hs-var">WorkflowExitContinuedAsNew</span></a></span><span> </span><span class="annot"><span class="annottext">ContinueAsNewException
</span><a href="#local-6989586621680178126"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-662"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(WorkflowCancelRequested
 -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall (m :: * -&gt; *) a e. Exception e =&gt; (e -&gt; m a) -&gt; Handler m a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="annot"><span class="annottext">((WorkflowCancelRequested
  -&gt; InstanceM (WorkflowExitVariant Payload))
 -&gt; Handler InstanceM (WorkflowExitVariant Payload))
-&gt; (WorkflowCancelRequested
    -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">WorkflowCancelRequested
</span><a href="Temporal.Exception.html#WorkflowCancelRequested"><span class="hs-identifier hs-var">WorkflowCancelRequested</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-663"></span><span>                  </span><span class="annot"><span class="annottext">WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowExitVariant Payload
 -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowCancelRequested -&gt; WorkflowExitVariant Payload
forall a. WorkflowCancelRequested -&gt; WorkflowExitVariant a
</span><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitCancelled"><span class="hs-identifier hs-var">WorkflowExitCancelled</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowCancelRequested
</span><a href="Temporal.Exception.html#WorkflowCancelRequested"><span class="hs-identifier hs-var">WorkflowCancelRequested</span></a></span><span>
</span><span id="line-664"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall (m :: * -&gt; *) a e. Exception e =&gt; (e -&gt; m a) -&gt; Handler m a
</span><span class="hs-identifier hs-var">Handler</span></span><span> </span><span class="annot"><span class="annottext">((SomeException -&gt; InstanceM (WorkflowExitVariant Payload))
 -&gt; Handler InstanceM (WorkflowExitVariant Payload))
-&gt; (SomeException -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; Handler InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680178127"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178127"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-665"></span><span>                  </span><span class="annot"><span class="annottext">WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a. a -&gt; InstanceM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(WorkflowExitVariant Payload
 -&gt; InstanceM (WorkflowExitVariant Payload))
-&gt; WorkflowExitVariant Payload
-&gt; InstanceM (WorkflowExitVariant Payload)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; WorkflowExitVariant Payload
forall a. SomeException -&gt; WorkflowExitVariant a
</span><a href="Temporal.Workflow.Internal.Monad.html#WorkflowExitFailed"><span class="hs-identifier hs-var">WorkflowExitFailed</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680178127"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-666"></span><span>              </span><span class="hs-special">]</span><span>
</span><span id="line-667"></span></pre></body></html>