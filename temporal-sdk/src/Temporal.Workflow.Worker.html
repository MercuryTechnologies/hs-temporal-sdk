<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html"><span class="hs-identifier">Temporal.Workflow.Worker</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception.Annotated</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ann</span></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadCatch</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Logger</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HashMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HashMap</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ProtoLens</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Family2</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">OpenTelemetry.Context.ThreadLocal</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">OpenTelemetry.Trace.Core</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">inSpan</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">inSpan'</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">OpenTelemetry.Trace.Monad</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Api.Common.V1.Message_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Message</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Api.Failure.V1.Message_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.Common.Common_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CommonProto</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowActivation.WorkflowActivation</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowActivation.WorkflowActivation_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Activation</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCompletion.WorkflowCompletion</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Completion</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Proto.Temporal.Sdk.Core.WorkflowCompletion.WorkflowCompletion_Fields</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Completion</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">RequireCallStack</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Common.html"><span class="hs-identifier">Temporal.Common</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Common.Async.html"><span class="hs-identifier">Temporal.Common.Async</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Temporal.Core.Client</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Temporal.Core.Worker</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">InactiveForReplay</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Temporal.Core.Worker</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Core</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Duration.html"><span class="hs-identifier">Temporal.Duration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Duration.html#durationFromProto"><span class="hs-identifier">durationFromProto</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Temporal.Exception.html"><span class="hs-identifier">Temporal.Exception</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Err</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Payload.html"><span class="hs-identifier">Temporal.Payload</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.SearchAttributes.Internal.html"><span class="hs-identifier">Temporal.SearchAttributes.Internal</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Definition.html"><span class="hs-identifier">Temporal.Workflow.Definition</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html"><span class="hs-identifier">Temporal.Workflow.Internal.Monad</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#try"><span class="hs-identifier">try</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html"><span class="hs-identifier">Temporal.WorkflowInstance</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">data</span><span> </span><span id="EvictionWithRunID"><span class="annot"><a href="Temporal.Workflow.Worker.html#EvictionWithRunID"><span class="hs-identifier hs-var">EvictionWithRunID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EvictionWithRunID"><span class="annot"><a href="Temporal.Workflow.Worker.html#EvictionWithRunID"><span class="hs-identifier hs-var">EvictionWithRunID</span></a></span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="runId"><span class="annot"><span class="annottext">EvictionWithRunID -&gt; RunId
</span><a href="Temporal.Workflow.Worker.html#runId"><span class="hs-identifier hs-var hs-var">runId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-type">RunId</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="eviction"><span class="annot"><span class="annottext">EvictionWithRunID -&gt; RemoveFromCache
</span><a href="Temporal.Workflow.Worker.html#eviction"><span class="hs-identifier hs-var hs-var">eviction</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RemoveFromCache</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680178559"><span id="local-6989586621680178567"><span id="local-6989586621680178571"><span class="annot"><span class="annottext">Int -&gt; EvictionWithRunID -&gt; ShowS
[EvictionWithRunID] -&gt; ShowS
EvictionWithRunID -&gt; String
(Int -&gt; EvictionWithRunID -&gt; ShowS)
-&gt; (EvictionWithRunID -&gt; String)
-&gt; ([EvictionWithRunID] -&gt; ShowS)
-&gt; Show EvictionWithRunID
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; EvictionWithRunID -&gt; ShowS
showsPrec :: Int -&gt; EvictionWithRunID -&gt; ShowS
$cshow :: EvictionWithRunID -&gt; String
show :: EvictionWithRunID -&gt; String
$cshowList :: [EvictionWithRunID] -&gt; ShowS
showList :: [EvictionWithRunID] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">data</span><span> </span><span id="WorkflowWorker"><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-var">WorkflowWorker</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680178575"><span class="annot"><a href="#local-6989586621680178575"><span class="hs-identifier hs-type">ty</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Core.KnownWorkerType</span></span><span> </span><span class="annot"><a href="#local-6989586621680178575"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span id="WorkflowWorker"><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-var">WorkflowWorker</span></a></span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="workerWorkflowFunctions"><span class="annot"><span class="annottext">WorkflowWorker -&gt; HashMap Text WorkflowDefinition
</span><a href="Temporal.Workflow.Worker.html#workerWorkflowFunctions"><span class="hs-identifier hs-var hs-var">workerWorkflowFunctions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Definition.html#WorkflowDefinition"><span class="hs-identifier hs-type">WorkflowDefinition</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="runningWorkflows"><span class="annot"><span class="annottext">WorkflowWorker -&gt; TVar (HashMap RunId WorkflowInstance)
</span><a href="Temporal.Workflow.Worker.html#runningWorkflows"><span class="hs-identifier hs-var hs-var">runningWorkflows</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMap</span></span><span> </span><span class="annot"><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-type">RunId</span></a></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerClient"><span class="annot"><span class="annottext">()
</span><a href="Temporal.Workflow.Worker.html#workerClient"><span class="hs-identifier hs-var hs-var">workerClient</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InactiveForReplay</span></span><span> </span><span class="annot"><a href="#local-6989586621680178575"><span class="hs-identifier hs-type">ty</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Client</span></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerCore"><span class="annot"><span class="annottext">()
</span><a href="Temporal.Workflow.Worker.html#workerCore"><span class="hs-identifier hs-var hs-var">workerCore</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.Worker</span></span><span> </span><span class="annot"><a href="#local-6989586621680178575"><span class="hs-identifier hs-type">ty</span></a></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerInboundInterceptors"><span class="annot"><span class="annottext">WorkflowWorker -&gt; WorkflowInboundInterceptor
</span><a href="Temporal.Workflow.Worker.html#workerInboundInterceptors"><span class="hs-identifier hs-var hs-var">workerInboundInterceptors</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInboundInterceptor"><span class="hs-identifier hs-type">WorkflowInboundInterceptor</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerOutboundInterceptors"><span class="annot"><span class="annottext">WorkflowWorker -&gt; WorkflowOutboundInterceptor
</span><a href="Temporal.Workflow.Worker.html#workerOutboundInterceptors"><span class="hs-identifier hs-var hs-var">workerOutboundInterceptors</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowOutboundInterceptor"><span class="hs-identifier hs-type">WorkflowOutboundInterceptor</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerDeadlockTimeout"><span class="annot"><span class="annottext">WorkflowWorker -&gt; Maybe Int
</span><a href="Temporal.Workflow.Worker.html#workerDeadlockTimeout"><span class="hs-identifier hs-var hs-var">workerDeadlockTimeout</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerTaskQueue"><span class="annot"><span class="annottext">WorkflowWorker -&gt; TaskQueue
</span><a href="Temporal.Workflow.Worker.html#workerTaskQueue"><span class="hs-identifier hs-var hs-var">workerTaskQueue</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Temporal.Common.html#TaskQueue"><span class="hs-identifier hs-type">TaskQueue</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerErrorConverters"><span class="annot"><span class="annottext">WorkflowWorker -&gt; [ApplicationFailureHandler]
</span><a href="Temporal.Workflow.Worker.html#workerErrorConverters"><span class="hs-identifier hs-var hs-var">workerErrorConverters</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Temporal.Exception.html#ApplicationFailureHandler"><span class="hs-identifier hs-type">Err.ApplicationFailureHandler</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="processor"><span class="annot"><span class="annottext">WorkflowWorker -&gt; PayloadProcessor
</span><a href="Temporal.Workflow.Worker.html#processor"><span class="hs-identifier hs-var hs-var">processor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Temporal.Payload.html#PayloadProcessor"><span class="hs-identifier hs-type">PayloadProcessor</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="workerEvictionEmitter"><span class="annot"><span class="annottext">WorkflowWorker -&gt; TChan EvictionWithRunID
</span><a href="Temporal.Workflow.Worker.html#workerEvictionEmitter"><span class="hs-identifier hs-var hs-var">workerEvictionEmitter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TChan</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#EvictionWithRunID"><span class="hs-identifier hs-type">EvictionWithRunID</span></a></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621680178173"><span class="annot"><a href="Temporal.Workflow.Worker.html#pollWorkflowActivation"><span class="hs-identifier hs-type">pollWorkflowActivation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadLoggerIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178173"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178173"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.WorkerError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.WorkflowActivation</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-69"></span><span id="pollWorkflowActivation"><span class="annot"><span class="annottext">pollWorkflowActivation :: forall (m :: * -&gt; *).
MonadLoggerIO m =&gt;
ReaderT WorkflowWorker m (Either WorkerError WorkflowActivation)
</span><a href="Temporal.Workflow.Worker.html#pollWorkflowActivation"><span class="hs-identifier hs-var hs-var">pollWorkflowActivation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680178614"><span class="annot"><a href="Temporal.Workflow.Worker.html#workerCore"><span class="hs-identifier hs-var hs-var">workerCore</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m WorkflowWorker
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.pollWorkflowActivation</span></span><span> </span><span class="annot"><a href="#local-6989586621680178614"><span class="hs-identifier hs-type">workerCore</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span id="local-6989586621680178202"><span class="annot"><a href="Temporal.Workflow.Worker.html#upsertWorkflowInstance"><span class="hs-identifier hs-type">upsertWorkflowInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadLoggerIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178202"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-type">RunId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178202"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span></span><span>
</span><span id="line-75"></span><span id="upsertWorkflowInstance"><span class="annot"><span class="annottext">upsertWorkflowInstance :: forall (m :: * -&gt; *).
MonadLoggerIO m =&gt;
RunId
-&gt; WorkflowInstance -&gt; ReaderT WorkflowWorker m WorkflowInstance
</span><a href="Temporal.Workflow.Worker.html#upsertWorkflowInstance"><span class="hs-identifier hs-var hs-var">upsertWorkflowInstance</span></a></span></span><span> </span><span id="local-6989586621680178644"><span class="annot"><span class="annottext">RunId
</span><a href="#local-6989586621680178644"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621680178645"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178645"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>  </span><span id="local-6989586621680178646"><span class="annot"><a href="#local-6989586621680178646"><span class="hs-identifier hs-var">worker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m WorkflowWorker
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621680178648"><span class="annot"><a href="#local-6989586621680178648"><span class="hs-identifier hs-var">workflows</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.lookup</span></span><span> </span><span class="annot"><a href="#local-6989586621680178644"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178648"><span class="hs-identifier hs-type">workflows</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-80"></span><span>      </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680178651"><span class="annot"><span class="annottext">workflows' :: HashMap RunId WorkflowInstance
</span><a href="#local-6989586621680178651"><span class="hs-identifier hs-var hs-var hs-var">workflows'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunId
-&gt; WorkflowInstance
-&gt; HashMap RunId WorkflowInstance
-&gt; HashMap RunId WorkflowInstance
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.insert</span></span><span> </span><span class="annot"><span class="annottext">RunId
</span><a href="#local-6989586621680178644"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178645"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap RunId WorkflowInstance
</span><a href="#local-6989586621680178648"><span class="hs-identifier hs-var">workflows</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><span class="annottext">TVar (HashMap RunId WorkflowInstance)
-&gt; HashMap RunId WorkflowInstance -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680178646"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span> </span><span class="annot"><span class="annottext">HashMap RunId WorkflowInstance
</span><a href="#local-6989586621680178651"><span class="hs-identifier hs-var">workflows'</span></a></span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">WorkflowInstance -&gt; STM WorkflowInstance
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178645"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680178654"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178654"><span class="hs-identifier hs-var">existingInstance</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>        </span><span class="annot"><span class="annottext">TVar (HashMap RunId WorkflowInstance)
-&gt; HashMap RunId WorkflowInstance -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680178646"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span> </span><span class="annot"><span class="annottext">HashMap RunId WorkflowInstance
</span><a href="#local-6989586621680178648"><span class="hs-identifier hs-var">workflows</span></a></span><span>
</span><span id="line-86"></span><span>        </span><span class="annot"><span class="annottext">WorkflowInstance -&gt; STM WorkflowInstance
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178654"><span class="hs-identifier hs-var">existingInstance</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="annot"><span class="hs-comment">-- | Execute an action repeatedly as long as it returns True.</span></span><span>
</span><span id="line-90"></span><span id="local-6989586621680178216"><span class="annot"><a href="Temporal.Workflow.Worker.html#whileM_"><span class="hs-identifier hs-type">whileM_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680178216"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680178216"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680178216"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-91"></span><span id="whileM_"><span class="annot"><span class="annottext">whileM_ :: forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m ()
</span><a href="Temporal.Workflow.Worker.html#whileM_"><span class="hs-identifier hs-var hs-var">whileM_</span></a></span></span><span> </span><span id="local-6989586621680178661"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621680178661"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621680178662"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621680178662"><span class="annot"><span class="annottext">go :: m ()
</span><a href="#local-6989586621680178662"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>      </span><span id="local-6989586621680178663"><span class="annot"><a href="#local-6989586621680178663"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621680178661"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">when</span></span><span> </span><span class="annot"><a href="#local-6989586621680178663"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178662"><span class="hs-identifier hs-type">go</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><span class="hs-comment">{- | Execute this worker until poller shutdown or failure. If there is a failure, this may
need to be called a second time after shutdown initiated to ensure workflow activations
are drained.

The Async handle only completes successfully on poller shutdown.
-}</span></span><span>
</span><span id="line-104"></span><span id="local-6989586621680178220"><span class="annot"><a href="Temporal.Workflow.Worker.html#execute"><span class="hs-identifier hs-type">execute</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadLoggerIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621680178220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680178220"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequireCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680178220"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-105"></span><span id="execute"><span class="annot"><span class="annottext">execute :: forall (m :: * -&gt; *).
(MonadLoggerIO m, MonadUnliftIO m, MonadCatch m, MonadTracer m,
 RequireCallStack) =&gt;
WorkflowWorker -&gt; m ()
</span><a href="Temporal.Workflow.Worker.html#execute"><span class="hs-identifier hs-var hs-var">execute</span></a></span></span><span> </span><span id="local-6989586621680178677"><span class="annot"><span class="annottext">worker :: WorkflowWorker
</span><a href="#local-6989586621680178677"><span class="hs-identifier hs-var">worker</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680178753"><span class="annot"><span class="annottext">Worker ty
workerCore :: ()
workerCore :: Worker ty
</span><a href="Temporal.Workflow.Worker.html#workerCore"><span class="hs-identifier hs-var hs-var">workerCore</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT WorkflowWorker m () -&gt; WorkflowWorker -&gt; m ())
-&gt; WorkflowWorker -&gt; ReaderT WorkflowWorker m () -&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m () -&gt; WorkflowWorker -&gt; m ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680178677"><span class="hs-identifier hs-var">worker</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT WorkflowWorker m () -&gt; m ())
-&gt; ReaderT WorkflowWorker m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Starting workflow worker&quot;</span></span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m Bool -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m ()
</span><a href="Temporal.Workflow.Worker.html#whileM_"><span class="hs-identifier hs-var">whileM_</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m Bool
</span><a href="#local-6989586621680178763"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621680178764"><span class="annot"><span class="annottext">c :: WorkerConfig
</span><a href="#local-6989586621680178764"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Worker ty -&gt; WorkerConfig
forall (ty :: WorkerType). Worker ty -&gt; WorkerConfig
</span><span class="hs-identifier hs-var">Core.getWorkerConfig</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
</span><a href="#local-6989586621680178753"><span class="hs-identifier hs-var">workerCore</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621680178763"><span class="annot"><span class="annottext">go :: ReaderT WorkflowWorker m Bool
</span><a href="#local-6989586621680178763"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; SpanArguments
-&gt; (Span -&gt; ReaderT WorkflowWorker m Bool)
-&gt; ReaderT WorkflowWorker m Bool
forall (m :: * -&gt; *) a.
(MonadUnliftIO m, MonadTracer m, HasCallStack) =&gt;
Text -&gt; SpanArguments -&gt; (Span -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">inSpan'</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Workflow activation step&quot;</span></span><span> </span><span class="annot"><span class="annottext">SpanArguments
</span><span class="hs-identifier hs-var">defaultSpanArguments</span></span><span> </span><span class="annot"><span class="annottext">((Span -&gt; ReaderT WorkflowWorker m Bool)
 -&gt; ReaderT WorkflowWorker m Bool)
-&gt; (Span -&gt; ReaderT WorkflowWorker m Bool)
-&gt; ReaderT WorkflowWorker m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680178768"><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680178768"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- logs &lt;- liftIO $ fetchLogs globalRuntime</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-comment">-- forM_ logs $ \l -&gt; case l.level of</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-comment">--   Trace -&gt; $(logDebug) l.message</span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-comment">--   Debug -&gt; $(logDebug) l.message</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">--   Temporal.Runtime.Info -&gt; $(logInfo) l.message</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-comment">--   Warn -&gt; $(logWarn) l.message</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-comment">--   Error -&gt; $(logError) l.message</span><span>
</span><span id="line-118"></span><span>      </span><span id="local-6989586621680178769"><span class="annot"><a href="#local-6989586621680178769"><span class="hs-identifier hs-var">eActivation</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m (Either WorkerError WorkflowActivation)
forall (m :: * -&gt; *).
MonadLoggerIO m =&gt;
ReaderT WorkflowWorker m (Either WorkerError WorkflowActivation)
</span><a href="Temporal.Workflow.Worker.html#pollWorkflowActivation"><span class="hs-identifier hs-var">pollWorkflowActivation</span></a></span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680178769"><span class="hs-identifier hs-type">eActivation</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-comment">-- TODO should we do anything else on shutdown?</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Core.WorkerError</span></span><span> </span><span class="annot"><span class="annottext">WorkerErrorCode
</span><span class="hs-identifier hs-var">Core.PollShutdown</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>          </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Poller shutting down&quot;</span></span><span>
</span><span id="line-123"></span><span>          </span><span id="local-6989586621680178772"><span class="annot"><a href="#local-6989586621680178772"><span class="hs-identifier hs-var">runningWorkflows</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap RunId WorkflowInstance)
-&gt; ReaderT WorkflowWorker m (HashMap RunId WorkflowInstance)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680178677"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">cancel</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">readIORef</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#executionThread"><span class="hs-identifier hs-var">executionThread</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680178772"><span class="hs-identifier hs-type">runningWorkflows</span></a></span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680178779"><span class="annot"><span class="annottext">WorkerError
</span><a href="#local-6989586621680178779"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>          </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logError</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ReaderT WorkflowWorker m ())
-&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkerError -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">WorkerError
</span><a href="#local-6989586621680178779"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">Span
-&gt; HashMap Text Attribute
-&gt; Maybe Timestamp
-&gt; WorkerError
-&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) e.
(MonadIO m, Exception e) =&gt;
Span -&gt; HashMap Text Attribute -&gt; Maybe Timestamp -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">recordException</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680178768"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Text Attribute
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Maybe Timestamp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">WorkerError
</span><a href="#local-6989586621680178779"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; ReaderT WorkflowWorker m Bool
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680178784"><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178784"><span class="hs-identifier hs-var">activation</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>          </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ReaderT WorkflowWorker m ())
-&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Got activation &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178784"><span class="hs-identifier hs-var">activation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>          </span><span class="hs-comment">-- We want to handle activations as fast as possible, so we don't want to block</span><span>
</span><span id="line-133"></span><span>          </span><span class="hs-comment">-- on dispatching jobs. We link the activator thread to the run-loop so that any</span><span>
</span><span id="line-134"></span><span>          </span><span class="hs-comment">-- unhandled exceptions in that logic aren't ignored.</span><span>
</span><span id="line-135"></span><span>          </span><span id="local-6989586621680178785"><span class="annot"><a href="#local-6989586621680178785"><span class="hs-identifier hs-var">activationCtxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m Context
forall (m :: * -&gt; *). MonadIO m =&gt; m Context
</span><span class="hs-identifier hs-var">getContext</span></span><span>
</span><span id="line-136"></span><span>          </span><span id="local-6989586621680178787"><span class="annot"><a href="#local-6989586621680178787"><span class="hs-identifier hs-var">activator</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Common.Async.html#asyncLabelled"><span class="hs-identifier hs-type">asyncLabelled</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text.unpack</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text.concat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;temporal/worker/workflow/activate&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Core.namespace</span></span><span> </span><span class="annot"><a href="#local-6989586621680178764"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;/&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">Core.taskQueue</span></span><span> </span><span class="annot"><a href="#local-6989586621680178764"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>            </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">attachContext</span></span><span> </span><span class="annot"><a href="#local-6989586621680178785"><span class="hs-identifier hs-type">activationCtxt</span></a></span><span>
</span><span id="line-138"></span><span>            </span><span class="annot"><a href="Temporal.Workflow.Worker.html#handleActivation"><span class="hs-identifier hs-type">handleActivation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178784"><span class="hs-identifier hs-type">activation</span></a></span><span>
</span><span id="line-139"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">link</span></span><span> </span><span class="annot"><a href="#local-6989586621680178787"><span class="hs-identifier hs-type">activator</span></a></span><span>
</span><span id="line-140"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="annot"><a href="Temporal.Workflow.Worker.html#handleActivation"><span class="hs-identifier hs-type">handleActivation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680178296"><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadUnliftIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLoggerIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTracer</span></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Core.WorkflowActivation</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span id="handleActivation"><span class="annot"><span class="annottext">handleActivation :: forall (m :: * -&gt; *).
(MonadUnliftIO m, MonadLoggerIO m, MonadCatch m, MonadTracer m) =&gt;
WorkflowActivation -&gt; ReaderT WorkflowWorker m ()
</span><a href="Temporal.Workflow.Worker.html#handleActivation"><span class="hs-identifier hs-var hs-var">handleActivation</span></a></span></span><span> </span><span id="local-6989586621680178938"><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; SpanArguments
-&gt; (Span -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a.
(MonadUnliftIO m, MonadTracer m, HasCallStack) =&gt;
Text -&gt; SpanArguments -&gt; (Span -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">inSpan'</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;handleActivation&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpanArguments
</span><span class="hs-identifier hs-var">defaultSpanArguments</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">attributes</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;temporal.activation.run_id&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">toAttribute</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680178938"><span class="hs-identifier hs-type">activation</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.runId</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Span -&gt; ReaderT WorkflowWorker m ())
 -&gt; ReaderT WorkflowWorker m ())
-&gt; (Span -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680178944"><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680178944"><span class="hs-identifier hs-var">_s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Handling activation: RunId &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">[WorkflowActivationJob]
-&gt; (WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     [WorkflowActivationJob]
     WorkflowActivation
     WorkflowActivation
     [WorkflowActivationJob]
     [WorkflowActivationJob]
-&gt; [WorkflowActivationJob]
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  [WorkflowActivationJob]
  WorkflowActivation
  WorkflowActivation
  [WorkflowActivationJob]
  [WorkflowActivationJob]
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.jobs</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
 -&gt; ReaderT WorkflowWorker m ())
-&gt; (WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680178947"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680178947"><span class="hs-identifier hs-var">job</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Job: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivationJob -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680178947"><span class="hs-identifier hs-var">job</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680178980"><span class="annot"><a href="Temporal.Workflow.Worker.html#workerCore"><span class="hs-identifier hs-var hs-var">workerCore</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m WorkflowWorker
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-comment">{-
  Run jobs
  -}</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><a href="#local-6989586621680178981"><span class="hs-identifier hs-type">shouldRun</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>      </span><span id="local-6989586621680178982"><span class="annot"><a href="#local-6989586621680178982"><span class="hs-identifier hs-var">mInst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="#local-6989586621680178983"><span class="hs-identifier hs-type">createOrFetchWorkflowInstance</span></a></span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">forM_</span></span><span> </span><span class="annot"><a href="#local-6989586621680178982"><span class="hs-identifier hs-type">mInst</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680178984"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178984"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680178985"><span class="annot"><span class="annottext">withoutStart :: [WorkflowActivationJob]
</span><a href="#local-6989586621680178985"><span class="hs-identifier hs-var hs-var">withoutStart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WorkflowActivationJob -&gt; Bool)
-&gt; [WorkflowActivationJob] -&gt; [WorkflowActivationJob]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680178986"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680178986"><span class="hs-identifier hs-var">job</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe StartWorkflow -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680178986"><span class="hs-identifier hs-var">job</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
-&gt; FoldLike
     (Maybe StartWorkflow)
     WorkflowActivationJob
     WorkflowActivationJob
     (Maybe StartWorkflow)
     (Maybe StartWorkflow)
-&gt; Maybe StartWorkflow
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe StartWorkflow)
  WorkflowActivationJob
  WorkflowActivationJob
  (Maybe StartWorkflow)
  (Maybe StartWorkflow)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'startWorkflow&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'startWorkflow</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     [WorkflowActivationJob]
     WorkflowActivation
     WorkflowActivation
     [WorkflowActivationJob]
     [WorkflowActivationJob]
-&gt; [WorkflowActivationJob]
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  [WorkflowActivationJob]
  WorkflowActivation
  WorkflowActivation
  [WorkflowActivationJob]
  [WorkflowActivationJob]
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.jobs</span></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[WorkflowActivationJob]
</span><a href="#local-6989586621680178985"><span class="hs-identifier hs-var">withoutStart</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-158"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ReaderT WorkflowWorker m ()
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>          </span><span id="local-6989586621680178989"><span class="annot"><span class="annottext">[WorkflowActivationJob]
</span><a href="#local-6989586621680178989"><span class="hs-identifier hs-var">otherJobs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM () -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; ReaderT WorkflowWorker m ())
-&gt; STM () -&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue WorkflowActivation -&gt; WorkflowActivation -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680178984"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">activationChannel</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; (WorkflowActivation -&gt; WorkflowActivation) -&gt; WorkflowActivation
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivation [WorkflowActivationJob]
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivation [WorkflowActivationJob]
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.jobs</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivation [WorkflowActivationJob])
-&gt; [WorkflowActivationJob]
-&gt; WorkflowActivation
-&gt; WorkflowActivation
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">[WorkflowActivationJob]
</span><a href="#local-6989586621680178989"><span class="hs-identifier hs-var">otherJobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;Workflow does not need to run.&quot;</span></span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179000"><span class="annot"><a href="#local-6989586621680179000"><span class="hs-identifier hs-var hs-var">completionMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-164"></span><span>              </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.runId</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Text)
-&gt; Text
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span>
</span><span id="line-165"></span><span>              </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Success
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Success
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;successful&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.successful</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Success)
-&gt; Success
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Success
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-166"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Core.completeWorkflowActivation</span></span><span> </span><span class="annot"><a href="#local-6989586621680178980"><span class="hs-identifier hs-type">workerCore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179000"><span class="hs-identifier hs-type">completionMessage</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">throwIO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="#local-6989586621680179019"><span class="hs-identifier hs-type">removeEvictedWorkflowInstances</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><a href="#local-6989586621680178981"><span class="hs-identifier hs-type">shouldRun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621680178981"><span class="annot"><span class="annottext">shouldRun :: Bool
</span><a href="#local-6989586621680178981"><span class="hs-identifier hs-var hs-var">shouldRun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680179020"><span class="hs-identifier hs-var">moreThanOneJob</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680179023"><span class="hs-identifier hs-var">removeFromCacheJob</span></a></span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>        </span><span id="local-6989586621680179024"><span class="annot"><span class="annottext">jobs :: Vector WorkflowActivationJob
</span><a href="#local-6989586621680179024"><span class="hs-identifier hs-var hs-var">jobs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     (Vector WorkflowActivationJob)
     WorkflowActivation
     WorkflowActivation
     (Vector WorkflowActivationJob)
     (Vector WorkflowActivationJob)
-&gt; Vector WorkflowActivationJob
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector WorkflowActivationJob)
  WorkflowActivation
  WorkflowActivation
  (Vector WorkflowActivationJob)
  (Vector WorkflowActivationJob)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.vec'jobs</span></span><span>
</span><span id="line-174"></span><span>        </span><span id="local-6989586621680179023"><span class="annot"><span class="annottext">removeFromCacheJob :: Bool
</span><a href="#local-6989586621680179023"><span class="hs-identifier hs-var hs-var">removeFromCacheJob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WorkflowActivationJob -&gt; Bool)
-&gt; Vector WorkflowActivationJob -&gt; Bool
forall a. (a -&gt; Bool) -&gt; Vector a -&gt; Bool
</span><span class="hs-identifier hs-var">V.any</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680179027"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179027"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe RemoveFromCache -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179027"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
-&gt; FoldLike
     (Maybe RemoveFromCache)
     WorkflowActivationJob
     WorkflowActivationJob
     (Maybe RemoveFromCache)
     (Maybe RemoveFromCache)
-&gt; Maybe RemoveFromCache
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe RemoveFromCache)
  WorkflowActivationJob
  WorkflowActivationJob
  (Maybe RemoveFromCache)
  (Maybe RemoveFromCache)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'removeFromCache&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'removeFromCache</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
</span><a href="#local-6989586621680179024"><span class="hs-identifier hs-var">jobs</span></a></span><span>
</span><span id="line-175"></span><span>        </span><span id="local-6989586621680179020"><span class="annot"><span class="annottext">moreThanOneJob :: Bool
</span><a href="#local-6989586621680179020"><span class="hs-identifier hs-var hs-var">moreThanOneJob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob -&gt; Int
forall a. Vector a -&gt; Int
</span><span class="hs-identifier hs-var">V.length</span></span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
</span><a href="#local-6989586621680179024"><span class="hs-identifier hs-var">jobs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="#local-6989586621680179032"><span class="hs-identifier hs-type">activationStartWorkflowJobs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Vector</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StartWorkflow</span></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621680179032"><span class="annot"><span class="annottext">activationStartWorkflowJobs :: Vector (WorkflowActivationJob, StartWorkflow)
</span><a href="#local-6989586621680179032"><span class="hs-identifier hs-var hs-var">activationStartWorkflowJobs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>      </span><span class="annot"><span class="annottext">(WorkflowActivationJob
 -&gt; Maybe (WorkflowActivationJob, StartWorkflow))
-&gt; Vector WorkflowActivationJob
-&gt; Vector (WorkflowActivationJob, StartWorkflow)
forall a b. (a -&gt; Maybe b) -&gt; Vector a -&gt; Vector b
</span><span class="hs-identifier hs-var">V.mapMaybe</span></span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680179034"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179034"><span class="hs-identifier hs-var">rawJob</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-181"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179034"><span class="hs-identifier hs-var">rawJob</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
-&gt; FoldLike
     (Maybe WorkflowActivationJob'Variant)
     WorkflowActivationJob
     WorkflowActivationJob
     (Maybe WorkflowActivationJob'Variant)
     (Maybe WorkflowActivationJob'Variant)
-&gt; Maybe WorkflowActivationJob'Variant
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe WorkflowActivationJob'Variant)
  WorkflowActivationJob
  WorkflowActivationJob
  (Maybe WorkflowActivationJob'Variant)
  (Maybe WorkflowActivationJob'Variant)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'variant&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'variant</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-182"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'StartWorkflow</span></span><span> </span><span id="local-6989586621680179037"><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179037"><span class="hs-identifier hs-var">startWorkflow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(WorkflowActivationJob, StartWorkflow)
-&gt; Maybe (WorkflowActivationJob, StartWorkflow)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179034"><span class="hs-identifier hs-var">rawJob</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179037"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>              </span><span class="annot"><span class="annottext">Maybe WorkflowActivationJob'Variant
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (WorkflowActivationJob, StartWorkflow)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-184"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     (Vector WorkflowActivationJob)
     WorkflowActivation
     WorkflowActivation
     (Vector WorkflowActivationJob)
     (Vector WorkflowActivationJob)
-&gt; Vector WorkflowActivationJob
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector WorkflowActivationJob)
  WorkflowActivation
  WorkflowActivation
  (Vector WorkflowActivationJob)
  (Vector WorkflowActivationJob)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.vec'jobs</span></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="#local-6989586621680178983"><span class="hs-identifier hs-type">createOrFetchWorkflowInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Internal.Monad.html#WorkflowInstance"><span class="hs-identifier hs-type">WorkflowInstance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621680178983"><span class="annot"><span class="annottext">createOrFetchWorkflowInstance :: ReaderT WorkflowWorker m (Maybe WorkflowInstance)
</span><a href="#local-6989586621680178983"><span class="hs-identifier hs-var hs-var">createOrFetchWorkflowInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; SpanArguments
-&gt; (Span -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall (m :: * -&gt; *) a.
(MonadUnliftIO m, MonadTracer m, HasCallStack) =&gt;
Text -&gt; SpanArguments -&gt; (Span -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">inSpan'</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;createOrFetchWorkflowInstance&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpanArguments
</span><span class="hs-identifier hs-var">defaultSpanArguments</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">attributes</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;temporal.activation.run_id&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">toAttribute</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680178938"><span class="hs-identifier hs-type">activation</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.runId</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Span -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
 -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; (Span -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680179038"><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179038"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>      </span><span id="local-6989586621680179039"><span class="annot"><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680179237"><span class="annot"><a href="Temporal.Workflow.Worker.html#workerCore"><span class="hs-identifier hs-var hs-var">workerCore</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m WorkflowWorker
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-190"></span><span>      </span><span id="local-6989586621680179238"><span class="annot"><a href="#local-6989586621680179238"><span class="hs-identifier hs-var">runningWorkflows_</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-type">RunId</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680178938"><span class="hs-identifier hs-type">activation</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.runId</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680179238"><span class="hs-identifier hs-type">runningWorkflows_</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680179240"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680179240"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><span class="annottext">Span -&gt; Text -&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToAttribute a) =&gt;
Span -&gt; Text -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">addAttribute</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179038"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;temporal.workflow.worker.instance_state&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;existing&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>          </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe WorkflowInstance
 -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; Maybe WorkflowInstance
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance -&gt; Maybe WorkflowInstance
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680179240"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>          </span><span class="annot"><span class="annottext">Span -&gt; Text -&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToAttribute a) =&gt;
Span -&gt; Text -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">addAttribute</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179038"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;temporal.workflow.worker.instance_state&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;new&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>          </span><span id="local-6989586621680179242"><span class="annot"><a href="#local-6989586621680179242"><span class="hs-identifier hs-var">vExistingInstance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Vector (WorkflowActivationJob, StartWorkflow)
-&gt; ((WorkflowActivationJob, StartWorkflow)
    -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; ReaderT WorkflowWorker m (Vector (Maybe WorkflowInstance))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Vector (WorkflowActivationJob, StartWorkflow)
</span><a href="#local-6989586621680179032"><span class="hs-identifier hs-var">activationStartWorkflowJobs</span></a></span><span> </span><span class="annot"><span class="annottext">(((WorkflowActivationJob, StartWorkflow)
  -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
 -&gt; ReaderT WorkflowWorker m (Vector (Maybe WorkflowInstance)))
-&gt; ((WorkflowActivationJob, StartWorkflow)
    -&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance))
-&gt; ReaderT WorkflowWorker m (Vector (Maybe WorkflowInstance))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680179244"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179244"><span class="hs-identifier hs-var">_job</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680179245"><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>            </span><span class="annot"><span class="annottext">Span -&gt; Text -&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a.
(MonadIO m, ToAttribute a) =&gt;
Span -&gt; Text -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">addAttribute</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179038"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;temporal.workflow.type&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike Text StartWorkflow StartWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text StartWorkflow StartWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowType&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowType</span></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>            </span><span id="local-6989586621680179247"><span class="annot"><a href="#local-6989586621680179247"><span class="hs-identifier hs-var">ePayloads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT
  WorkflowWorker
  m
  (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
   Map Text Payload)
-&gt; ReaderT
     WorkflowWorker
     m
     (Either
        SomeException
        (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
         Map Text Payload))
forall e (m :: * -&gt; *) a.
(Exception e, MonadCatch m) =&gt;
m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">Ann.try</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   WorkflowWorker
   m
   (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
    Map Text Payload)
 -&gt; ReaderT
      WorkflowWorker
      m
      (Either
         SomeException
         (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
          Map Text Payload)))
-&gt; ReaderT
     WorkflowWorker
     m
     (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
      Map Text Payload)
-&gt; ReaderT
     WorkflowWorker
     m
     (Either
        SomeException
        (Map SearchAttributeKey SearchAttributeType, Map Text Payload,
         Map Text Payload))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>              </span><span id="local-6989586621680179249"><span class="annot"><a href="#local-6989586621680179249"><span class="hs-identifier hs-var">searchAttrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Map SearchAttributeKey SearchAttributeType)
-&gt; ReaderT
     WorkflowWorker m (Map SearchAttributeKey SearchAttributeType)
forall a. IO a -&gt; ReaderT WorkflowWorker m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Map SearchAttributeKey SearchAttributeType)
 -&gt; ReaderT
      WorkflowWorker m (Map SearchAttributeKey SearchAttributeType))
-&gt; IO (Map SearchAttributeKey SearchAttributeType)
-&gt; ReaderT
     WorkflowWorker m (Map SearchAttributeKey SearchAttributeType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>                </span><span id="local-6989586621680179250"><span class="annot"><a href="#local-6989586621680179250"><span class="hs-identifier hs-var">decodedAttrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     StartWorkflow
     StartWorkflow
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     Any
-&gt; IO (Either String (Map SearchAttributeKey SearchAttributeType))
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant
     (IO (Either String (Map SearchAttributeKey SearchAttributeType))))
  StartWorkflow
  SearchAttributes
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;searchAttributes&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.searchAttributes</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant
     (IO (Either String (Map SearchAttributeKey SearchAttributeType))))
  StartWorkflow
  SearchAttributes
-&gt; ((IO
       (Either String (Map SearchAttributeKey SearchAttributeType))
     -&gt; Constant
          (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
          Any)
    -&gt; SearchAttributes
    -&gt; Constant
         (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
         SearchAttributes)
-&gt; FoldLike
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     StartWorkflow
     StartWorkflow
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant
     (IO (Either String (Map SearchAttributeKey SearchAttributeType))))
  SearchAttributes
  (Map Text Payload)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;indexedFields&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Message.indexedFields</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Constant
     (IO (Either String (Map SearchAttributeKey SearchAttributeType))))
  SearchAttributes
  (Map Text Payload)
-&gt; ((IO
       (Either String (Map SearchAttributeKey SearchAttributeType))
     -&gt; Constant
          (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
          Any)
    -&gt; Map Text Payload
    -&gt; Constant
         (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
         (Map Text Payload))
-&gt; (IO (Either String (Map SearchAttributeKey SearchAttributeType))
    -&gt; Constant
         (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
         Any)
-&gt; SearchAttributes
-&gt; Constant
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     SearchAttributes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Map Text Payload
 -&gt; IO (Either String (Map SearchAttributeKey SearchAttributeType)))
-&gt; Getter
     (Map Text Payload)
     (Map Text Payload)
     (IO (Either String (Map SearchAttributeKey SearchAttributeType)))
     Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Map Text Payload
-&gt; IO (Either String (Map SearchAttributeKey SearchAttributeType))
</span><a href="Temporal.SearchAttributes.Internal.html#searchAttributesFromProto"><span class="hs-identifier hs-var">searchAttributesFromProto</span></a></span><span>
</span><span id="line-202"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">throwIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#ValueError"><span class="hs-identifier hs-type">ValueError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><a href="#local-6989586621680179250"><span class="hs-identifier hs-type">decodedAttrs</span></a></span><span>
</span><span id="line-203"></span><span>              </span><span id="local-6989586621680179256"><span class="annot"><a href="#local-6989586621680179256"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-type">processorDecodePayloads</span></a></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">processor</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680179245"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.headers</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>              </span><span id="local-6989586621680179260"><span class="annot"><a href="#local-6989586621680179260"><span class="hs-identifier hs-var">memo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><a href="Temporal.Payload.html#processorDecodePayloads"><span class="hs-identifier hs-type">processorDecodePayloads</span></a></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">processor</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680179245"><span class="hs-identifier hs-type">startWorkflow</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">^.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Activation.memo</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message.fields</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">to</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">fmap</span></span><span> </span><span class="annot"><a href="Temporal.Payload.html#convertFromProtoPayload"><span class="hs-identifier hs-type">convertFromProtoPayload</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680179249"><span class="hs-identifier hs-type">searchAttrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680179256"><span class="hs-identifier hs-type">hdrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680179260"><span class="hs-identifier hs-type">memo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621680179247"><span class="hs-identifier hs-type">ePayloads</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-207"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680179263"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680179263"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179264"><span class="annot"><span class="annottext">appFailure :: ApplicationFailure
</span><a href="#local-6989586621680179264"><span class="hs-identifier hs-var hs-var hs-var">appFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; [ApplicationFailureHandler] -&gt; ApplicationFailure
</span><a href="Temporal.Exception.html#mkApplicationFailure"><span class="hs-identifier hs-var">Err.mkApplicationFailure</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680179263"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerErrorConverters</span><span>
</span><span id="line-209"></span><span>                    </span><span id="local-6989586621680179266"><span class="annot"><span class="annottext">enrichedApplicationFailure :: Failure
</span><a href="#local-6989586621680179266"><span class="hs-identifier hs-var hs-var hs-var">enrichedApplicationFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>                      </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-211"></span><span>                        </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680179264"><span class="hs-identifier hs-var">appFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">message</span><span>
</span><span id="line-212"></span><span>                        </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;source&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.source</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;hs-temporal-sdk&quot;</span></span><span>
</span><span id="line-213"></span><span>                        </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;stackTrace&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.stackTrace</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680179264"><span class="hs-identifier hs-var">appFailure</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">stack</span><span>
</span><span id="line-214"></span><span>                        </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure ApplicationFailureInfo
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f Failure ApplicationFailureInfo
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;applicationFailureInfo&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.applicationFailureInfo</span></span><span>
</span><span id="line-215"></span><span>                          </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f Failure ApplicationFailureInfo)
-&gt; ApplicationFailureInfo -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ApplicationFailureInfo
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-216"></span><span>                                </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;type'&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.type'</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Text)
-&gt; Text -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Text
</span><a href="Temporal.Exception.html#type%27"><span class="hs-identifier hs-var">Err.type'</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680179264"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-217"></span><span>                                </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Bool
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Bool
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;nonRetryable&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.nonRetryable</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Bool)
-&gt; Bool -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure -&gt; Bool
</span><a href="Temporal.Exception.html#nonRetryable"><span class="hs-identifier hs-var">Err.nonRetryable</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationFailure
</span><a href="#local-6989586621680179264"><span class="hs-identifier hs-var">appFailure</span></a></span><span>
</span><span id="line-218"></span><span>                             </span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>                    </span><span class="annot"><a href="#local-6989586621680179311"><span class="hs-identifier hs-type">failureProto</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Completion.Failure</span></span><span>
</span><span id="line-220"></span><span>                    </span><span id="local-6989586621680179311"><span class="annot"><span class="annottext">failureProto :: Failure
</span><a href="#local-6989586621680179311"><span class="hs-identifier hs-var hs-var hs-var">failureProto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span> </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Failure
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failure&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failure</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure)
-&gt; Failure -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680179266"><span class="hs-identifier hs-var">enrichedApplicationFailure</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span>                    </span><span id="local-6989586621680179319"><span class="annot"><span class="annottext">completionMessage :: WorkflowActivationCompletion
</span><a href="#local-6989586621680179319"><span class="hs-identifier hs-var hs-var hs-var">completionMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>                      </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-224"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.runId</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Text)
-&gt; Text
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failed&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failed</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Failure)
-&gt; Failure
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680179311"><span class="hs-identifier hs-var">failureProto</span></a></span><span>
</span><span id="line-226"></span><span>                </span><span class="annot"><span class="annottext">IO (Either WorkerError ())
-&gt; ReaderT WorkflowWorker m (Either WorkerError ())
forall a. IO a -&gt; ReaderT WorkflowWorker m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either WorkerError ())
 -&gt; ReaderT WorkflowWorker m (Either WorkerError ()))
-&gt; IO (Either WorkerError ())
-&gt; ReaderT WorkflowWorker m (Either WorkerError ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
forall (ty :: WorkerType).
KnownWorkerType ty =&gt;
Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
</span><span class="hs-identifier hs-var">Core.completeWorkflowActivation</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
</span><a href="#local-6989586621680179237"><span class="hs-identifier hs-var">workerCore</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680179319"><span class="hs-identifier hs-var">completionMessage</span></a></span><span>
</span><span id="line-227"></span><span>                </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-228"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680179332"><span class="annot"><span class="annottext">Map SearchAttributeKey SearchAttributeType
</span><a href="#local-6989586621680179332"><span class="hs-identifier hs-var">searchAttrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680179333"><span class="annot"><span class="annottext">Map Text Payload
</span><a href="#local-6989586621680179333"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680179334"><span class="annot"><span class="annottext">Map Text Payload
</span><a href="#local-6989586621680179334"><span class="hs-identifier hs-var">memo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179335"><span class="annot"><span class="annottext">runId_ :: RunId
</span><a href="#local-6989586621680179335"><span class="hs-identifier hs-var hs-var">runId_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Text -&gt; RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.runId</span></span><span>
</span><span id="line-230"></span><span>                    </span><span id="local-6989586621680179337"><span class="annot"><span class="annottext">parentProto :: Maybe NamespacedWorkflowExecution
</span><a href="#local-6989586621680179337"><span class="hs-identifier hs-var hs-var">parentProto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe NamespacedWorkflowExecution)
     StartWorkflow
     StartWorkflow
     (Maybe NamespacedWorkflowExecution)
     (Maybe NamespacedWorkflowExecution)
-&gt; Maybe NamespacedWorkflowExecution
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe NamespacedWorkflowExecution)
  StartWorkflow
  StartWorkflow
  (Maybe NamespacedWorkflowExecution)
  (Maybe NamespacedWorkflowExecution)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'parentWorkflowInfo&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'parentWorkflowInfo</span></span><span>
</span><span id="line-231"></span><span>                    </span><span id="local-6989586621680179339"><span class="annot"><span class="annottext">parentInfo :: Maybe ParentInfo
</span><a href="#local-6989586621680179339"><span class="hs-identifier hs-var hs-var">parentInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe NamespacedWorkflowExecution
</span><a href="#local-6989586621680179337"><span class="hs-identifier hs-var">parentProto</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-232"></span><span>                      </span><span class="annot"><span class="annottext">Maybe NamespacedWorkflowExecution
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ParentInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-233"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680179340"><span class="annot"><span class="annottext">NamespacedWorkflowExecution
</span><a href="#local-6989586621680179340"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>                        </span><span class="annot"><span class="annottext">ParentInfo -&gt; Maybe ParentInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-235"></span><span>                          </span><span class="annot"><a href="Temporal.Common.html#ParentInfo"><span class="hs-identifier hs-type">ParentInfo</span></a></span><span>
</span><span id="line-236"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">parentNamespace :: Namespace
</span><a href="#local-6989586621680179342"><span class="hs-identifier hs-var">parentNamespace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Namespace
</span><a href="Temporal.Common.html#Namespace"><span class="hs-identifier hs-var">Namespace</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Namespace) -&gt; Text -&gt; Namespace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
</span><a href="#local-6989586621680179340"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
-&gt; FoldLike
     Text
     NamespacedWorkflowExecution
     NamespacedWorkflowExecution
     Text
     Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Text
  NamespacedWorkflowExecution
  NamespacedWorkflowExecution
  Text
  Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;namespace&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.namespace</span></span><span>
</span><span id="line-237"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">parentRunId :: RunId
</span><a href="#local-6989586621680179345"><span class="hs-identifier hs-var">parentRunId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Text -&gt; RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
</span><a href="#local-6989586621680179340"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
-&gt; FoldLike
     Text
     NamespacedWorkflowExecution
     NamespacedWorkflowExecution
     Text
     Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Text
  NamespacedWorkflowExecution
  NamespacedWorkflowExecution
  Text
  Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.runId</span></span><span>
</span><span id="line-238"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">parentWorkflowId :: WorkflowId
</span><a href="#local-6989586621680179346"><span class="hs-identifier hs-var">parentWorkflowId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; WorkflowId
</span><a href="Temporal.Common.html#WorkflowId"><span class="hs-identifier hs-var">WorkflowId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; WorkflowId) -&gt; Text -&gt; WorkflowId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
</span><a href="#local-6989586621680179340"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">NamespacedWorkflowExecution
-&gt; FoldLike
     Text
     NamespacedWorkflowExecution
     NamespacedWorkflowExecution
     Text
     Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Text
  NamespacedWorkflowExecution
  NamespacedWorkflowExecution
  Text
  Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.workflowId</span></span><span>
</span><span id="line-239"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-240"></span><span>                    </span><span id="local-6989586621680179349"><span class="annot"><span class="annottext">workflowInfo :: Info
</span><a href="#local-6989586621680179349"><span class="hs-identifier hs-var hs-var">workflowInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-241"></span><span>                      </span><span class="annot"><a href="Temporal.Workflow.Types.html#Info"><span class="hs-identifier hs-type">Temporal.WorkflowInstance.Info</span></a></span><span>
</span><span id="line-242"></span><span>                        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">historyLength :: Word32
</span><a href="#local-6989586621680179351"><span class="hs-identifier hs-var">historyLength</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     Word32 WorkflowActivation WorkflowActivation Word32 Word32
-&gt; Word32
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Word32 WorkflowActivation WorkflowActivation Word32 Word32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;historyLength&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.historyLength</span></span><span>
</span><span id="line-243"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">attempt :: Int
</span><a href="#local-6989586621680179353"><span class="hs-identifier hs-var">attempt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int32 -&gt; Int) -&gt; Int32 -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike Int32 StartWorkflow StartWorkflow Int32 Int32 -&gt; Int32
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Int32 StartWorkflow StartWorkflow Int32 Int32
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;attempt&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.attempt</span></span><span>
</span><span id="line-244"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">taskQueue :: TaskQueue
</span><a href="#local-6989586621680179355"><span class="hs-identifier hs-var">taskQueue</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerTaskQueue</span><span>
</span><span id="line-245"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">workflowId :: WorkflowId
</span><a href="#local-6989586621680179356"><span class="hs-identifier hs-var">workflowId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; WorkflowId
</span><a href="Temporal.Common.html#WorkflowId"><span class="hs-identifier hs-var">WorkflowId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; WorkflowId) -&gt; Text -&gt; WorkflowId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike Text StartWorkflow StartWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text StartWorkflow StartWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowId</span></span><span>
</span><span id="line-246"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">workflowType :: WorkflowType
</span><a href="#local-6989586621680179358"><span class="hs-identifier hs-var">workflowType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     WorkflowType StartWorkflow StartWorkflow WorkflowType Any
-&gt; WorkflowType
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant WorkflowType) StartWorkflow Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowType&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowType</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant WorkflowType) StartWorkflow Text
-&gt; ((WorkflowType -&gt; Constant WorkflowType Any)
    -&gt; Text -&gt; Constant WorkflowType Text)
-&gt; FoldLike
     WorkflowType StartWorkflow StartWorkflow WorkflowType Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; WorkflowType) -&gt; Getter Text Text WorkflowType Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; WorkflowType
</span><a href="Temporal.Common.html#WorkflowType"><span class="hs-identifier hs-var">WorkflowType</span></a></span><span>
</span><span id="line-247"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">continuedRunId :: Maybe RunId
</span><a href="#local-6989586621680179360"><span class="hs-identifier hs-var">continuedRunId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Maybe Text -&gt; Maybe RunId
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Text -&gt; Maybe RunId) -&gt; Maybe Text -&gt; Maybe RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe Text) StartWorkflow StartWorkflow (Maybe Text) Any
-&gt; Maybe Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant (Maybe Text)) StartWorkflow Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;continuedFromExecutionRunId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.continuedFromExecutionRunId</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant (Maybe Text)) StartWorkflow Text
-&gt; ((Maybe Text -&gt; Constant (Maybe Text) Any)
    -&gt; Text -&gt; Constant (Maybe Text) Text)
-&gt; FoldLike
     (Maybe Text) StartWorkflow StartWorkflow (Maybe Text) Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Maybe Text) -&gt; Getter Text Text (Maybe Text) Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
</span><a href="Temporal.Common.html#nonEmptyString"><span class="hs-identifier hs-var">nonEmptyString</span></a></span><span>
</span><span id="line-248"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cronSchedule :: Maybe Text
</span><a href="#local-6989586621680179363"><span class="hs-identifier hs-var">cronSchedule</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe Text) StartWorkflow StartWorkflow (Maybe Text) Any
-&gt; Maybe Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant (Maybe Text)) StartWorkflow Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;cronSchedule&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.cronSchedule</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant (Maybe Text)) StartWorkflow Text
-&gt; ((Maybe Text -&gt; Constant (Maybe Text) Any)
    -&gt; Text -&gt; Constant (Maybe Text) Text)
-&gt; FoldLike
     (Maybe Text) StartWorkflow StartWorkflow (Maybe Text) Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Maybe Text) -&gt; Getter Text Text (Maybe Text) Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
</span><a href="Temporal.Common.html#nonEmptyString"><span class="hs-identifier hs-var">nonEmptyString</span></a></span><span>
</span><span id="line-249"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">taskTimeout :: Duration
</span><a href="#local-6989586621680179365"><span class="hs-identifier hs-var">taskTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike Duration StartWorkflow StartWorkflow Duration Any
-&gt; Duration
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Duration) StartWorkflow Duration
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowTaskTimeout&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowTaskTimeout</span></span><span> </span><span class="annot"><span class="annottext">LensLike' (Constant Duration) StartWorkflow Duration
-&gt; ((Duration -&gt; Constant Duration Any)
    -&gt; Duration -&gt; Constant Duration Duration)
-&gt; FoldLike Duration StartWorkflow StartWorkflow Duration Any
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Duration -&gt; Duration) -&gt; Getter Duration Duration Duration Any
forall s a t b. (s -&gt; a) -&gt; Getter s t a b
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Duration -&gt; Duration
</span><a href="Temporal.Duration.html#durationFromProto"><span class="hs-identifier hs-var">durationFromProto</span></a></span><span>
</span><span id="line-250"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">executionTimeout :: Maybe Duration
</span><a href="#local-6989586621680179367"><span class="hs-identifier hs-var">executionTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Duration -&gt; Duration) -&gt; Maybe Duration -&gt; Maybe Duration
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Duration -&gt; Duration
</span><a href="Temporal.Duration.html#durationFromProto"><span class="hs-identifier hs-var">durationFromProto</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Duration -&gt; Maybe Duration)
-&gt; Maybe Duration -&gt; Maybe Duration
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe Duration)
     StartWorkflow
     StartWorkflow
     (Maybe Duration)
     (Maybe Duration)
-&gt; Maybe Duration
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe Duration)
  StartWorkflow
  StartWorkflow
  (Maybe Duration)
  (Maybe Duration)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'workflowExecutionTimeout&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'workflowExecutionTimeout</span></span><span>
</span><span id="line-251"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">namespace :: Namespace
</span><a href="#local-6989586621680179369"><span class="hs-identifier hs-var">namespace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Namespace
</span><a href="Temporal.Common.html#Namespace"><span class="hs-identifier hs-var">Namespace</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Namespace) -&gt; Text -&gt; Namespace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkerConfig -&gt; Text
</span><span class="hs-identifier hs-var">Core.namespace</span></span><span> </span><span class="annot"><span class="annottext">(WorkerConfig -&gt; Text) -&gt; WorkerConfig -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Worker ty -&gt; WorkerConfig
forall (ty :: WorkerType). Worker ty -&gt; WorkerConfig
</span><span class="hs-identifier hs-var">Core.getWorkerConfig</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
</span><a href="#local-6989586621680179237"><span class="hs-identifier hs-var">workerCore</span></a></span><span>
</span><span id="line-252"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">parent :: Maybe ParentInfo
</span><a href="#local-6989586621680179370"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ParentInfo
</span><a href="#local-6989586621680179339"><span class="hs-identifier hs-var">parentInfo</span></a></span><span>
</span><span id="line-253"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">headers :: Map Text Payload
</span><a href="#local-6989586621680179371"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Text Payload
</span><a href="#local-6989586621680179333"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-254"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">rawMemo :: Map Text Payload
</span><a href="#local-6989586621680179372"><span class="hs-identifier hs-var">rawMemo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Text Payload
</span><a href="#local-6989586621680179334"><span class="hs-identifier hs-var">memo</span></a></span><span>
</span><span id="line-255"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">searchAttributes :: Map SearchAttributeKey SearchAttributeType
</span><a href="#local-6989586621680179373"><span class="hs-identifier hs-var">searchAttributes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map SearchAttributeKey SearchAttributeType
</span><a href="#local-6989586621680179332"><span class="hs-identifier hs-var">searchAttrs</span></a></span><span>
</span><span id="line-256"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">retryPolicy :: Maybe RetryPolicy
</span><a href="#local-6989586621680179374"><span class="hs-identifier hs-var">retryPolicy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetryPolicy -&gt; RetryPolicy
</span><a href="Temporal.Common.html#retryPolicyFromProto"><span class="hs-identifier hs-var">retryPolicyFromProto</span></a></span><span> </span><span class="annot"><span class="annottext">(RetryPolicy -&gt; RetryPolicy)
-&gt; Maybe RetryPolicy -&gt; Maybe RetryPolicy
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe RetryPolicy)
     StartWorkflow
     StartWorkflow
     (Maybe RetryPolicy)
     (Maybe RetryPolicy)
-&gt; Maybe RetryPolicy
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe RetryPolicy)
  StartWorkflow
  StartWorkflow
  (Maybe RetryPolicy)
  (Maybe RetryPolicy)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'retryPolicy&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'retryPolicy</span></span><span>
</span><span id="line-257"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">runId :: RunId
</span><a href="#local-6989586621680179378"><span class="hs-identifier hs-var">runId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Text -&gt; RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.runId</span></span><span>
</span><span id="line-258"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">runTimeout :: Maybe Duration
</span><a href="#local-6989586621680179379"><span class="hs-identifier hs-var">runTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Duration -&gt; Duration) -&gt; Maybe Duration -&gt; Maybe Duration
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Duration -&gt; Duration
</span><a href="Temporal.Duration.html#durationFromProto"><span class="hs-identifier hs-var">durationFromProto</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Duration -&gt; Maybe Duration)
-&gt; Maybe Duration -&gt; Maybe Duration
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe Duration)
     StartWorkflow
     StartWorkflow
     (Maybe Duration)
     (Maybe Duration)
-&gt; Maybe Duration
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe Duration)
  StartWorkflow
  StartWorkflow
  (Maybe Duration)
  (Maybe Duration)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'workflowRunTimeout&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'workflowRunTimeout</span></span><span>
</span><span id="line-259"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">startTime :: SystemTime
</span><a href="#local-6989586621680179381"><span class="hs-identifier hs-var">startTime</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>                            </span><span class="annot"><span class="annottext">Timestamp -&gt; SystemTime
</span><a href="Temporal.Common.html#timespecFromTimestamp"><span class="hs-identifier hs-var">timespecFromTimestamp</span></a></span><span> </span><span class="annot"><span class="annottext">(Timestamp -&gt; SystemTime) -&gt; Timestamp -&gt; SystemTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-261"></span><span>                              </span><span class="annot"><span class="annottext">Timestamp -&gt; Maybe Timestamp -&gt; Timestamp
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span>
</span><span id="line-262"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     Timestamp WorkflowActivation WorkflowActivation Timestamp Timestamp
-&gt; Timestamp
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  Timestamp WorkflowActivation WorkflowActivation Timestamp Timestamp
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;timestamp&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.timestamp</span></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike
     (Maybe Timestamp)
     StartWorkflow
     StartWorkflow
     (Maybe Timestamp)
     (Maybe Timestamp)
-&gt; Maybe Timestamp
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe Timestamp)
  StartWorkflow
  StartWorkflow
  (Maybe Timestamp)
  (Maybe Timestamp)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'startTime&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'startTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">continueAsNewSuggested :: Bool
</span><a href="#local-6989586621680179386"><span class="hs-identifier hs-var">continueAsNewSuggested</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-265"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-266"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; HashMap Text WorkflowDefinition -&gt; Maybe WorkflowDefinition
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HashMap.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span> </span><span class="annot"><span class="annottext">StartWorkflow
-&gt; FoldLike Text StartWorkflow StartWorkflow Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text StartWorkflow StartWorkflow Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;workflowType&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.workflowType</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerWorkflowFunctions</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-267"></span><span>                  </span><span class="annot"><span class="annottext">Maybe WorkflowDefinition
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>                    </span><span class="annot"><span class="annottext">Span -&gt; SpanStatus -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *). MonadIO m =&gt; Span -&gt; SpanStatus -&gt; m ()
</span><span class="hs-identifier hs-var">setStatus</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179038"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SpanStatus
</span><span class="hs-identifier hs-var">Error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;No workflow definition found&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>                    </span><span class="hs-special">$</span><span class="annot"><span class="annottext">Int
String
LogLevel
String -&gt; Text
String -&gt; String -&gt; String -&gt; CharPos -&gt; CharPos -&gt; Loc
Text -&gt; Text
Loc -&gt; Text -&gt; LogLevel -&gt; Text -&gt; ReaderT WorkflowWorker m ()
(Text -&gt; ReaderT WorkflowWorker m ())
-&gt; (Text -&gt; Text) -&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall a. a -&gt; a
forall msg.
ToLogStr msg =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; ReaderT WorkflowWorker m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
id :: forall a. a -&gt; a
. :: forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
monadLoggerLog :: forall (m :: * -&gt; *) msg.
(MonadLogger m, ToLogStr msg) =&gt;
Loc -&gt; Text -&gt; LogLevel -&gt; msg -&gt; m ()
pack :: String -&gt; Text
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">logInfo</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;No workflow definition found&quot;</span></span><span>
</span><span id="line-270"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179396"><span class="annot"><span class="annottext">failureProto :: Failure
</span><a href="#local-6989586621680179396"><span class="hs-identifier hs-var hs-var hs-var">failureProto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-271"></span><span>                          </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-272"></span><span>                            </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Failure
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failure&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failure</span></span><span>
</span><span id="line-273"></span><span>                              </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Failure)
-&gt; Failure -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Failure
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-274"></span><span>                                    </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure Text
forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.message</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}. Identical f =&gt; LensLike' f Failure Text)
-&gt; Text -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;No workflow definition found&quot;</span></span><span>
</span><span id="line-275"></span><span>                                    </span><span class="annot"><span class="annottext">Failure -&gt; (Failure -&gt; Failure) -&gt; Failure
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f Failure ApplicationFailureInfo
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f Failure ApplicationFailureInfo
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;applicationFailureInfo&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.applicationFailureInfo</span></span><span>
</span><span id="line-276"></span><span>                                      </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f Failure ApplicationFailureInfo)
-&gt; ApplicationFailureInfo -&gt; Failure -&gt; Failure
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ApplicationFailureInfo
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-277"></span><span>                                            </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;type'&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.type'</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Text)
-&gt; Text -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;NotFound&quot;</span></span><span>
</span><span id="line-278"></span><span>                                            </span><span class="annot"><span class="annottext">ApplicationFailureInfo
-&gt; (ApplicationFailureInfo -&gt; ApplicationFailureInfo)
-&gt; ApplicationFailureInfo
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f ApplicationFailureInfo Bool
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f ApplicationFailureInfo Bool
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;nonRetryable&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">F.nonRetryable</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f ApplicationFailureInfo Bool)
-&gt; Bool -&gt; ApplicationFailureInfo -&gt; ApplicationFailureInfo
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-279"></span><span>                                         </span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>                                 </span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>                        </span><span id="local-6989586621680179422"><span class="annot"><span class="annottext">completionMessage :: WorkflowActivationCompletion
</span><a href="#local-6989586621680179422"><span class="hs-identifier hs-var hs-var hs-var">completionMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-282"></span><span>                          </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
forall msg. Message msg =&gt; msg
</span><span class="hs-identifier hs-var">defMessage</span></span><span>
</span><span id="line-283"></span><span>                            </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Text
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.runId</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Text)
-&gt; Text
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.runId</span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>                            </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
-&gt; (WorkflowActivationCompletion -&gt; WorkflowActivationCompletion)
-&gt; WorkflowActivationCompletion
forall s t. s -&gt; (s -&gt; t) -&gt; t
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' f WorkflowActivationCompletion Failure
forall {f :: * -&gt; *}.
Identical f =&gt;
LensLike' f WorkflowActivationCompletion Failure
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;failed&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Completion.failed</span></span><span> </span><span class="annot"><span class="annottext">(forall {f :: * -&gt; *}.
 Identical f =&gt;
 LensLike' f WorkflowActivationCompletion Failure)
-&gt; Failure
-&gt; WorkflowActivationCompletion
-&gt; WorkflowActivationCompletion
forall s t a b. Setter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="#local-6989586621680179396"><span class="hs-identifier hs-var">failureProto</span></a></span><span>
</span><span id="line-285"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; ReaderT WorkflowWorker m ()
forall a. IO a -&gt; ReaderT WorkflowWorker m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
forall (ty :: WorkerType).
KnownWorkerType ty =&gt;
Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
</span><span class="hs-identifier hs-var">Core.completeWorkflowActivation</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
</span><a href="#local-6989586621680179237"><span class="hs-identifier hs-var">workerCore</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680179422"><span class="hs-identifier hs-var">completionMessage</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either WorkerError ())
-&gt; (Either WorkerError () -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(WorkerError -&gt; IO ())
-&gt; (() -&gt; IO ()) -&gt; Either WorkerError () -&gt; IO ()
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">WorkerError -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>                    </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
-&gt; ReaderT WorkflowWorker m (Maybe WorkflowInstance)
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-287"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Temporal.Workflow.Definition.html#WorkflowDefinition"><span class="hs-identifier hs-type">WorkflowDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680179434"><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680179434"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>                    </span><span id="local-6989586621680179435"><span class="annot"><a href="#local-6989586621680179435"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-289"></span><span>                      </span><span class="annot"><span class="annottext">(WorkflowActivationCompletion -&gt; IO (Either WorkerError ()))
-&gt; (Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; Maybe Int
-&gt; [ApplicationFailureHandler]
-&gt; WorkflowInboundInterceptor
-&gt; WorkflowOutboundInterceptor
-&gt; PayloadProcessor
-&gt; Info
-&gt; StartWorkflow
-&gt; ReaderT WorkflowWorker m WorkflowInstance
forall (m :: * -&gt; *).
(HasCallStack, MonadLoggerIO m) =&gt;
(WorkflowActivationCompletion -&gt; IO (Either WorkerError ()))
-&gt; (Vector Payload -&gt; IO (Either String (Workflow Payload)))
-&gt; Maybe Int
-&gt; [ApplicationFailureHandler]
-&gt; WorkflowInboundInterceptor
-&gt; WorkflowOutboundInterceptor
-&gt; PayloadProcessor
-&gt; Info
-&gt; StartWorkflow
-&gt; m WorkflowInstance
</span><a href="Temporal.WorkflowInstance.html#create"><span class="hs-identifier hs-var">create</span></a></span><span>
</span><span id="line-290"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680179437"><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680179437"><span class="hs-identifier hs-var">wf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>                            </span><span class="annot"><span class="annottext">Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
forall (ty :: WorkerType).
KnownWorkerType ty =&gt;
Worker ty
-&gt; WorkflowActivationCompletion -&gt; IO (Either WorkerError ())
</span><span class="hs-identifier hs-var">Core.completeWorkflowActivation</span></span><span> </span><span class="annot"><span class="annottext">Worker ty
</span><a href="#local-6989586621680179237"><span class="hs-identifier hs-var">workerCore</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationCompletion
</span><a href="#local-6989586621680179437"><span class="hs-identifier hs-var">wf</span></a></span><span>
</span><span id="line-292"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>                        </span><span class="annot"><span class="annottext">Vector Payload -&gt; IO (Either String (Workflow Payload))
</span><a href="#local-6989586621680179434"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-294"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerDeadlockTimeout</span><span>
</span><span id="line-295"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerErrorConverters</span><span>
</span><span id="line-296"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerInboundInterceptors</span><span>
</span><span id="line-297"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">workerOutboundInterceptors</span><span>
</span><span id="line-298"></span><span>                        </span><span class="annot"><span class="annottext">WorkflowWorker
</span><a href="#local-6989586621680179039"><span class="hs-identifier hs-var">worker</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">processor</span><span>
</span><span id="line-299"></span><span>                        </span><span class="annot"><span class="annottext">Info
</span><a href="#local-6989586621680179349"><span class="hs-identifier hs-var">workflowInfo</span></a></span><span>
</span><span id="line-300"></span><span>                        </span><span class="annot"><span class="annottext">StartWorkflow
</span><a href="#local-6989586621680179245"><span class="hs-identifier hs-var">startWorkflow</span></a></span><span>
</span><span id="line-301"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">liftIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Temporal.WorkflowInstance.html#addStackTraceHandler"><span class="hs-identifier hs-type">addStackTraceHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179435"><span class="hs-identifier hs-type">inst</span></a></span><span>
</span><span id="line-302"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#upsertWorkflowInstance"><span class="hs-identifier hs-type">upsertWorkflowInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179335"><span class="hs-identifier hs-type">runId_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179435"><span class="hs-identifier hs-type">inst</span></a></span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680179242"><span class="hs-identifier hs-type">vExistingInstance</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">V.!?</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><a href="#local-6989586621680179019"><span class="hs-identifier hs-type">removeEvictedWorkflowInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#WorkflowWorker"><span class="hs-identifier hs-type">WorkflowWorker</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680178296"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621680179019"><span class="annot"><span class="annottext">removeEvictedWorkflowInstances :: ReaderT WorkflowWorker m ()
</span><a href="#local-6989586621680179019"><span class="hs-identifier hs-var hs-var">removeEvictedWorkflowInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Vector WorkflowActivationJob
-&gt; (WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike
     (Vector WorkflowActivationJob)
     WorkflowActivation
     WorkflowActivation
     (Vector WorkflowActivationJob)
     (Vector WorkflowActivationJob)
-&gt; Vector WorkflowActivationJob
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Vector WorkflowActivationJob)
  WorkflowActivation
  WorkflowActivation
  (Vector WorkflowActivationJob)
  (Vector WorkflowActivationJob)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;vec'jobs&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.vec'jobs</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
 -&gt; ReaderT WorkflowWorker m ())
-&gt; (WorkflowActivationJob -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680179440"><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179440"><span class="hs-identifier hs-var">job</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
</span><a href="#local-6989586621680179440"><span class="hs-identifier hs-var">job</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivationJob
-&gt; FoldLike
     (Maybe WorkflowActivationJob'Variant)
     WorkflowActivationJob
     WorkflowActivationJob
     (Maybe WorkflowActivationJob'Variant)
     (Maybe WorkflowActivationJob'Variant)
-&gt; Maybe WorkflowActivationJob'Variant
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike
  (Maybe WorkflowActivationJob'Variant)
  WorkflowActivationJob
  WorkflowActivationJob
  (Maybe WorkflowActivationJob'Variant)
  (Maybe WorkflowActivationJob'Variant)
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;maybe'variant&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.maybe'variant</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WorkflowActivationJob'RemoveFromCache</span></span><span> </span><span id="local-6989586621680179442"><span class="annot"><span class="annottext">RemoveFromCache
</span><a href="#local-6989586621680179442"><span class="hs-identifier hs-var">removeFromCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179443"><span class="annot"><span class="annottext">spanAttrs :: HashMap Text Attribute
</span><a href="#local-6989586621680179443"><span class="hs-identifier hs-var hs-var">spanAttrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-310"></span><span>                </span><span class="annot"><span class="annottext">[(Text, Attribute)] -&gt; HashMap Text Attribute
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HashMap.fromList</span></span><span>
</span><span id="line-311"></span><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;temporal.workflow.worker.instance_state&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Attribute
forall a. ToAttribute a =&gt; a -&gt; Attribute
</span><span class="hs-identifier hs-var">toAttribute</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;evicted&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;temporal.activation.run_id&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Attribute
forall a. ToAttribute a =&gt; a -&gt; Attribute
</span><span class="hs-identifier hs-var">toAttribute</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Attribute) -&gt; Text -&gt; Attribute
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.runId</span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>          </span><span class="annot"><span class="annottext">Text
-&gt; SpanArguments
-&gt; (Span -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a.
(MonadUnliftIO m, MonadTracer m, HasCallStack) =&gt;
Text -&gt; SpanArguments -&gt; (Span -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">inSpan'</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;removeEvictedWorkflowInstance&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SpanArguments
</span><span class="hs-identifier hs-var">defaultSpanArguments</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">attributes</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680179443"><span class="hs-identifier hs-type">spanAttrs</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Span -&gt; ReaderT WorkflowWorker m ())
 -&gt; ReaderT WorkflowWorker m ())
-&gt; (Span -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680179444"><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179444"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>            </span><span id="local-6989586621680179445"><span class="annot"><a href="#local-6989586621680179445"><span class="hs-identifier hs-var">worker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m WorkflowWorker
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-316"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179446"><span class="annot"><a href="#local-6989586621680179446"><span class="hs-identifier hs-var hs-var">runId_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; RunId
</span><a href="Temporal.Common.html#RunId"><span class="hs-identifier hs-var">RunId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; RunId) -&gt; Text -&gt; RunId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
</span><a href="#local-6989586621680178938"><span class="hs-identifier hs-var">activation</span></a></span><span> </span><span class="annot"><span class="annottext">WorkflowActivation
-&gt; FoldLike Text WorkflowActivation WorkflowActivation Text Text
-&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text WorkflowActivation WorkflowActivation Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;runId&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">CommonProto.runId</span></span><span>
</span><span id="line-317"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">join</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>              </span><span id="local-6989586621680179447"><span class="annot"><a href="#local-6989586621680179447"><span class="hs-identifier hs-var">currentWorkflows</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">readTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span>
</span><span id="line-319"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">writeTVar</span></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">runningWorkflows</span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.delete</span></span><span> </span><span class="annot"><a href="#local-6989586621680179446"><span class="hs-identifier hs-type">runId_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179447"><span class="hs-identifier hs-type">currentWorkflows</span></a></span><span>
</span><span id="line-320"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">writeTChan</span></span><span> </span><span class="annot"><span class="hs-identifier">worker</span></span><span class="hs-operator">.</span><span class="hs-identifier">workerEvictionEmitter</span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#EvictionWithRunID"><span class="hs-identifier hs-type">EvictionWithRunID</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Temporal.Workflow.Worker.html#runId"><span class="hs-identifier hs-var">runId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680179446"><span class="hs-identifier hs-type">runId_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Temporal.Workflow.Worker.html#eviction"><span class="hs-identifier hs-var">eviction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680179442"><span class="hs-identifier hs-type">removeFromCache</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-321"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashMap.lookup</span></span><span> </span><span class="annot"><a href="#local-6989586621680179446"><span class="hs-identifier hs-type">runId_</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680179447"><span class="hs-identifier hs-type">currentWorkflows</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-322"></span><span>                </span><span class="annot"><span class="annottext">Maybe WorkflowInstance
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680179450"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621680179450"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Eviction request on an unknown workflow with run ID &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">RunId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">RunId
</span><a href="#local-6989586621680179446"><span class="hs-identifier hs-var">runId_</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, message: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoveFromCache
</span><a href="#local-6989586621680179442"><span class="hs-identifier hs-var">removeFromCache</span></a></span><span> </span><span class="annot"><span class="annottext">RemoveFromCache
-&gt; FoldLike Text RemoveFromCache RemoveFromCache Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text RemoveFromCache RemoveFromCache Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.message</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>                  </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ())
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ()))
-&gt; ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>                    </span><span class="annot"><span class="annottext">Span -&gt; SpanStatus -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *). MonadIO m =&gt; Span -&gt; SpanStatus -&gt; m ()
</span><span class="hs-identifier hs-var">setStatus</span></span><span> </span><span class="annot"><span class="annottext">Span
</span><a href="#local-6989586621680179444"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(SpanStatus -&gt; ReaderT WorkflowWorker m ())
-&gt; SpanStatus -&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SpanStatus
</span><span class="hs-identifier hs-var">Error</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680179450"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-326"></span><span>                    </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680179450"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-327"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680179452"><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680179452"><span class="hs-identifier hs-var">wf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>                  </span><span class="annot"><span class="annottext">ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ())
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ()))
-&gt; ReaderT WorkflowWorker m () -&gt; STM (ReaderT WorkflowWorker m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-329"></span><span>                    </span><span class="annot"><span class="annottext">Async () -&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Async a -&gt; m ()
</span><span class="hs-identifier hs-var">cancel</span></span><span> </span><span class="annot"><span class="annottext">(Async () -&gt; ReaderT WorkflowWorker m ())
-&gt; ReaderT WorkflowWorker m (Async ())
-&gt; ReaderT WorkflowWorker m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IORef (Async ()) -&gt; ReaderT WorkflowWorker m (Async ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; IORef a -&gt; m a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">WorkflowInstance
</span><a href="#local-6989586621680179452"><span class="hs-identifier hs-var">wf</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">executionThread</span><span>
</span><span id="line-330"></span><span>                    </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">logDebug</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ReaderT WorkflowWorker m ())
-&gt; Text -&gt; ReaderT WorkflowWorker m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Evicting workflow instance with run ID &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">RunId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">RunId
</span><a href="#local-6989586621680179446"><span class="hs-identifier hs-var">runId_</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, message: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoveFromCache
</span><a href="#local-6989586621680179442"><span class="hs-identifier hs-var">removeFromCache</span></a></span><span> </span><span class="annot"><span class="annottext">RemoveFromCache
-&gt; FoldLike Text RemoveFromCache RemoveFromCache Text Text -&gt; Text
forall s a t b. s -&gt; FoldLike a s t a b -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">FoldLike Text RemoveFromCache RemoveFromCache Text Text
forall (f :: * -&gt; *) s a.
(Functor f, HasField s &quot;message&quot; a) =&gt;
LensLike' f s a
</span><span class="hs-identifier hs-var">Activation.message</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>        </span><span class="annot"><span class="annottext">Maybe WorkflowActivationJob'Variant
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ReaderT WorkflowWorker m ()
forall a. a -&gt; ReaderT WorkflowWorker m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span></pre></body></html>